<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ììœ¨í™œë™ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <style>
      /* --- [ìŠ¤í¬ë¡¤ ì´íƒˆ ì™„ë²½ ë°©ì§€ ë° ë ˆì´ì•„ì›ƒ] --- */
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", -apple-system, sans-serif;
        background: #f5f6f8;
        color: #333;
        overflow: hidden;
      }
      .topbar {
        height: 48px;
        background: #f5c6cf;
        display: flex;
        align-items: center;
        padding: 0 16px;
        font-weight: 700;
        border-bottom: 1px solid #e5adba;
        color: #333;
        flex-shrink: 0;
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        height: calc(100vh - 48px);
      }
      .left,
      .right {
        padding: 25px;
        display: flex;
        flex-direction: column;
        background: #fff;
        overflow-y: auto;
        min-height: 0;
      }
      .left {
        border-right: 1px solid #e5e7eb;
        gap: 15px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
        flex-shrink: 0;
      }
      .section-title {
        font-size: 16px;
        font-weight: 700;
        color: #1f2937;
      }

      .input,
      .select {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: 0.2s;
      }
      .textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        resize: none;
        line-height: 1.6;
      }

      .btn {
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid #d1d5db;
        background: #fff;
        transition: 0.2s;
        flex-shrink: 0;
      }
      .btn.primary {
        background: #1f4ddc;
        color: #fff;
        border-color: #163aa5;
      }
      .btn.success {
        background: #10b981;
        color: #fff;
        border-color: #059669;
      }
      .btn.danger {
        background: #fff;
        color: #e11d48;
        border-color: #ffcccc;
      }
      .btn.warning {
        background: #f59e0b;
        color: #fff;
        border-color: #d97706;
      }
      .btn.sm {
        padding: 6px 12px;
        font-size: 12px;
      }

      /* ìµœì¢… ê¸°ì¬ í”„ë¦¬ë·° */
      .preview-box {
        flex: 6;
        min-height: 150px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 25px;
        font-size: 15px;
        line-height: 1.8;
        outline: none;
        background: #fff;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-all;
        scroll-behavior: smooth;
      }
      .sentence-block {
        cursor: text;
        transition: background 0.4s ease-out;
        border-radius: 4px;
        padding: 2px 0;
      }
      .sentence-block:hover {
        background-color: #eff6ff;
      }
      .highlight-active {
        background-color: #fef08a !important;
      }

      .counter {
        text-align: right;
        margin-top: 10px;
        font-size: 13px;
        color: #6b7280;
        flex-shrink: 0;
      }

      /* ì •ë³´ í™•ì¸ ë ˆì´ì–´ */
      .info-layer {
        flex: 4;
        min-height: 150px;
        border: 1px solid #e5e7eb;
        background: #fafafa;
        border-radius: 12px;
        padding: 15px;
        overflow-y: auto;
        margin-top: 15px;
      }
      .info-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        font-size: 13px;
        border-left: 4px solid #1f4ddc;
        transition: 0.2s;
        position: relative;
        cursor: pointer;
      }
      .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }
      .info-card.duplicate {
        border-left-color: #f59e0b;
        background: #fffbeb;
      }
      .info-card.deleted {
        border-left-color: #ef4444;
        opacity: 0.5;
        background: #fff5f5;
        pointer-events: none;
      }
      .info-card.modified {
        border-left-color: #10b981;
      }

      .info-header {
        font-weight: 700;
        color: #333;
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }
      .tag {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
        background: #f3f4f6;
        color: #555;
        border: 1px solid #e5e7eb;
        margin-right: 4px;
        display: inline-block;
        margin-top: 4px;
      }
      .dup-badge {
        background: #f59e0b;
        color: #fff;
        font-size: 10px;
        padding: 3px 8px;
        border-radius: 12px;
        font-weight: 700;
      }
      .status-badge {
        font-size: 10px;
        padding: 3px 6px;
        border-radius: 4px;
        color: #fff;
        background: #10b981;
      }
      .delete-sentence-btn {
        background: #fee2e2;
        color: #ef4444;
        border: 1px solid #fca5a5;
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 11px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
      }
      .delete-sentence-btn:hover {
        background: #ef4444;
        color: #fff;
      }

      /* ëª¨ë‹¬ ë° íƒ­ ë””ìì¸ */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
      }
      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 1100px;
        height: 90vh;
        background: #fff;
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .modal-header {
        padding: 20px 30px;
        background: #f9fafb;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }
      .modal-body {
        display: grid;
        grid-template-columns: 240px 1fr;
        flex: 1;
        overflow: hidden;
        min-height: 0;
      }

      .student-list {
        background: #f8fafc;
        border-right: 1px solid #e5e7eb;
        padding: 15px 0;
        overflow-y: auto;
      }
      .student-item {
        padding: 16px 30px;
        background: #eff6ff;
        color: #1f4ddc;
        font-weight: 700;
        border-right: 4px solid #1f4ddc;
        font-size: 15px;
      }
      .log-entry {
        padding: 30px;
        overflow-y: auto;
        background: #fff;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .tab-menu {
        display: flex;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 20px;
        flex-shrink: 0;
      }
      .tab-btn {
        flex: 1;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        font-weight: 700;
        color: #6b7280;
        font-size: 14px;
        border-bottom: 3px solid transparent;
        transition: 0.2s;
      }
      .tab-btn:hover {
        color: #1f4ddc;
      }
      .tab-btn.active {
        color: #1f4ddc;
        border-bottom-color: #1f4ddc;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      .form-box {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        flex-shrink: 0;
      }
      .form-row {
        display: flex;
        margin-bottom: 15px;
        align-items: flex-start;
        gap: 15px;
      }
      .form-label {
        width: 100px;
        font-weight: 600;
        color: #4b5563;
        font-size: 13px;
        padding-top: 10px;
        flex-shrink: 0;
      }
      .form-input-group {
        flex: 1;
      }

      .keyword-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 10px;
      }
      .kw-btn {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        background: #f8fafc;
        border: 1px solid #d1d5db;
        cursor: pointer;
        transition: 0.2s;
        color: #333;
      }
      .kw-btn:hover {
        border-color: #1f4ddc;
        color: #1f4ddc;
        background: #eff6ff;
      }
      .kw-btn.active {
        background: #1f4ddc;
        color: #fff;
        border-color: #1f4ddc;
      }
      .kw-btn.custom-kw {
        border-color: #f59e0b;
        color: #f59e0b;
      }
      .kw-btn.custom-kw.active {
        background: #f59e0b;
        color: #fff;
        border-color: #f59e0b;
      }

      .history-item {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        align-items: flex-start;
        gap: 15px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
        transition: 0.2s;
      }
      .history-chk {
        margin-top: 4px;
        transform: scale(1.3);
        cursor: pointer;
        accent-color: #1f4ddc;
      }

      .error-tag {
        color: #ef4444;
        font-size: 11px;
        font-weight: bold;
        background: #fee2e2;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 6px;
        display: inline-block;
        border: 1px solid #fca5a5;
      }

      #toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 10px 25px;
        border-radius: 30px;
        font-size: 13px;
        opacity: 0;
        transition: 0.3s;
        pointer-events: none;
        z-index: 3000;
      }
    </style>
  </head>
  <body>
    <div id="toast">ì•Œë¦¼</div>
    <div class="topbar">ììœ¨í™œë™ê´€ë¦¬ì‹œìŠ¤í…œ</div>

    <div class="container">
      <section class="left">
        <div class="section-header">
          <div class="section-title">í•™ìƒí™œë™ ë°ì´í„° êµ¬ì„±</div>
          <button class="btn accent" onclick="openModal()">
            ğŸ“… ìƒì„¸ ê¸°ë¡ ê´€ë¦¬
          </button>
        </div>

        <div
          style="
            background: #eef2ff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #c7d2fe;
            margin-bottom: 10px;
            flex-shrink: 0;
          "
        >
          <strong
            style="color: #3730a3; display: flex; align-items: center; gap: 8px"
          >
            ğŸ§‘â€ğŸ“ í•™ìƒëª…: ì´í˜„íƒœ
            <span style="font-size: 12px; color: #555">(ê³ ì •)</span>
          </strong>
        </div>

        <div
          style="flex: 1; display: flex; flex-direction: column; min-height: 0"
        >
          <div class="section-header" style="margin-top: 5px; flex-shrink: 0">
            <label class="section-title">ìƒì„± ëŒ€ê¸° ì¤‘ì¸ í™œë™ (ì„ íƒë¨)</label>
          </div>
          <textarea
            id="rawDataDisplay"
            class="textarea"
            readonly
            placeholder="[ìƒì„¸ ê¸°ë¡ ê´€ë¦¬]ì—ì„œ ì²´í¬ëœ í™œë™ë“¤ë§Œ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤."
            style="background: #f9fafb; color: #555; flex: 1"
          ></textarea>
        </div>

        <button
          class="btn primary"
          style="height: 50px; font-size: 16px; margin: 15px 0; flex-shrink: 0"
          onclick="generateAutonomyAI()"
        >
          âœ¨ AI ììœ¨ ë¬¸ì¥ ìƒì„±
        </button>

        <div
          style="flex: 1; display: flex; flex-direction: column; min-height: 0"
        >
          <label
            class="section-title"
            style="margin-bottom: 8px; flex-shrink: 0"
            >AI ìƒì„± ì´ˆì•ˆ</label
          >
          <textarea
            id="tempDraft"
            class="textarea"
            style="background: #fdfbff; border-color: #c7d2fe; flex: 1"
          ></textarea>
          <button
            class="btn success"
            style="width: 100%; margin-top: 10px; flex-shrink: 0"
            onclick="moveToFinal()"
          >
            ìš°ì¸¡ ìµœì¢… ê²°ê³¼ë¡œ ë°˜ì˜ â†’
          </button>
        </div>
      </section>

      <section class="right">
        <div class="section-header" style="margin-bottom: 15px">
          <div class="section-title">NEIS ê¸°ì¬ ìµœì¢… ë‚´ìš©</div>
          <div style="display: flex; gap: 8px">
            <button class="btn danger" onclick="clearFinal()">
              ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
            </button>
            <button class="btn" onclick="checkIntegrity()">
              ğŸª„ ì „ì²´ AI ë‹¤ë“¬ê¸°
            </button>
            <button class="btn success" onclick="finalApply()">
              ğŸ’¾ ì ìš©í•˜ê¸°
            </button>
          </div>
        </div>

        <div
          style="
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 15px;
            min-height: 0;
          "
        >
          <div
            id="finalPreview"
            class="preview-box"
            contenteditable="true"
            oninput="updateByte()"
          ></div>

          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              flex-shrink: 0;
            "
          >
            <div class="counter">
              ì‹¤ì‹œê°„ ìš©ëŸ‰:
              <span id="byteCount" style="color: #1f4ddc; font-weight: 700"
                >0</span
              >
              / 1500 Byte
            </div>
          </div>

          <div class="info-layer" id="infoLayer">
            <span style="font-weight: 700; display: block; margin-bottom: 8px"
              >ğŸ“‹ í¬í•¨ëœ ì •ë³´ ìš”ì•½ (ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ë¬¸ì¥ ìœ„ì¹˜ í‘œì‹œ)</span
            >
            <div id="infoContentContainer" style="color: #999">
              ìƒì„±ëœ ë¬¸ì¥ì— í¬í•¨ëœ í™œë™ ë‚´ì—­ì´ ì´ê³³ì— ëˆ„ì ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </section>
    </div>

    <div id="logModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span style="font-size: 18px; font-weight: 700; color: #374151"
            >í•™ìƒë³„ ììœ¨í™œë™ ìƒì„¸ ê¸°ë¡ ê´€ë¦¬</span
          >
          <button class="btn" onclick="closeModal()">ë‹«ê¸° (ìë™ ì €ì¥ë¨)</button>
        </div>
        <div class="modal-body">
          <div class="student-list" id="modalStudentList"></div>

          <div class="log-entry">
            <div class="tab-menu">
              <div class="tab-btn active" onclick="switchTab('edu', this)">
                ğŸ›¡ï¸ êµìœ¡ (ì•ˆì „/ì˜ˆë°©)
              </div>
              <div class="tab-btn" onclick="switchTab('council', this)">
                ğŸ‘‘ ìì¹˜ í™œë™ (ì„ì›)
              </div>
              <div class="tab-btn" onclick="switchTab('event', this)">
                ğŸŠ êµë‚´ í–‰ì‚¬
              </div>
            </div>

            <div id="tab-edu" class="tab-content active">
              <div class="form-box">
                <div class="form-row">
                  <div class="form-label">í™œë™ ë‚ ì§œ</div>
                  <div class="form-input-group">
                    <input
                      type="date"
                      id="eduDate"
                      class="input"
                      style="width: 200px"
                    />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-label">êµìœ¡ ì£¼ì œ</div>
                  <div class="form-input-group">
                    <select
                      id="eduTopic"
                      class="select"
                      onchange="loadKeywords('edu', this.value)"
                    >
                      <option value="" disabled selected>êµìœ¡ ì£¼ì œ ì„ íƒ</option>
                      <option value="í•™êµí­ë ¥">í•™êµí­ë ¥ ì˜ˆë°©êµìœ¡</option>
                      <option value="ë§ˆì•½ë¥˜">ë§ˆì•½ë¥˜ ì˜¤ë‚¨ìš© ì˜ˆë°©êµìœ¡</option>
                      <option value="ìƒëª…ì¡´ì¤‘">
                        ìƒëª…ì¡´ì¤‘ ë° ìì‚´ì˜ˆë°© êµìœ¡
                      </option>
                      <option value="ì‹¬íì†Œìƒìˆ ">
                        ì‹¬íì†Œìƒìˆ  ë° ì‘ê¸‰ì²˜ì¹˜ êµìœ¡
                      </option>
                      <option value="ê¸°í›„í™˜ê²½">ê¸°í›„ìœ„ê¸° ë° í™˜ê²½êµìœ¡</option>
                    </select>
                  </div>
                </div>
                <div class="form-row" id="area-edu" style="display: none">
                  <div class="form-label">í•µì‹¬ í‚¤ì›Œë“œ</div>
                  <div class="form-input-group">
                    <div
                      id="kw-edu"
                      class="keyword-container"
                      style="margin-top: 0"
                    ></div>
                    <div style="margin-top: 10px; display: flex; gap: 5px">
                      <input
                        type="text"
                        id="custom-edu"
                        class="input"
                        style="flex: 1; padding: 6px; font-size: 12px"
                        placeholder="í‚¤ì›Œë“œ ì§ì ‘ ì…ë ¥ (ì˜ˆ: ì ê·¹ì  ì†Œí†µ)"
                      />
                      <button
                        class="btn accent sm"
                        onclick="addCustomKeyword('edu')"
                      >
                        + ì¶”ê°€
                      </button>
                    </div>
                  </div>
                </div>
                <div style="text-align: right">
                  <button class="btn primary" onclick="saveActivity('edu')">
                    + ëª©ë¡ì— ì¶”ê°€/ì €ì¥
                  </button>
                </div>
              </div>
            </div>

            <div id="tab-council" class="tab-content">
              <div class="form-box">
                <div class="form-row">
                  <div class="form-label">í™œë™ ê¸°ê°„</div>
                  <div class="form-input-group">
                    <select
                      id="councilPeriod"
                      class="select"
                      style="width: 200px; margin-bottom: 10px"
                      onchange="toggleCustomDate()"
                    >
                      <option value="" disabled selected>
                        ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”
                      </option>
                      <option value="1í•™ê¸°">1í•™ê¸°</option>
                      <option value="2í•™ê¸°">2í•™ê¸°</option>
                      <option value="ì—°ì¤‘">1ë…„ (ì—°ì¤‘)</option>
                      <option value="custom">ê¸°íƒ€ (ê¸°ê°„ ì„¤ì •)</option>
                    </select>
                    <div
                      id="councilDateRange"
                      style="display: none; gap: 10px; align-items: center"
                    >
                      <input type="date" id="councilStart" class="input" /> ~
                      <input type="date" id="councilEnd" class="input" />
                    </div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-label">ì—­í• /ì§ì±…</div>
                  <div class="form-input-group">
                    <select
                      id="councilRole"
                      class="select"
                      onchange="loadKeywords('council', 'ìì¹˜í™œë™')"
                    >
                      <option value="" disabled selected>
                        ì—­í• ì„ ì„ íƒí•˜ì„¸ìš”
                      </option>
                      <option value="class_leader">í•™ê¸‰ ë°˜ì¥</option>
                      <option value="class_sub">í•™ê¸‰ ë¶€ë°˜ì¥</option>
                      <option value="school_leader">í•™ìƒíšŒì¥</option>
                      <option value="exec">í•™ìƒíšŒ ì„ì›</option>
                      <option value="member">í•™ê¸‰ êµ¬ì„±ì›</option>
                    </select>
                  </div>
                </div>
                <div class="form-row" id="area-council" style="display: none">
                  <div class="form-label">ìˆ˜í–‰ ë‚´ìš©<br />(í‚¤ì›Œë“œ)</div>
                  <div class="form-input-group">
                    <div
                      id="kw-council"
                      class="keyword-container"
                      style="margin-top: 0"
                    ></div>
                    <div style="margin-top: 10px; display: flex; gap: 5px">
                      <input
                        type="text"
                        id="custom-council"
                        class="input"
                        style="flex: 1; padding: 6px; font-size: 12px"
                        placeholder="ìˆ˜í–‰ ë‚´ìš©ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”"
                      />
                      <button
                        class="btn accent sm"
                        onclick="addCustomKeyword('council')"
                      >
                        + ì¶”ê°€
                      </button>
                    </div>
                  </div>
                </div>
                <div style="text-align: right">
                  <button class="btn primary" onclick="saveActivity('council')">
                    + ëª©ë¡ì— ì¶”ê°€/ì €ì¥
                  </button>
                </div>
              </div>
            </div>

            <div id="tab-event" class="tab-content">
              <div class="form-box">
                <div class="form-row">
                  <div class="form-label">í–‰ì‚¬ ë‚ ì§œ</div>
                  <div class="form-input-group">
                    <input
                      type="date"
                      id="eventDate"
                      class="input"
                      style="width: 200px"
                    />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-label">í–‰ì‚¬ëª…</div>
                  <div class="form-input-group">
                    <select
                      id="eventName"
                      class="select"
                      onchange="loadKeywords('event', this.value)"
                    >
                      <option value="" disabled selected>
                        í–‰ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”
                      </option>
                      <option value="ì²´ìœ¡ëŒ€íšŒ">ì²´ìœ¡ëŒ€íšŒ</option>
                      <option value="í•™êµì¶•ì œ">í•™êµ ì¶•ì œ</option>
                      <option value="í˜„ì¥ì²´í—˜í•™ìŠµ">í˜„ì¥ì²´í—˜í•™ìŠµ</option>
                      <option value="custom">ê¸°íƒ€ í–‰ì‚¬ (ì§ì ‘ ì…ë ¥)</option>
                    </select>
                    <input
                      type="text"
                      id="customEventName"
                      class="input"
                      placeholder="í–‰ì‚¬ëª… ì§ì ‘ ì…ë ¥"
                      style="display: none; margin-top: 10px"
                    />
                  </div>
                </div>
                <div class="form-row" id="area-event" style="display: none">
                  <div class="form-label">ì°¸ì—¬/í™œì•½<br />(í‚¤ì›Œë“œ)</div>
                  <div class="form-input-group">
                    <div
                      id="kw-event"
                      class="keyword-container"
                      style="margin-top: 0"
                    ></div>
                    <div style="margin-top: 10px; display: flex; gap: 5px">
                      <input
                        type="text"
                        id="custom-event"
                        class="input"
                        style="flex: 1; padding: 6px; font-size: 12px"
                        placeholder="ì°¸ì—¬ ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì¶”ê°€í•˜ì„¸ìš”"
                      />
                      <button
                        class="btn accent sm"
                        onclick="addCustomKeyword('event')"
                      >
                        + ì¶”ê°€
                      </button>
                    </div>
                  </div>
                </div>
                <div style="text-align: right">
                  <button class="btn primary" onclick="saveActivity('event')">
                    + ëª©ë¡ì— ì¶”ê°€/ì €ì¥
                  </button>
                </div>
              </div>
            </div>

            <div
              style="
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 0;
              "
            >
              <div
                style="
                  margin-bottom: 10px;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  flex-shrink: 0;
                "
              >
                <span style="font-weight: 700; color: #374151"
                  >ğŸ•’ ì…ë ¥ëœ ê¸°ë¡ ëª©ë¡</span
                >
                <div>
                  <button class="btn sm" onclick="checkAll(true)">
                    ì „ì²´ ì„ íƒ
                  </button>
                  <button class="btn sm" onclick="checkAll(false)">
                    ì „ì²´ í•´ì œ
                  </button>
                </div>
              </div>
              <div
                id="historyListContainer"
                style="overflow-y: auto; flex: 1; padding-right: 5px"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      /* --- [ì™„ë²½í•œ ìƒê¸°ë¶€ ì—°ê²°ì–´ë¯¸ DB] (ë¬¸ë²• íŒŒê´´ ì›ì²œ ì°¨ë‹¨) --- */
      const DB = {
        edu: {
          í•™êµí­ë ¥: {
            "ìœ„í—˜ì„± ì¸ì§€": "í­ë ¥ì´ íƒ€ì¸ì—ê²Œ ë‚¨ê¸°ëŠ” ìƒì²˜ë¥¼ ê¹Šì´ ì„±ì°°í•˜ê³ ,",
            "ì–¸ì–´í­ë ¥ ì˜ˆë°©": "ì–¸ì–´í­ë ¥ ì˜ˆë°©ì˜ ì¤‘ìš”ì„±ì„ ëª…í™•íˆ ì¸ì§€í•˜ë©°,",
            "ë°©ê´€ì ë°©ì§€":
              "í­ë ¥ ìƒí™©ì—ì„œ ì ê·¹ì ìœ¼ë¡œ ë„ì›€ì„ ìš”ì²­í•˜ëŠ” ìš©ê¸°ë¥¼ ë‚´ë©°,",
            "ìƒí˜¸ ì¡´ì¤‘ ë°°ë ¤":
              "ìƒí˜¸ ì¡´ì¤‘ì˜ íƒœë„ë¥¼ ì¼ìƒ ì†ì—ì„œ ì ê·¹ì ìœ¼ë¡œ ì‹¤ì²œí•˜ë©°,",
            "ì ê·¹ì  ì¤‘ì¬ì": "í•™ê¸‰ ë‚´ ê°ˆë“± ìƒí™©ì—ì„œ ê¸ì •ì  ì¤‘ì¬ìë¡œ ë‚˜ì„œë©°,",
            "ê±´ì „í•œ êµìš°ê´€ê³„": "íƒ€ì¸ì„ ë°°ë ¤í•˜ë©° ê±´ì „í•œ êµìš°ê´€ê³„ë¥¼ í˜•ì„±í•˜ê³ ,",
          },
          ë§ˆì•½ë¥˜: {
            "ë‡Œì‹ ê²½ íŒŒê´´ ì´í•´":
              "ë§ˆì•½ë¥˜ì˜ ì¤‘ë…ì„±ê³¼ ë‡Œ ì‹ ê²½ íŒŒê´´ì˜ ìœ„í—˜ì„±ì„ ë‹¤ê°ë„ë¡œ ì¸ì§€í•˜ê³ ,",
            "ì˜¤ë‚¨ìš© íí•´ ë¶„ì„":
              "ì•½ë¬¼ ì˜¤ë‚¨ìš©ì´ ë¯¸ì¹˜ëŠ” íŒŒê´´ì ì¸ íí•´ë¥¼ ë¶„ì„í•˜ë©°,",
            "ë‹¨í˜¸í•œ ê±°ì ˆë²•":
              "ìœ í˜¹ ìƒí™©ì—ì„œ í”ë“¤ë¦¬ì§€ ì•Šê³  ë‹¨í˜¸í•˜ê²Œ ê±°ì ˆí•˜ëŠ” ì—­ëŸ‰ì„ í•¨ì–‘í•˜ê³ ,",
            "ê±´ê°•í•œ ìŠ¤íŠ¸ë ˆìŠ¤ í•´ì†Œ":
              "ê±´ì „í•œ ì·¨ë¯¸ë¥¼ í†µí•´ ê±´ê°•í•˜ê²Œ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ í•´ì†Œí•˜ëŠ” ë°©ì•ˆì„ ëª¨ìƒ‰í•˜ë©°,",
            "ì˜ˆë°© ìº í˜ì¸ ì°¸ì—¬": "ë§ˆì•½ë¥˜ ì˜ˆë°© ìº í˜ì¸ì˜ ì·¨ì§€ì— ê¹Šì´ ê³µê°í•˜ë©°,",
          },
          ìƒëª…ì¡´ì¤‘: {
            "ì ˆëŒ€ì  ê°€ì¹˜":
              "ëª¨ë“  ìƒëª…ì´ ê°€ì§„ ê³ ìœ í•œ ê°€ì¹˜ì™€ ì¡´ì—„ì„±ì„ ê°€ìŠ´ ê¹Šì´ ìƒˆê¸°ë©°,",
            ìì•„ì¡´ì¤‘ê°:
              "ì–´ë ¤ì›€ ì†ì—ì„œë„ ìŠ¤ìŠ¤ë¡œë¥¼ ì•„ë¼ëŠ” ê¸ì •ì ì¸ ìì•„ì¡´ì¤‘ê°ì„ í˜•ì„±í•˜ê³ ,",
            "ìœ„ê¸° ì‹ í˜¸ íŒŒì•…":
              "ì£¼ë³€ì˜ ìœ„ê¸° ì‹ í˜¸ë¥¼ ë¯¼ê°í•˜ê²Œ íŒŒì•…í•˜ê³  ì†ì„ ë‚´ë°€ì–´ì£¼ëŠ” ê³µê° ëŠ¥ë ¥ì„ ë°œíœ˜í•˜ë©°,",
            "ê³µê°ì  ê²½ì²­":
              "íƒ€ì¸ì˜ ì•„í””ì— ê³µê°í•˜ê³  ì§„ì‹¬ìœ¼ë¡œ ê²½ì²­í•˜ëŠ” íƒœë„ë¥¼ ê¸°ë¥´ë©°,",
            "ìƒëª… ë³´í˜¸ ì˜ì§€":
              "ìì‹ ê³¼ íƒ€ì¸ì˜ ìƒëª…ì„ ì§€í‚¤ë ¤ëŠ” ê°•í•œ ì˜ì§€ë¥¼ ë‹¤ì§€ë©°,",
          },
          ì‹¬íì†Œìƒìˆ : {
            "ê³¨ë“ íƒ€ì„ ì²´í™”":
              "ìƒëª…ì„ ì‚´ë¦¬ëŠ” ê³¨ë“ íƒ€ì„ì˜ ê²°ì •ì  ì¤‘ìš”ì„±ì„ ì²´í™”í•˜ê³ ,",
            "í‰ë¶€ ì••ë°• ì‹¤ìŠµ":
              "ì‹¤ìŠµì„ í†µí•´ ì •í™•í•œ ìœ„ì¹˜ì™€ ì¼ì •í•œ ê°•ë„ë¡œ í‰ë¶€ ì••ë°•ì„ ìˆ˜í–‰í•˜ë©°,",
            "AED ë§ˆìŠ¤í„°":
              "AED ì˜¬ë°”ë¥¸ ì‚¬ìš©ë²•ì„ ìˆ™ì§€í•˜ì—¬ ìœ„ê¸‰ ìƒí™© ëŒ€ì²˜ ìì‹ ê°ì„ ì–»ê³ ,",
            "ì¹¨ì°©í•œ ëŒ€ì²˜": "ì‘ê¸‰ ìƒí™© ë°œìƒ ì‹œ ì¹¨ì°©í•˜ê²Œ ëŒ€ì²˜í•˜ëŠ” ë°©ë²•ì„ ìµíˆë©°,",
            "119 ì‹ ê³ ìš”ë ¹": "ì •í™•í•˜ê³  ì‹ ì†í•œ 119 ì‹ ê³ ìš”ë ¹ì„ ì™„ë²½íˆ ìˆ™ì§€í•˜ë©°,",
          },
          ê¸°í›„í™˜ê²½: {
            "ê¸°í›„ìœ„ê¸° ì¸ì‹": "ì „ ì§€êµ¬ì  ê¸°í›„ìœ„ê¸°ì˜ ì‹¬ê°ì„±ì„ ê¹Šì´ ì²´ê°í•˜ê³ ,",
            "íƒ„ì†Œì¤‘ë¦½ ì‹¤ì²œ":
              "íƒ„ì†Œì¤‘ë¦½ì„ ìœ„í•œ ì¼ìƒ ì† ì‹¤ì²œ ë°©ì•ˆì„ ì ê·¹ì ìœ¼ë¡œ ëª¨ìƒ‰í•˜ë©°,",
            "ë¶„ë¦¬ë°°ì¶œ ë™ì°¸":
              "ì˜¬ë°”ë¥¸ ë¶„ë¦¬ë°°ì¶œì— ì†”ì„ ìˆ˜ë²”í•˜ì—¬ ì§€ì†ê°€ëŠ¥í•œ í™˜ê²½ ì¡°ì„±ì— ê¸°ì—¬í•˜ê³ ,",
            "ì—ë„ˆì§€ ì ˆì•½": "ì¼ìƒ ì†ì—ì„œ ì—ë„ˆì§€ ì ˆì•½ì„ ê¾¸ì¤€íˆ ìƒí™œí™”í•˜ë©°,",
            "ìì› ìˆœí™˜ ì´í•´":
              "ìì› ìˆœí™˜ì˜ ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  í™˜ê²½ ë³´í˜¸ ì‹¤ì²œ ì˜ì§€ë¥¼ ë‹¤ì§€ë©°,",
          },
        },
        council: {
          ìì¹˜í™œë™: {
            ì†”ì„ ìˆ˜ë²”: "ë§¤ì‚¬ ì†”ì„ ìˆ˜ë²”í•˜ëŠ” íƒœë„ë¥¼ ë³´ì´ë©°,",
            "ê°ˆë“± ì¤‘ì¬": "í•™ê¸‰ ë‚´ ì´ê²¬ì„ ë¯¼ì£¼ì ìœ¼ë¡œ ì¡°ìœ¨í•˜ê³  ì¤‘ì¬í•˜ë©°,",
            "ì˜ê²¬ ìˆ˜ë ´": "í•™ìš°ë“¤ì˜ ì˜ê²¬ì„ ì ê·¹ì ìœ¼ë¡œ ìˆ˜ë ´í•˜ì—¬ ë°˜ì˜í•˜ê³ ,",
            "í–‰ì‚¬ ê¸°íš ì£¼ë„": "ììœ¨ì ì¸ ì•„ì´ë””ì–´ë¡œ í–‰ì‚¬ë¥¼ ê¸°íší•˜ê³  ì£¼ë„í•˜ë©°,",
            "ì±…ì„ê° ì™„ìˆ˜":
              "ìì‹ ì˜ ì—­í• ì„ ì±…ì„ê° ìˆê²Œ ì™„ìˆ˜í•˜ì—¬ ë‘í„°ìš´ ì‹ ë¢°ë¥¼ ì–»ê³ ,",
            "ì†Œí†µ ì°½êµ¬ ì—­í• ":
              "ì„ ìƒë‹˜ê³¼ í•™ìƒ ê°„ì˜ ì›í™œí•œ ì†Œí†µ ì°½êµ¬ ì—­í• ì„ í›Œë¥­íˆ ìˆ˜í–‰í•˜ë©°,",
            "ë¯¼ì£¼ì  ì˜ì‚¬ê²°ì •":
              "ë¯¼ì£¼ì ì¸ ì ˆì°¨ì— ë”°ë¼ í•©ë¦¬ì ìœ¼ë¡œ ì˜ì‚¬ê²°ì •ì„ ì´ëŒë©°,",
          },
        },
        event: {
          ì²´ìœ¡ëŒ€íšŒ: {
            "í˜‘ë™ì‹¬ ë°œíœ˜": "ê¸‰ìš°ë“¤ê³¼ ë›°ì–´ë‚œ í˜‘ë™ì‹¬ì„ ë°œíœ˜í•˜ì—¬ ê²½ê¸°ì— ì„í•˜ê³ ,",
            ì •ì •ë‹¹ë‹¹: "ê·œì¹™ì„ ì¤€ìˆ˜í•˜ë©° ì •ì •ë‹¹ë‹¹í•œ ìŠ¤í¬ì¸  ì •ì‹ ì„ ë³´ì—¬ì£¼ë©°,",
            "ì‘ì› ì£¼ë„": "ì—´ì •ì ì¸ ì‘ì›ì„ ì£¼ë„í•˜ì—¬ í•™ê¸‰ì˜ ë‹¨í•©ì„ ì´ëŒì–´ë‚´ê³ ,",
            "ì§ˆì„œ ìœ ì§€": "í–‰ì‚¬ ì¤‘ ì§ˆì„œ ìœ ì§€ì™€ ë’·ì •ë¦¬ì— ì†”ì„ ìˆ˜ë²”í•˜ë©°,",
            "ì•ˆì „ ìˆ˜ì¹™ ì¤€ìˆ˜":
              "ê²½ê¸° ì „í›„ ì•ˆì „ ìˆ˜ì¹™ì„ ì² ì €íˆ ì§€ì¼œ íƒ€ì˜ ëª¨ë²”ì´ ë˜ë©°,",
          },
          í•™êµì¶•ì œ: {
            "ë¶€ìŠ¤ ê¸°íš": "ë…ì°½ì ì¸ ì•„ì´ë””ì–´ë¡œ í•™ê¸‰ ë¶€ìŠ¤ë¥¼ ê¸°íš ë° ìš´ì˜í•˜ê³ ,",
            "ì¬ëŠ¥ ë°œíœ˜":
              "ìì‹ ì˜ ë¼ì™€ ì¬ëŠ¥ì„ ì•„ë‚Œì—†ì´ ë°œíœ˜í•˜ì—¬ í° í˜¸ì‘ì„ ì–»ìœ¼ë©°,",
            "í˜‘ë ¥ì  íƒœë„":
              "ì¤€ë¹„ ê³¼ì •ì—ì„œ ì¹œêµ¬ë“¤ê³¼ í˜‘ë ¥í•˜ì—¬ í›Œë¥­í•œ ì‹œë„ˆì§€ë¥¼ ì°½ì¶œí•˜ê³ ,",
            "ì§„í–‰ ë³´ì¡°":
              "í–‰ì‚¬ì˜ ì›í™œí•œ ì§„í–‰ì„ ìœ„í•´ ë¬µë¬µíˆ ì§€ì› ì—­í• ì„ ìˆ˜í–‰í•˜ë©°,",
            "ê´€ëŒ ë§¤ë„ˆ":
              "ë‹¤ë¥¸ í•™ê¸‰ì˜ í–‰ì‚¬ë¥¼ ì¡´ì¤‘í•˜ë©° ì„±ìˆ™í•œ ê´€ëŒ ë§¤ë„ˆë¥¼ ë³´ì—¬ì£¼ë©°,",
          },
          í˜„ì¥ì²´í—˜í•™ìŠµ: {
            "ì•ˆì „ ì¤€ìˆ˜": "ì•ˆì „ ìˆ˜ì¹™ì„ ì² ì €íˆ ì¤€ìˆ˜í•˜ë©° ì§„ì§€í•˜ê²Œ ì²´í—˜ì— ì„í•˜ê³ ,",
            "ê²¬ë¬¸ í™•ëŒ€":
              "ìƒˆë¡œìš´ í™˜ê²½ì—ì„œ ì£¼ë„ì ìœ¼ë¡œ íƒêµ¬í•˜ë©° í­ë„“ì€ ê²¬ë¬¸ì„ ìŒ“ê³ ,",
            "ë¬¸í™”ì  ì†Œì–‘":
              "ì§ˆì„œ ì •ì—°í•œ íƒœë„ë¡œ ê´€ëŒí•˜ë©° ê¹Šì´ ìˆëŠ” ë¬¸í™”ì  ì†Œì–‘ì„ í•¨ì–‘í•˜ë©°,",
            "ê³µë™ì²´ ê·œë²”": "ë‹¨ì²´ ìƒí™œì˜ ê·œë²”ì„ ì˜ ì§€ì¼œ íƒ€ì˜ ëª¨ë²”ì´ ë˜ë©°,",
            "ì£¼ë„ì  ì°¸ì—¬":
              "ìˆ˜ë™ì ì¸ ê´€ëŒì„ ë„˜ì–´ ì£¼ë„ì ìœ¼ë¡œ ë¬»ê³  ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•˜ë©°,",
          },
        },
      };

      const ROLE_LABELS = {
        member: "í•™ê¸‰ êµ¬ì„±ì›",
        class_leader: "í•™ê¸‰ ë°˜ì¥",
        class_sub: "í•™ê¸‰ ë¶€ë°˜ì¥",
        school_leader: "í•™ìƒíšŒì¥",
        exec: "í•™ìƒíšŒ ì„ì›",
      };
      const ROLE_INTROS = {
        class_leader:
          "í•™ê¸‰ ë°˜ì¥ìœ¼ë¡œì„œ ë›°ì–´ë‚œ ë¦¬ë”ì‹­ê³¼ ì±…ì„ê°ì„ ë°œíœ˜í•˜ì—¬ í•™ê¸‰ì„ ì´ëŒë©°,",
        class_sub:
          "í•™ê¸‰ ë¶€ë°˜ì¥ìœ¼ë¡œì„œ ë°˜ì¥ì„ ë„ì™€ í•™ê¸‰ì˜ í™”í•©ê³¼ ì•ˆì •ì„ ìœ„í•´ í—Œì‹ í•˜ë©°,",
        school_leader:
          "í•™ìƒíšŒì¥ìœ¼ë¡œì„œ ììœ¨ì ì´ê³  ë¯¼ì£¼ì ì¸ í•™êµ ë¬¸í™”ë¥¼ ë§Œë“œëŠ” ë° ì•ì¥ì„œë©°,",
        exec: "í•™ìƒíšŒ ì„ì›ìœ¼ë¡œì„œ í•™êµ ì£¼ìš” í–‰ì‚¬ ê¸°íšê³¼ ìš´ì˜ì— í•µì‹¬ì ì¸ ì—­í• ì„ ìˆ˜í–‰í•˜ë©°,",
        member:
          "í•™ê¸‰ êµ¬ì„±ì›ìœ¼ë¡œì„œ ë™ë£Œë“¤ê³¼ í˜‘ë ¥í•˜ê³  í•™êµìƒí™œì— ì£¼ë„ì ìœ¼ë¡œ ì°¸ì—¬í•˜ë©°,",
      };

      let studentHistory = [];
      let finalHistory = [];
      let historyIdCounter = 0;
      let selectedKeywordsMap = { edu: [], council: [], event: [] };
      let tempContext = null;

      window.onload = () => {
        const list = document.getElementById("modalStudentList");
        const div = document.createElement("div");
        div.className = "student-item active";
        div.textContent = "ì´í˜„íƒœ";
        list.appendChild(div);
        renderHistory();
      };

      function openModal() {
        document.getElementById("logModal").style.display = "block";
      }
      function closeModal() {
        document.getElementById("logModal").style.display = "none";
        updateMainSummary();
      }

      function switchTab(tabId, btn) {
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));
        document.getElementById("tab-" + tabId).classList.add("active");
      }

      function toggleCustomDate() {
        const val = document.getElementById("councilPeriod").value;
        document.getElementById("councilDateRange").style.display =
          val === "custom" ? "flex" : "none";
      }

      function loadKeywords(tabType, topic) {
        if (!topic) return;
        const area = document.getElementById("area-" + tabType);
        const container = document.getElementById("kw-" + tabType);

        if (topic === "custom" && tabType === "event") {
          document.getElementById("customEventName").style.display = "block";
          area.style.display = "block";
          container.innerHTML = "";
          selectedKeywordsMap[tabType] = [];
          return;
        } else if (tabType === "event") {
          document.getElementById("customEventName").style.display = "none";
        }

        area.style.display = "block";
        container.innerHTML = "";
        selectedKeywordsMap[tabType] = [];

        let kwDict = DB[tabType][topic] || {
          "ì ê·¹ ì°¸ì—¬": "ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•˜ë©°,",
        };
        Object.keys(kwDict).forEach((kw) => {
          const btn = document.createElement("button");
          btn.className = "kw-btn";
          btn.textContent = kw;
          btn.onclick = () => {
            if (selectedKeywordsMap[tabType].includes(kw)) {
              selectedKeywordsMap[tabType] = selectedKeywordsMap[
                tabType
              ].filter((k) => k !== kw);
              btn.classList.remove("active");
            } else {
              selectedKeywordsMap[tabType].push(kw);
              btn.classList.add("active");
            }
          };
          container.appendChild(btn);
        });
      }

      function addCustomKeyword(tabType) {
        const input = document.getElementById("custom-" + tabType);
        const val = input.value.trim();
        if (!val) return;
        if (selectedKeywordsMap[tabType].includes(val))
          return alert("ì´ë¯¸ ì„ íƒëœ í‚¤ì›Œë“œì…ë‹ˆë‹¤.");

        selectedKeywordsMap[tabType].push(val);
        const btn = document.createElement("button");
        btn.className = "kw-btn custom-kw active";
        btn.textContent = val + " (ê¸°íƒ€)";
        btn.onclick = () => {
          selectedKeywordsMap[tabType] = selectedKeywordsMap[tabType].filter(
            (k) => k !== val
          );
          btn.remove();
        };
        document.getElementById("kw-" + tabType).appendChild(btn);
        input.value = "";
      }

      /* --- [ì •ë°€ ë‹¬ë ¥ ì—°ì‚°] --- */
      function checkPeriodOverlap(p1, p2) {
        if (p1 === p2) return true;
        if (p1 === "ì—°ì¤‘" || p2 === "ì—°ì¤‘") return true;

        function getMonthsFromRange(rangeStr) {
          let dates = rangeStr.split(" ~ ");
          if (dates.length !== 2) return [];
          let d1 = new Date(dates[0]);
          let d2 = new Date(dates[1]);
          if (isNaN(d1) || isNaN(d2)) return [];
          let months = new Set();
          let curr = new Date(d1);
          while (curr <= d2) {
            months.add(curr.getMonth() + 1);
            curr.setDate(curr.getDate() + 15);
          }
          return Array.from(months);
        }

        let isP1Custom = p1.includes("~");
        let isP2Custom = p2.includes("~");

        if (isP1Custom && isP2Custom) {
          let dates1 = p1.split(" ~ ");
          let dates2 = p2.split(" ~ ");
          return (
            new Date(dates1[0]) <= new Date(dates2[1]) &&
            new Date(dates2[0]) <= new Date(dates1[1])
          );
        }

        let customRange = isP1Custom ? p1 : isP2Custom ? p2 : null;
        let term = !isP1Custom ? p1 : !isP2Custom ? p2 : null;

        if (customRange && term) {
          let months = getMonthsFromRange(customRange);
          let term1Months = [3, 4, 5, 6, 7, 8];
          let term2Months = [9, 10, 11, 12, 1, 2];
          if (term === "1í•™ê¸°")
            return months.some((m) => term1Months.includes(m));
          if (term === "2í•™ê¸°")
            return months.some((m) => term2Months.includes(m));
        }
        return false;
      }

      /* --- ë°ì´í„° ì €ì¥ --- */
      function saveActivity(type) {
        let data = {
          id: ++historyIdCounter,
          type,
          checked: true,
          keywords: [...selectedKeywordsMap[type]],
          isConflict: false,
          conflictMsg: "",
        };

        if (type === "edu") {
          let topic = document.getElementById("eduTopic").value;
          data.date = document.getElementById("eduDate").value;
          if (!topic || !data.date || data.keywords.length === 0)
            return alert("í•­ëª©ì„ ëª¨ë‘ ê¸°ì…í•˜ì„¸ìš”.");
          data.title = topic;
          data.roleKey = "member";
        } else if (type === "council") {
          let period = document.getElementById("councilPeriod").value;
          if (period === "custom") {
            const s = document.getElementById("councilStart").value;
            const e = document.getElementById("councilEnd").value;
            if (!s || !e) return alert("ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì…ë ¥í•˜ì„¸ìš”.");
            period = `${s} ~ ${e}`;
          }
          let role = document.getElementById("councilRole").value;
          if (!period || !role || data.keywords.length === 0)
            return alert("í•­ëª©ì„ ëª¨ë‘ ê¸°ì…í•˜ì„¸ìš”.");
          data.date = period;
          data.title = ROLE_LABELS[role];
          data.roleKey = role;
        } else if (type === "event") {
          let eName = document.getElementById("eventName").value;
          if (eName === "custom")
            eName = document.getElementById("customEventName").value.trim();
          data.date = document.getElementById("eventDate").value;
          if (!eName || !data.date || data.keywords.length === 0)
            return alert("í•­ëª©ì„ ëª¨ë‘ ê¸°ì…í•˜ì„¸ìš”.");
          data.title = eName;
          data.roleKey = "member";
        }

        // ëª¨ë“  ì €ì¥ì„ í—ˆìš© (ì¤‘ë³µì´ì–´ë„ ë¦¬ìŠ¤íŠ¸ì—” ë“¤ì–´ê°)
        studentHistory.forEach((h) => (h.checked = false));
        studentHistory.push(data);

        selectedKeywordsMap[type] = [];
        document.getElementById("area-" + type).style.display = "none";
        if (type === "edu") {
          document.getElementById("eduTopic").value = "";
          document.getElementById("eduDate").value = "";
        } else if (type === "council") {
          document.getElementById("councilPeriod").value = "";
          document.getElementById("councilRole").value = "";
          document.getElementById("councilDateRange").style.display = "none";
        } else {
          document.getElementById("eventName").value = "";
          document.getElementById("eventDate").value = "";
          document.getElementById("customEventName").style.display = "none";
        }

        evalConflicts(); // ë™ì  ì¶©ëŒ í‰ê°€

        const savedItem = studentHistory[studentHistory.length - 1];
        if (savedItem.isConflict)
          alert(
            `âš ï¸ ì£¼ì˜: ${savedItem.conflictMsg}ì´(ê°€) ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ëª©ë¡ì— ì˜¤ë¥˜ íƒœê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.`
          );
        else showToast("ëª©ë¡ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");

        renderHistory();
      }

      /* 1ë‹¨ê³„ ë”¥ ë“€í”Œë¦¬ì¼€ì´ì…˜: ë·° ë‹¨ì˜ ë™ì  ì˜¤ë¥˜ ê³„ì‚° */
      function evalConflicts() {
        studentHistory.forEach((h) => {
          h.isConflict = false;
          h.conflictMsg = "";
        });

        let eduTopics = {};
        studentHistory
          .filter((h) => h.type === "edu")
          .forEach((h) => {
            if (!eduTopics[h.title]) eduTopics[h.title] = [];
            eduTopics[h.title].push(h);
          });
        Object.values(eduTopics).forEach((group) => {
          if (group.length > 1)
            group.forEach((h) => {
              h.isConflict = true;
              h.conflictMsg = "ë™ì¼ êµìœ¡ ì¤‘ë³µ";
            });
        });

        let eventKeys = {};
        studentHistory
          .filter((h) => h.type === "event")
          .forEach((h) => {
            let key = h.title + "|" + h.date;
            if (!eventKeys[key]) eventKeys[key] = [];
            eventKeys[key].push(h);
          });
        Object.values(eventKeys).forEach((group) => {
          if (group.length > 1)
            group.forEach((h) => {
              h.isConflict = true;
              h.conflictMsg = "ë™ì¼ í–‰ì‚¬ ì¤‘ë³µ";
            });
        });

        let councilItems = studentHistory.filter(
          (h) => h.type === "council" && h.roleKey !== "member"
        );
        for (let i = 0; i < councilItems.length; i++) {
          for (let j = i + 1; j < councilItems.length; j++) {
            if (
              checkPeriodOverlap(councilItems[i].date, councilItems[j].date)
            ) {
              councilItems[i].isConflict = true;
              councilItems[i].conflictMsg = "ì„ì› ê¸°ê°„ ì¤‘ë³µ";
              councilItems[j].isConflict = true;
              councilItems[j].conflictMsg = "ì„ì› ê¸°ê°„ ì¤‘ë³µ";
            }
          }
        }
      }

      function renderHistory() {
        const container = document.getElementById("historyListContainer");
        if (!studentHistory.length) {
          container.innerHTML =
            '<div style="text-align:center;color:#999;padding:20px; border:1px solid #e5e7eb; border-radius:8px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        let html = "";
        [...studentHistory].reverse().forEach((item) => {
          let emoji =
            item.type === "edu" ? "ğŸ›¡ï¸" : item.type === "council" ? "ğŸ‘‘" : "ğŸŠ";
          let conflictTag = item.isConflict
            ? `<span class="error-tag">âš ï¸ ${item.conflictMsg}</span>`
            : "";
          let dTitle =
            item.type === "edu" ? item.title + " ì˜ˆë°©êµìœ¡" : item.title;

          html += `
            <div class="history-item" style="${
              item.checked
                ? "border-left:4px solid #1f4ddc;"
                : "border-left:4px solid transparent;"
            }">
                <input type="checkbox" class="history-chk" ${
                  item.checked ? "checked" : ""
                } onchange="toggleCheck(${item.id})" style="margin-top:2px;">
                <div style="flex:1;">
                    <div style="font-size:12px; color:#666; margin-bottom:4px;">${
                      item.date
                    }</div>
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:6px;">
                        <span style="font-size:16px;">${emoji}</span>
                        <strong style="font-size:14px; color:#333;">${dTitle}</strong>
                        ${conflictTag}
                    </div>
                    <div style="font-size:13px; color:#1f4ddc;">ğŸ”‘ ${item.keywords.join(
                      ", "
                    )}</div>
                </div>
                <div style="display:flex; flex-direction:column; gap:5px;">
                    <button class="btn sm warning" onclick="editHistory(${
                      item.id
                    })">ìˆ˜ì •</button>
                    <button class="btn sm" style="color:red; border:1px solid #ffcccc; background:#fff;" onclick="deleteHistory(${
                      item.id
                    })">ì‚­ì œ</button>
                </div>
            </div>`;
        });
        container.innerHTML = html;
      }

      function editHistory(id) {
        const item = studentHistory.find((i) => i.id === id);
        if (!item) return;

        studentHistory = studentHistory.filter((i) => i.id !== id);
        evalConflicts();
        renderHistory();
        updateMainSummary();

        let btnIndex =
          item.type === "edu" ? 0 : item.type === "council" ? 1 : 2;
        document.querySelectorAll(".tab-btn")[btnIndex].click();

        if (item.type === "edu") {
          document.getElementById("eduTopic").value = item.title;
          document.getElementById("eduDate").value = item.date;
          loadKeywords("edu", item.title);
          restoreKeywords("edu", item.keywords);
        } else if (item.type === "council") {
          document.getElementById("councilRole").value = item.roleKey;
          if (["1í•™ê¸°", "2í•™ê¸°", "ì—°ì¤‘"].includes(item.date)) {
            document.getElementById("councilPeriod").value = item.date;
            toggleCustomDate();
          } else {
            document.getElementById("councilPeriod").value = "custom";
            toggleCustomDate();
            let d = item.date.split(" ~ ");
            if (d.length === 2) {
              document.getElementById("councilStart").value = d[0];
              document.getElementById("councilEnd").value = d[1];
            }
          }
          loadKeywords("council", "ìì¹˜í™œë™");
          restoreKeywords("council", item.keywords);
        } else if (item.type === "event") {
          document.getElementById("eventDate").value = item.date;
          let opts = Array.from(
            document.getElementById("eventName").options
          ).map((o) => o.value);
          if (opts.includes(item.title)) {
            document.getElementById("eventName").value = item.title;
            loadKeywords("event", item.title);
          } else {
            document.getElementById("eventName").value = "custom";
            document.getElementById("customEventName").style.display = "block";
            document.getElementById("customEventName").value = item.title;
            loadKeywords("event", "custom");
          }
          restoreKeywords("event", item.keywords);
        }
      }

      function restoreKeywords(tabType, keywordsArray) {
        selectedKeywordsMap[tabType] = [];
        let container = document.getElementById("kw-" + tabType);
        let btns = container.querySelectorAll(".kw-btn");

        keywordsArray.forEach((kw) => {
          let found = false;
          btns.forEach((btn) => {
            if (btn.innerText === kw) {
              btn.classList.add("active");
              selectedKeywordsMap[tabType].push(kw);
              found = true;
            }
          });
          if (!found) {
            selectedKeywordsMap[tabType].push(kw);
            const btn = document.createElement("button");
            btn.className = "kw-btn custom-kw active";
            btn.textContent = kw + " (ê¸°íƒ€)";
            btn.onclick = () => {
              selectedKeywordsMap[tabType] = selectedKeywordsMap[
                tabType
              ].filter((k) => k !== kw);
              btn.remove();
            };
            container.appendChild(btn);
          }
        });
      }

      function toggleCheck(id) {
        const item = studentHistory.find((i) => i.id === id);
        if (item) item.checked = !item.checked;
        renderHistory();
        updateMainSummary();
      }
      function checkAll(state) {
        studentHistory.forEach((h) => (h.checked = state));
        renderHistory();
        updateMainSummary();
      }
      function deleteHistory(id) {
        if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        studentHistory = studentHistory.filter((i) => i.id !== id);
        evalConflicts();
        renderHistory();
        updateMainSummary();
      }

      function updateMainSummary() {
        const active = studentHistory.filter((h) => h.checked);
        let text = "[ìƒì„± ëŒ€ê¸° ëª©ë¡]\n\n";
        active.reverse().forEach((h, i) => {
          let emoji =
            h.type === "edu"
              ? "[êµìœ¡]"
              : h.type === "council"
              ? "[ìì¹˜]"
              : "[í–‰ì‚¬]";
          let dTitle = h.type === "edu" ? h.title + " ì˜ˆë°©êµìœ¡" : h.title;
          text += `${i + 1}. ${emoji} ${dTitle}\n   : ${h.keywords.join(
            ", "
          )}\n\n`;
        });
        document.getElementById("rawDataDisplay").value = active.length
          ? text
          : "ì²´í¬ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.";
      }

      /* --- [í•µì‹¬] ì£¼ì–´ ë°˜ë³µ ë°©ì§€ ë° ìˆ˜í•™ì  ë°°ì—´ í•©ì„±ì„ í†µí•œ ì™„ë²½í•œ ë¬¸ë²• --- */
      function generateAutonomyAI() {
        const targets = studentHistory.filter((h) => h.checked);
        if (!targets.length) return alert("ìƒì„±í•  í™œë™ì„ ì„ íƒí•˜ì„¸ìš”.");

        let result = "";
        let actsNames = [];
        let actsIds = [];

        // 1. ì£¼ ì—­í•  ì°¾ê¸° (ìµœì´ˆ 1íšŒë§Œ ì–¸ê¸‰)
        let mainRole = "member";
        const councilActivity = targets.find(
          (h) => h.type === "council" && h.roleKey !== "member"
        );
        if (councilActivity) mainRole = councilActivity.roleKey;

        result += ROLE_INTROS[mainRole] + " ";

        targets.forEach((h) => {
          // DBì—ì„œ ë¬¸êµ¬ ì¶”ì¶œ (ëª¨ë‘ ëì´ '~ê³ ,', '~ë©°,' ë¡œ ëë‚¨)
          let phrases = h.keywords.map((kw) => {
            let dict =
              DB[h.type][h.title.replace(" ì˜ˆë°©êµìœ¡", "")] ||
              DB[h.type]["ìì¹˜í™œë™"];
            return dict && dict[kw] ? dict[kw] : `${kw} ì—­ëŸ‰ì„ ê¸°ë¥´ë©°,`;
          });

          // ë§ˆì§€ë§‰ í‚¤ì›Œë“œì˜ ì½¤ë§ˆ ì œê±°
          if (phrases.length > 0) {
            phrases[phrases.length - 1] = phrases[phrases.length - 1].replace(
              /,\s*$/,
              ""
            );
          }

          let joinedPhrases = phrases.join(" ");
          let dTitle = h.type === "edu" ? h.title + " ì˜ˆë°©êµìœ¡" : h.title;

          if (h.type === "edu") {
            result += `${dTitle}ì— ì ê·¹ ì°¸ì—¬í•˜ì—¬ ${joinedPhrases} ì˜¬ë°”ë¥¸ ê°€ì¹˜ê´€ì„ í™•ë¦½í•¨. `;
          } else if (h.type === "council") {
            if (h.roleKey === mainRole)
              result += `${joinedPhrases} í•™ê¸‰ ë°œì „ì— í¬ê²Œ ì´ë°”ì§€í•¨. `; // ì£¼ì–´ ìƒëµ
            else
              result += `${
                ROLE_LABELS[h.roleKey]
              } ì—­í• ë„ ë§¡ì•„ ${joinedPhrases} ìì¹˜ ì—­ëŸ‰ì„ ë°œíœ˜í•¨. `;
          } else if (h.type === "event") {
            result += `${dTitle} í–‰ì‚¬ì— ì£¼ë„ì ìœ¼ë¡œ ì°¸ì—¬í•˜ì—¬ ${joinedPhrases} í•™êµìƒí™œì— í™œë ¥ì„ ë”í•¨. `;
          }

          actsNames.push(dTitle);
          actsIds.push(h.id);
        });

        document.getElementById("tempDraft").value = result.trim();
        tempContext = {
          title: actsNames[0] + (actsNames.length > 1 ? " ì™¸" : ""),
          acts: actsNames,
          ids: actsIds,
          len: result.length,
        };
        showToast("AI ë¬¸ì¥ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      /* --- [2ë‹¨ê³„ ë°©ì–´] ID ê¸°ë°˜ ë”¥ ì¶”ì  --- */
      function updateDuplicateStatus() {
        let actCounts = {};
        finalHistory.forEach((item) => {
          if (item.status === "active") {
            item.acts.forEach((act) => {
              actCounts[act] = (actCounts[act] || 0) + 1;
            });
          }
        });
        finalHistory.forEach((item) => {
          if (item.status === "active") {
            let dupActs = item.acts.filter((act) => actCounts[act] > 1);
            item.isDuplicate = dupActs.length > 0;
            item.dupNames = dupActs;
          } else {
            item.isDuplicate = false;
            item.dupNames = [];
          }
        });
      }

      function moveToFinal() {
        const text = document.getElementById("tempDraft").value;
        const preview = document.getElementById("finalPreview");
        if (!text || !tempContext) return alert("ìƒì„±ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.");

        let duplicateActs = [];
        tempContext.ids.forEach((id, index) => {
          if (
            finalHistory.some(
              (fh) => fh.ids && fh.ids.includes(id) && fh.status === "active"
            )
          ) {
            duplicateActs.push(tempContext.acts[index]);
          }
        });
        let isDuplicate = duplicateActs.length > 0;

        if (preview.innerText.trim() === "") preview.innerText = "";
        else preview.appendChild(document.createTextNode(" "));

        const uniqueId = "block_" + Date.now();
        const span = document.createElement("span");
        span.className = "sentence-block";
        span.id = uniqueId;
        span.innerText = text;
        preview.appendChild(span);

        finalHistory.push({
          id: uniqueId,
          title: tempContext.title,
          acts: tempContext.acts,
          ids: tempContext.ids,
          len: text.length,
          status: "active",
          isDuplicate: isDuplicate,
          dupNames: duplicateActs,
        });

        updateDuplicateStatus();
        renderInfoLayer();
        updateByte();
        if (isDuplicate)
          showToast(`âš ï¸ ì¤‘ë³µ: ì´ë¯¸ ì‘ì„±ëœ í™œë™ì´ í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }

      function renderInfoLayer() {
        const con = document.getElementById("infoContentContainer");
        con.innerHTML = "";
        if (finalHistory.length === 0) {
          con.innerHTML = "ìƒì„± ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        finalHistory.forEach((item) => {
          const div = document.createElement("div");
          div.className = `info-card ${item.status} ${
            item.isDuplicate ? "duplicate" : ""
          }`;
          div.onclick = () => highlightSentence(item.id);

          let delBtn = `<button class="delete-sentence-btn" onclick="deleteFinalSentence(event, '${item.id}')">ğŸ—‘ï¸ ë¬¸ì¥ ì‚­ì œ</button>`;
          let dupAlert = item.isDuplicate
            ? `<span class="dup-badge" style="margin-left:8px;" title="${item.dupNames.join(
                ", "
              )} ì¤‘ë³µ">âš ï¸ ì¤‘ë³µ ê°ì§€</span>`
            : "";
          let statBadge =
            item.status === "active"
              ? ""
              : item.status === "deleted"
              ? "<span class='status-badge' style='background:#ef4444;'>âŒ ì‚­ì œë¨</span>"
              : "<span class='status-badge'>âœ… ì§ì ‘ ìˆ˜ì •í•¨ (ì•ˆì „)</span>";

          div.innerHTML = `
            <div class="info-header">
                <span style="display:flex; align-items:center;">ğŸ“ ${
                  item.title
                } ${dupAlert}</span>
                ${delBtn}
            </div>
            ${
              item.status !== "active"
                ? `<div style="margin-bottom:4px;">${statBadge}</div>`
                : ""
            }
            <div class="info-tags">${item.acts
              .map((a) => `<span class="tag">${a}</span>`)
              .join("")}</div>`;
          con.appendChild(div);
        });
      }

      function highlightSentence(id) {
        document
          .querySelectorAll(".sentence-block")
          .forEach((el) => el.classList.remove("highlight-active"));
        const target = document.getElementById(id);
        if (target) {
          target.scrollIntoView({ behavior: "smooth", block: "center" });
          target.classList.add("highlight-active");
          setTimeout(() => {
            target.classList.remove("highlight-active");
          }, 2000);
        }
      }

      /* [ì˜¤ë¥˜ í•´ê²° 3] ìŠ¤í˜ì´ìŠ¤ë°” ì°Œêº¼ê¸° ì¶”ì  ì‚­ì œ */
      function deleteFinalSentence(event, id) {
        event.stopPropagation();
        const target = document.getElementById(id);
        if (target) {
          if (target.previousSibling && target.previousSibling.nodeType === 3)
            target.previousSibling.remove();
          target.remove();
        }
        finalHistory = finalHistory.filter((item) => item.id !== id);
        updateDuplicateStatus();
        renderInfoLayer();
        updateByte();
        showToast("ë¬¸ì¥ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      function checkIntegrity() {
        let change = false;
        finalHistory.forEach((item) => {
          const el = document.getElementById(item.id);
          if (!el) {
            if (item.status !== "deleted") {
              item.status = "deleted";
              change = true;
            }
          } else if (el.innerText.length < item.len * 0.8) {
            if (item.status !== "modified") {
              item.status = "modified";
              change = true;
            }
          } else {
            if (item.status !== "active") {
              item.status = "active";
              change = true;
            }
          }
        });
        updateDuplicateStatus();
        renderInfoLayer();
        showToast(
          change
            ? "ë³€ê²½ì‚¬í•­ì´ ìš”ì•½ì°½ì— ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
            : "ë¬¸ì¥ ë³€ë™ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        );
      }

      function clearFinal() {
        if (confirm("ì „ì²´ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          document.getElementById("finalPreview").innerText = "";
          finalHistory = [];
          renderInfoLayer();
          updateByte();
        }
      }
      function updateByte() {
        const text = document.getElementById("finalPreview").innerText;
        let bytes = 0;
        for (let i = 0; i < text.length; i++)
          bytes += text.charCodeAt(i) > 127 ? 3 : 1;
        document.getElementById("byteCount").innerText = bytes;
        document.getElementById("byteCount").style.color =
          bytes > 1500 ? "red" : "#1f4ddc";
      }
      function finalApply() {
        alert("NEIS ì…ë ¥ ì™„ë£Œ");
      }
      function showToast(m) {
        const t = document.getElementById("toast");
        t.textContent = m;
        t.style.opacity = 1;
        setTimeout(() => (t.style.opacity = 0), 2000);
      }
    </script>
  </body>
</html>
