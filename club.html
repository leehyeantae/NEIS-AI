<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ë™ì•„ë¦¬í™œë™ ê´€ë¦¬</title>
    <style>
      /* [ê¸°ì¡´ ë””ìì¸ ë° ìŠ¤íƒ€ì¼ 100% ìœ ì§€] */
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", -apple-system, sans-serif;
        background: #f5f6f8;
        color: #333;
      }
      .topbar {
        height: 48px;
        background: #f5c6cf;
        display: flex;
        align-items: center;
        padding: 0 16px;
        font-weight: 700;
        border-bottom: 1px solid #e5adba;
        color: #333;
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        height: calc(100vh - 48px);
      }
      .left,
      .right {
        padding: 25px;
        overflow-y: auto;
        background: #fff;
      }
      .left {
        border-right: 1px solid #e5e7eb;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .section-title {
        font-size: 18px;
        font-weight: 700;
        color: #1f2937;
      }

      .form-group {
        margin-bottom: 20px;
        position: relative;
      }
      .label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #4b5563;
      }
      .input,
      .textarea,
      .select {
        width: 100%;
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: border 0.2s;
        background: #fff;
      }
      .input:focus,
      .textarea:focus,
      .select:focus {
        outline: none;
        border-color: #1f4ddc;
        box-shadow: 0 0 0 3px rgba(31, 77, 220, 0.1);
      }
      .textarea {
        min-height: 150px;
        line-height: 1.6;
        resize: vertical;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .btn {
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid #d1d5db;
        background: #fff;
        transition: 0.2s;
        color: #374151;
      }
      .btn:hover {
        background: #f9fafb;
        border-color: #9ca3af;
      }
      .btn.primary {
        background: #1f4ddc;
        color: #fff;
        border-color: #163aa5;
      }
      .btn.success {
        background: #10b981;
        color: #fff;
        border-color: #059669;
      }
      .btn.accent {
        background: #f59e0b;
        color: #fff;
        border-color: #d97706;
      }
      .btn.sm {
        padding: 5px 10px;
        font-size: 12px;
      }

      .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-top: none;
        border-radius: 0 0 8px 8px;
        z-index: 100;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: none;
      }
      .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        font-size: 14px;
      }
      .autocomplete-item:hover {
        background: #f3f4f6;
        color: #1f4ddc;
      }
      .autocomplete-item.selected {
        background: #eff6ff;
        color: #1f4ddc;
        font-weight: 600;
      }

      .preview-box {
        width: 100%;
        height: 500px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 25px;
        font-size: 15px;
        line-height: 1.8;
        white-space: pre-wrap;
        outline: none;
        background: #fff;
      }
      .counter {
        text-align: right;
        margin-top: 10px;
        font-size: 13px;
        color: #6b7280;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 950px;
        height: 750px;
        background: #fff;
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }
      .modal-header {
        padding: 18px 25px;
        background: #f9fafb;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 16px 16px 0 0;
      }
      .modal-body {
        display: grid;
        grid-template-columns: 240px 1fr;
        flex: 1;
        overflow: hidden;
      }

      .student-list-header {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        background: #f1f5f9;
        font-weight: 600;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .student-list {
        background: #f8fafc;
        border-right: 1px solid #eee;
        overflow-y: auto;
      }
      .student-item {
        padding: 12px 15px;
        border-bottom: 1px solid #f1f5f9;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: default;
      }
      .student-item:hover {
        background: #fff;
      }
      .student-name-span {
        cursor: pointer;
        flex: 1;
        padding: 4px;
        border-radius: 4px;
      }
      .student-name-span:hover {
        color: #1f4ddc;
        font-weight: 600;
        background: #eff6ff;
      }
      .student-name-span.active {
        color: #fff;
        background: #1f4ddc;
        font-weight: 600;
      }

      .log-entry {
        padding: 25px;
        overflow-y: auto;
      }
      .history-item {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .history-content {
        font-size: 13.5px;
        line-height: 1.4;
        color: #374151;
      }
      .history-date {
        font-weight: 700;
        color: #1f4ddc;
        margin-right: 6px;
        font-size: 12px;
        background: #eff6ff;
        padding: 2px 6px;
        border-radius: 4px;
      }

      .tag-category {
        font-size: 11px;
        background: #e0e7ff;
        color: #3730a3;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        margin-right: 4px;
      }
      .tag-level {
        font-size: 11px;
        background: #dcfce7;
        color: #166534;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        margin-right: 4px;
      }

      #toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 13px;
        opacity: 0;
        transition: 0.3s;
        pointer-events: none;
        z-index: 2000;
      }
      /* --- ëª¨ë°”ì¼ ì „ìš© ìŠ¤íƒ€ì¼ (í™”ë©´ í­ì´ 768px ì´í•˜ì¼ ë•Œ ì ìš©) --- */
@media (max-width: 768px) {
  
  /* 1. ì „ì²´ ì»¨í…Œì´ë„ˆ í¬ê¸° ì œí•œ í•´ì œ */
  body, .app, .container {
    width: 100% !important;
    height: auto !important;
    min-height: 100vh;
    display: block !important; /* Gridë‚˜ Flexë¥¼ í’€ê³  ë¸”ë¡ìœ¼ë¡œ ë³€ê²½ */
    overflow-y: auto !important; /* ì „ì²´ ìŠ¤í¬ë¡¤ í—ˆìš© */
  }

  /* 2. ì¢Œìš° ë¶„í• ì„ ìƒí•˜ ë°°ì¹˜ë¡œ ë³€ê²½ */
  .container {
    grid-template-columns: 1fr !important; /* 1ì—´ë¡œ ë³€ê²½ */
  }

  /* 3. ì¢Œì¸¡/ìš°ì¸¡ íŒ¨ë„ ìŠ¤íƒ€ì¼ ì¡°ì • */
  .left, .right, .left-panel, .right-panel {
    width: 100% !important;
    height: auto !important;
    border-right: none !important;
    border-bottom: 1px solid #e5e7eb;
    padding: 15px !important;
    overflow: visible !important; /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì—†ì• ê³  ì „ì²´ ìŠ¤í¬ë¡¤ë¡œ */
  }

  /* 4. ëª¨ë‹¬ì°½(íŒì—…) ëª¨ë°”ì¼ ìµœì í™” */
  .modal-content {
    width: 95% !important; /* í™”ë©´ ê½‰ ì°¨ê²Œ */
    height: 90vh !important; /* ë†’ì´ë„ ì ë‹¹íˆ */
    top: 50% !important;
    left: 50% !important;
  }
  
  .modal-body {
    grid-template-columns: 1fr !important; /* ì¢Œìš° ë¶„í•  ì œê±° */
    display: flex !important;
    flex-direction: column;
  }

  /* 5. í•™ìƒ ëª©ë¡ ë“± ë‚´ë¶€ ë¦¬ìŠ¤íŠ¸ ë†’ì´ ì œí•œ */
  .student-list {
    height: 150px !important; /* ëª©ë¡ì€ ì§§ê²Œ */
    border-right: none !important;
    border-bottom: 1px solid #eee;
    overflow-y: auto !important;
  }

  /* 6. í°íŠ¸ ë° ë²„íŠ¼ í¬ê¸° ì¡°ì • (í„°ì¹˜í•˜ê¸° ì¢‹ê²Œ) */
  .btn {
    padding: 12px 15px !important; /* ë²„íŠ¼ ë” í¬ê²Œ */
    font-size: 14px !important;
  }
  
  input, select, textarea {
    font-size: 16px !important; /* ì•„ì´í°ì—ì„œ ì…ë ¥ ì‹œ ì¤Œì¸ ë°©ì§€ */
  }
}
    </style>
  </head>
  <body>
    <div id="toast">ì•Œë¦¼</div>
    <div class="topbar">ë™ì•„ë¦¬í™œë™ ê´€ë¦¬ ì‹œìŠ¤í…œ</div>

    <div class="container">
      <section class="left">
        <div class="section-header">
          <div class="section-title">í•™ìƒí™œë™ êµ¬ì„±</div>
          <button class="btn accent" onclick="openModal()">
            ğŸ“… ëˆ„ê°€ê¸°ë¡ í†µí•© ê´€ë¦¬
          </button>
        </div>

        <div class="form-group">
          <label class="label">ëŒ€ìƒ í•™ìƒ ê²€ìƒ‰</label>
          <input
            type="text"
            class="input"
            id="studentSearch"
            placeholder="í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ë°©í–¥í‚¤/ì—”í„° ì‚¬ìš©)"
            autocomplete="off"
          />
          <div id="autocompleteList" class="autocomplete-results"></div>
          <div class="btn-group">
            <button class="btn" onclick="fetchLogs()">
              ğŸ”„ ëˆ„ê°€ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            </button>
          </div>
        </div>

        <div class="form-group">
          <label class="label">í™œë™ ìš”ì•½ ë° ë°ì´í„°</label>
          <textarea
            id="activityInput"
            class="textarea"
            placeholder="í•™ìƒì„ ê²€ìƒ‰í•˜ê±°ë‚˜ ëˆ„ê°€ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ë©´ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."
          ></textarea>
        </div>

        <div style="text-align: center; margin: 30px 0">
          <button
            class="btn primary"
            style="width: 220px; height: 48px; font-size: 15px"
            onclick="generateAI()"
          >
            âœ¨ AI ë¬¸ì¥ ìƒì„±í•˜ê¸°
          </button>
        </div>

        <div class="form-group">
          <label class="label">AI ì¶”ì²œ ì´ˆì•ˆ (ìˆ˜ì • ê°€ëŠ¥)</label>
          <textarea
            id="tempDraft"
            class="textarea"
            style="background: #fdfbff; border-color: #c7d2fe"
          ></textarea>
          <button
            class="btn success"
            style="width: 100%; margin-top: 10px"
            onclick="applyToRight()"
          >
            ìš°ì¸¡ ê²°ê³¼ì°½ìœ¼ë¡œ ë³´ë‚´ê¸° â†’
          </button>
        </div>
      </section>

      <section class="right">
        <div class="section-header">
          <div class="section-title">ìµœì¢… ê¸°ì¬ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°</div>
          <div class="btn-group">
            <button class="btn" onclick="aiPolish()">âœ¨ ì „ì²´ AI ë‹¤ë“¬ê¸°</button>
            <button class="btn success" onclick="submitFinal()">
              ğŸ’¾ ì ìš©í•˜ê¸°
            </button>
          </div>
        </div>
        <div
          id="finalPreview"
          class="preview-box"
          contenteditable="true"
          oninput="updateCount()"
        >
          ë¨¼ì € ì¢Œì¸¡ì—ì„œ í•™ìƒì„ ê²€ìƒ‰í•˜ê³  í™œë™ ë¬¸ì¥ì„ ìƒì„±í•´ì£¼ì„¸ìš”.
        </div>
        <div class="counter">
          ê¸€ììˆ˜: <span id="charNum" style="font-weight: 700">0</span>ì
          &nbsp;|&nbsp; NEIS ìš©ëŸ‰:
          <span id="byteNum" style="color: #1f4ddc; font-weight: 700">0</span> /
          1500 Byte
        </div>
      </section>
    </div>

    <div id="logModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <div style="font-size: 16px; font-weight: 700">
            ğŸ“… ë™ì•„ë¦¬ ëˆ„ê°€ê¸°ë¡ ë°ì´í„°ë² ì´ìŠ¤
          </div>
          <button class="btn" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
        <div class="modal-body">
          <div
            style="
              display: flex;
              flex-direction: column;
              background: #f8fafc;
              border-right: 1px solid #eee;
            "
          >
            <div class="student-list-header">
              <input
                type="checkbox"
                id="selectAll"
                onchange="toggleAll(this)"
              />
              <label for="selectAll" style="cursor: pointer"
                >ì „ì²´ ì„ íƒ/í•´ì œ</label
              >
            </div>
            <div class="student-list" id="modalStudentList"></div>
          </div>

          <div class="log-entry">
            <div
              id="targetTitle"
              style="
                font-size: 18px;
                font-weight: 700;
                margin-bottom: 20px;
                color: #1f4ddc;
              "
            >
              ì‘ì—… ëŒ€ìƒì„ ì„ íƒí•´ ì£¼ì„¸ìš”
            </div>

            <div
              style="
                background: #f1f5f9;
                padding: 20px;
                border-radius: 12px;
                margin-bottom: 20px;
                border: 1px solid #e2e8f0;
              "
            >
              <div style="display: flex; gap: 10px; margin-bottom: 12px">
                <div style="flex: 1">
                  <label class="label">ë‚ ì§œ</label>
                  <input type="date" id="logDate" class="input" />
                </div>
                <div style="flex: 1.5">
                  <label class="label">í™œë™ ì˜ì—­(ì¹´í…Œê³ ë¦¬)</label>
                  <select id="logCategory" class="select">
                    <option value="ì°¸ì—¬íƒœë„">ì°¸ì—¬íƒœë„</option>
                    <option value="í˜‘ë ¥ì†Œí†µ">í˜‘ë ¥Â·ì†Œí†µ</option>
                    <option value="ì°½ì˜ì„±">ì°½ì˜ì„±</option>
                    <option value="ë¦¬ë”ì‹­">ë¦¬ë”ì‹­</option>
                    <option value="ê³¼ì œìˆ˜í–‰">ê³¼ì œìˆ˜í–‰</option>
                    <option value="ì§„ë¡œì—­ëŸ‰">ì§„ë¡œì—­ëŸ‰</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€ í™œë™</option>
                  </select>
                </div>
                <div style="flex: 1">
                  <label class="label">ì„±ì·¨ ìˆ˜ì¤€</label>
                  <select id="logLevel" class="select">
                    <option value="ë§¤ìš°ìš°ìˆ˜">ë§¤ìš°ìš°ìˆ˜</option>
                    <option value="ìš°ìˆ˜">ìš°ìˆ˜</option>
                    <option value="ë³´í†µ">ë³´í†µ</option>
                    <option value="ë…¸ë ¥">ë…¸ë ¥</option>
                  </select>
                </div>
              </div>

              <div style="margin-bottom: 15px">
                <label class="label">êµ¬ì²´ì  í™œë™ ë‚´ìš©</label>
                <input
                  type="text"
                  id="logContent"
                  class="input"
                  placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ì¹´í…Œê³ ë¦¬ì— ë§ëŠ” ë¬¸ì¥ì´ ìë™ ìƒì„±ë©ë‹ˆë‹¤."
                />
              </div>

              <div style="text-align: right">
                <button class="btn primary" onclick="saveBatchLogs()">
                  ğŸ’¾ ì„ íƒëœ í•™ìƒ(ë“¤)ì—ê²Œ ì¼ê´„ ì ìš©
                </button>
              </div>
            </div>

            <div style="border-top: 1px solid #eee; padding-top: 20px">
              <div class="label" style="font-size: 14px; margin-bottom: 10px">
                ğŸ•’ ê°œë³„ ì´ë ¥ ê´€ë¦¬ (ì¢Œì¸¡ ëª…ë‹¨ì—ì„œ ì´ë¦„ í´ë¦­)
              </div>
              <div
                id="historyList"
                style="
                  background: #fff;
                  min-height: 100px;
                  max-height: 200px;
                  overflow-y: auto;
                  border: 1px solid #e5e7eb;
                  border-radius: 8px;
                  padding: 15px;
                "
              >
                <span style="color: #9ca3af; font-size: 13px"
                  >ì´ë¦„ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ í•™ìƒì˜ ê¸°ë¡ë§Œ ì¡°íšŒ/ìˆ˜ì •í•  ìˆ˜
                  ìˆìŠµë‹ˆë‹¤.</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const students = ["ì´í˜„íƒœ"];
      let studentLogs = {};
      let viewingStudent = "";
      let logIdCounter = 0;
      let selectedIndex = -1;

      // [ìˆ˜ì •] ì¹´í…Œê³ ë¦¬/ì„±ì·¨ìˆ˜ì¤€ë³„ í…œí”Œë¦¿ (íƒì›” -> ë§¤ìš°ìš°ìˆ˜ ë³€ê²½)
      const CLUB_TEMPLATES = {
        ì°¸ì—¬íƒœë„: {
          ë§¤ìš°ìš°ìˆ˜: "ë§¤ í™œë™ì— ì—´ì •ì ìœ¼ë¡œ ì°¸ì—¬í•˜ë©° ë¶„ìœ„ê¸°ë¥¼ ì£¼ë„í•¨.",
          ìš°ìˆ˜: "í™œë™ì— ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•˜ë©° ì„±ì‹¤í•œ íƒœë„ë¥¼ ë³´ì„.",
          ë³´í†µ: "ì£¼ì–´ì§„ í™œë™ì— ì„±ì‹¤í•˜ê²Œ ì°¸ì—¬í•¨.",
          ë…¸ë ¥: "í™œë™ì— í¥ë¯¸ë¥¼ ê°–ê³  ì°¸ì—¬í•˜ë ¤ ë…¸ë ¥í•¨.",
        },
        í˜‘ë ¥ì†Œí†µ: {
          ë§¤ìš°ìš°ìˆ˜: "íŒ€ì› ê°„ ì˜ê²¬ì„ ì¡°ìœ¨í•˜ë©° ë›°ì–´ë‚œ ì†Œí†µ ëŠ¥ë ¥ì„ ë°œíœ˜í•¨.",
          ìš°ìˆ˜: "ë™ë£Œë“¤ê³¼ ì›ë§Œí•˜ê²Œ í˜‘ë ¥í•˜ë©° ê³¼ì œë¥¼ ìˆ˜í–‰í•¨.",
          ë³´í†µ: "íŒ€ í™œë™ì—ì„œ ìì‹ ì˜ ì—­í• ì„ ë¬´ë‚œíˆ ìˆ˜í–‰í•¨.",
          ë…¸ë ¥: "ë™ë£Œë“¤ê³¼ í˜‘ë ¥í•˜ë ¤ëŠ” ìì„¸ê°€ ê¸ì •ì ì„.",
        },
        ì°½ì˜ì„±: {
          ë§¤ìš°ìš°ìˆ˜: "ê¸°ì¡´ê³¼ ë‹¤ë¥¸ ì°¸ì‹ í•œ ì•„ì´ë””ì–´ë¥¼ ì œì‹œí•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•¨.",
          ìš°ìˆ˜: "ë‹¤ì–‘í•œ ê´€ì ì—ì„œ ì ‘ê·¼í•˜ì—¬ ì°½ì˜ì ì¸ ê²°ê³¼ë¬¼ì„ ë§Œë“¦.",
          ë³´í†µ: "ìƒˆë¡œìš´ ë°©ë²•ì„ ì‹œë„í•˜ë ¤ëŠ” ëª¨ìŠµì´ ë³´ì„.",
          ë…¸ë ¥: "ìì‹ ì˜ ìƒê°ì„ í‘œí˜„í•˜ë ¤ ë…¸ë ¥í•¨.",
        },
        ë¦¬ë”ì‹­: {
          ë§¤ìš°ìš°ìˆ˜: "íƒì›”í•œ ë¦¬ë”ì‹­ìœ¼ë¡œ ë¶€ì›ë“¤ì„ ì´ëŒë©° ëª©í‘œë¥¼ ë‹¬ì„±í•¨.",
          ìš°ìˆ˜: "íŒ€ì¥ ì—­í• ì„ ë§¡ì•„ ë¶€ì›ë“¤ì„ ì˜ ë…ë ¤í•¨.",
          ë³´í†µ: "í•„ìš”ì‹œ ë¦¬ë”ì‹­ì„ ë°œíœ˜í•˜ì—¬ íŒ€ì„ ë„ì›€.",
          ë…¸ë ¥: "ìì‹ ì´ ë§¡ì€ ì—­í• ì— ì±…ì„ê°ì„ ê°€ì§.",
        },
        ê³¼ì œìˆ˜í–‰: {
          ë§¤ìš°ìš°ìˆ˜: "ì™„ì„±ë„ ë†’ì€ ê²°ê³¼ë¬¼ì„ ì‚°ì¶œí•˜ë©° ë›°ì–´ë‚œ ìˆ˜í–‰ë ¥ì„ ë³´ì„.",
          ìš°ìˆ˜: "ì£¼ì–´ì§„ ê³¼ì œë¥¼ ê¸°í•œ ë‚´ì— ì¶©ì‹¤íˆ ì™„ì„±í•¨.",
          ë³´í†µ: "ê³¼ì œ ìˆ˜í–‰ ê³¼ì •ì„ ì„±ì‹¤íˆ ì´í–‰í•¨.",
          ë…¸ë ¥: "ê³¼ì œë¥¼ ëê¹Œì§€ ì™„ìˆ˜í•˜ë ¤ ë…¸ë ¥í•¨.",
        },
        ì§„ë¡œì—­ëŸ‰: {
          ë§¤ìš°ìš°ìˆ˜: "ë™ì•„ë¦¬ í™œë™ì„ ìì‹ ì˜ ì§„ë¡œì™€ ì—°ê³„í•˜ì—¬ ì‹¬í™” íƒêµ¬í•¨.",
          ìš°ìˆ˜: "ê´€ì‹¬ ë¶„ì•¼ì— ëŒ€í•œ ì§€ì‹ì„ ë„“íˆë©° ì§„ë¡œë¥¼ êµ¬ì²´í™”í•¨.",
          ë³´í†µ: "ì§„ë¡œì™€ ê´€ë ¨ëœ í™œë™ì— ê´€ì‹¬ì„ ê°–ê³  ì°¸ì—¬í•¨.",
          ë…¸ë ¥: "ìì‹ ì˜ ì ì„±ì„ íƒìƒ‰í•˜ëŠ” ê¸°íšŒë¡œ ì‚¼ìŒ.",
        },
        ê¸°íƒ€: { ë§¤ìš°ìš°ìˆ˜: "", ìš°ìˆ˜: "", ë³´í†µ: "", ë…¸ë ¥: "" },
      };

      window.onload = () => {
        students.sort().forEach((name) => (studentLogs[name] = []));
        initModalList();
        document.getElementById("logDate").value = new Date()
          .toISOString()
          .split("T")[0];
      };

      function showToast(msg) {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.style.opacity = 1;
        setTimeout(() => (t.style.opacity = 0), 2000);
      }

      const searchInput = document.getElementById("studentSearch");
      const autoList = document.getElementById("autocompleteList");

      searchInput.addEventListener("input", function () {
        const val = this.value.trim();
        autoList.innerHTML = "";
        selectedIndex = -1;
        if (!val) {
          autoList.style.display = "none";
          return;
        }

        const filtered = students.filter((s) => s.includes(val));
        if (filtered.length > 0) {
          filtered.forEach((name, idx) => {
            const item = document.createElement("div");
            item.className = "autocomplete-item";
            item.textContent = name;
            item.onclick = () => selectStudent(name);
            autoList.appendChild(item);
          });
          autoList.style.display = "block";
        } else {
          autoList.style.display = "none";
        }
      });

      searchInput.addEventListener("keydown", function (e) {
        const items = autoList.getElementsByClassName("autocomplete-item");
        if (items.length === 0) return;

        if (e.key === "ArrowDown") {
          e.preventDefault();
          selectedIndex++;
          if (selectedIndex >= items.length) selectedIndex = 0;
          updateSelection(items);
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          selectedIndex--;
          if (selectedIndex < 0) selectedIndex = items.length - 1;
          updateSelection(items);
        } else if (e.key === "Enter") {
          e.preventDefault();
          if (selectedIndex > -1) items[selectedIndex].click();
          else if (items.length > 0) items[0].click();
        }
      });

      function updateSelection(items) {
        Array.from(items).forEach((item, idx) => {
          if (idx === selectedIndex) {
            item.classList.add("selected");
            item.scrollIntoView({ block: "nearest" });
          } else {
            item.classList.remove("selected");
          }
        });
      }

      function selectStudent(name) {
        searchInput.value = name;
        autoList.style.display = "none";
        fetchLogs();
      }

      document.addEventListener("click", (e) => {
        if (e.target !== searchInput) autoList.style.display = "none";
      });

      function fetchLogs() {
        const name = searchInput.value.trim();
        if (!name || !students.includes(name))
          return alert("í•™ìƒì„ ì˜¬ë°”ë¥´ê²Œ ì„ íƒí•´ì£¼ì„¸ìš”.");
        const logs = studentLogs[name];
        if (logs.length === 0) {
          document.getElementById("activityInput").value = "";
          alert("ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ëˆ„ê°€ê¸°ë¡ ê´€ë¦¬ì—ì„œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }
        logs.sort((a, b) => a.date.localeCompare(b.date));

        const summary = logs.map((l) => `[${l.date}] ${l.fullText}`).join("\n");
        document.getElementById("activityInput").value = summary;
        showToast("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
      }

      function generateAI() {
        const input = document.getElementById("activityInput").value;
        if (!input) return alert("ë°ì´í„°ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.");
        const name = searchInput.value;

        const cleanContent = input.replace(/\[\d{4}-\d{2}-\d{2}\]/g, "").trim();

        document.getElementById(
          "tempDraft"
        ).value = `${name} í•™ìƒì€ ë™ì•„ë¦¬ í™œë™ì—ì„œ ${cleanContent.substring(
          0,
          50
        )}... ë“±ì˜ í™œë™ì„ í†µí•´ ìì‹ ì˜ ì—­ëŸ‰ì„ ê¾¸ì¤€íˆ ë°œì „ì‹œí‚´.`;
      }

      function applyToRight() {
        const draft = document.getElementById("tempDraft").value;
        const preview = document.getElementById("finalPreview");
        if (preview.innerText.includes("ë¨¼ì € ì¢Œì¸¡ì—ì„œ")) preview.innerText = "";
        preview.innerText = preview.innerText
          ? preview.innerText + "\n\n" + draft
          : draft;
        updateCount();
      }

      function updateCount() {
        const text = document.getElementById("finalPreview").innerText;
        document.getElementById("charNum").innerText = text.length;
        let bytes = 0;
        for (let i = 0; i < text.length; i++) {
          bytes += text.charCodeAt(i) > 127 ? 3 : 1;
        }
        const byteSpan = document.getElementById("byteNum");
        byteSpan.innerText = bytes;
        byteSpan.style.color = bytes > 1500 ? "red" : "#1f4ddc";
      }

      function aiPolish() {
        showToast("ë¬¸ë§¥ì„ ë‹¤ë“¬ëŠ” ì¤‘...");
      }
      function submitFinal() {
        alert("ì‘ì„±ëœ ë‚´ìš©ì„ NEISì— ì…ë ¥í•©ë‹ˆë‹¤.");
      }

      // --- ëª¨ë‹¬ ë¡œì§ ---
      function openModal() {
        document.getElementById("logModal").style.display = "block";
      }
      function closeModal() {
        document.getElementById("logModal").style.display = "none";
      }

      function initModalList() {
        const list = document.getElementById("modalStudentList");
        list.innerHTML = "";
        students.forEach((name) => {
          const div = document.createElement("div");
          div.className = "student-item";
          div.innerHTML = `
            <input type="checkbox" class="stu-chk" value="${name}" style="margin-right:10px; transform:scale(1.2);">
            <span class="student-name-span" onclick="viewHistory('${name}')">${name}</span>
          `;
          list.appendChild(div);
        });
      }

      function toggleAll(source) {
        const checkboxes = document.querySelectorAll(".stu-chk");
        checkboxes.forEach((cb) => (cb.checked = source.checked));
        updateTitle();
      }

      document
        .getElementById("modalStudentList")
        .addEventListener("change", updateTitle);

      function updateTitle() {
        const checkedCount =
          document.querySelectorAll(".stu-chk:checked").length;
        const title = document.getElementById("targetTitle");
        if (checkedCount > 0)
          title.textContent = `${checkedCount}ëª…ì˜ í•™ìƒì´ ì„ íƒë¨`;
        else if (viewingStudent)
          title.textContent = `[${viewingStudent}] í•™ìƒ ê¸°ë¡ ê´€ë¦¬`;
        else title.textContent = "ì‘ì—… ëŒ€ìƒì„ ì„ íƒí•´ ì£¼ì„¸ìš”";
      }

      // [í•µì‹¬ ìˆ˜ì •] ë‚´ìš© ì—†ì´ë„ ì €ì¥ ê°€ëŠ¥í•˜ë„ë¡ ë¡œì§ ë³€ê²½
      function saveBatchLogs() {
        const checked = document.querySelectorAll(".stu-chk:checked");
        if (checked.length === 0)
          return alert("ì ìš©í•  í•™ìƒì„ ì²´í¬ë°•ìŠ¤ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.");

        const date = document.getElementById("logDate").value;
        const cat = document.getElementById("logCategory").value;
        const level = document.getElementById("logLevel").value;
        const content = document.getElementById("logContent").value.trim();

        // í…œí”Œë¦¿ ë¬¸êµ¬ ê°€ì ¸ì˜¤ê¸°
        let templatePhrase = "";
        if (cat !== "ê¸°íƒ€") {
          templatePhrase = CLUB_TEMPLATES[cat][level] || "";
        }

        // [ìˆ˜ì •] ë‘˜ ë‹¤ ì—†ëŠ” ê²½ìš°ì—ë§Œ ê²½ê³ 
        if (!content && !templatePhrase) {
          return alert(
            "í™œë™ ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜, ìœ íš¨í•œ ì¹´í…Œê³ ë¦¬/ì„±ì·¨ìˆ˜ì¤€ì„ ì„ íƒí•´ì£¼ì„¸ìš”."
          );
        }

        // ìµœì¢… ì €ì¥ ë¬¸êµ¬ ì¡°í•© (ë‚´ìš© + í…œí”Œë¦¿)
        let fullText = "";
        if (content) {
          fullText = content;
          if (!fullText.endsWith(".")) fullText += ".";
          if (templatePhrase) fullText += " " + templatePhrase;
        } else {
          // ë‚´ìš©ì´ ì—†ìœ¼ë©´ í…œí”Œë¦¿ë§Œ ì €ì¥
          fullText = templatePhrase;
        }

        checked.forEach((cb) => {
          const name = cb.value;
          studentLogs[name].push({
            id: logIdCounter++,
            date: date,
            cat: cat,
            level: level,
            content: content,
            fullText: fullText,
          });
        });

        showToast(`${checked.length}ëª…ì—ê²Œ ê¸°ë¡ì´ ì¼ê´„ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        document.getElementById("logContent").value = "";
        if (viewingStudent) renderHistory(viewingStudent);
      }

      function viewHistory(name) {
        viewingStudent = name;
        updateTitle();
        document
          .querySelectorAll(".student-name-span")
          .forEach((el) => el.classList.remove("active"));
        const spans = document.querySelectorAll(".student-name-span");
        for (let s of spans) {
          if (s.textContent === name) s.classList.add("active");
        }
        renderHistory(name);
      }

      function renderHistory(name) {
        const container = document.getElementById("historyList");
        const logs = studentLogs[name];

        if (!logs || logs.length === 0) {
          container.innerHTML = `<div style="color:#9ca3af; text-align:center; padding:20px;">[${name}] í•™ìƒì˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
          return;
        }

        let html = `<div style="font-weight:bold; margin-bottom:10px; color:#1f4ddc;">[${name}]ë‹˜ì˜ ê¸°ë¡ ë‚´ì—­</div>`;

        logs
          .sort((a, b) => b.date.localeCompare(a.date))
          .forEach((log) => {
            const catTag = `<span class="tag-category">${log.cat}</span>`;
            const levelTag = `<span class="tag-level">${log.level}</span>`;

            html += `
            <div class="history-item">
              <div class="history-content">
                <span class="history-date">${log.date}</span>
                ${catTag}${levelTag}
                <br/>
                <span style="display:inline-block; margin-top:4px;">${log.fullText}</span>
              </div>
              <div style="display:flex; gap:5px; align-items: flex-start;">
                <button class="btn sm" onclick="editLog('${name}', ${log.id})">ìˆ˜ì •</button>
                <button class="btn sm" style="color:red; border-color:#fee2e2;" onclick="deleteLog('${name}', ${log.id})">ì‚­ì œ</button>
              </div>
            </div>`;
          });
        container.innerHTML = html;
      }

      function deleteLog(name, id) {
        if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        studentLogs[name] = studentLogs[name].filter((l) => l.id !== id);
        renderHistory(name);
      }

      function editLog(name, id) {
        const log = studentLogs[name].find((l) => l.id === id);
        if (!log) return;

        document.getElementById("logDate").value = log.date;
        document.getElementById("logCategory").value = log.cat || "ê¸°íƒ€";
        document.getElementById("logLevel").value = log.level || "ë³´í†µ";
        document.getElementById("logContent").value = log.content;

        studentLogs[name] = studentLogs[name].filter((l) => l.id !== id);
        renderHistory(name);

        const checkboxes = document.querySelectorAll(".stu-chk");
        checkboxes.forEach((cb) => (cb.checked = cb.value === name));
        updateTitle();

        showToast("ìˆ˜ì • ëª¨ë“œ: ë‚´ìš©ì„ ë³€ê²½í•œ ë’¤ [ì¼ê´„ ì ìš©]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
      }
    </script>
  </body>
</html>
