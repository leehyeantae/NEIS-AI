<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ììœ¨Â·ìì¹˜í™œë™ê´€ë¦¬</title>
    <style>
      /* [ê¸°ì¡´ ë””ìì¸ ìœ ì§€] */
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", -apple-system, sans-serif;
        background: #f5f6f8;
        color: #333;
        overflow: hidden;
      }
      .topbar {
        height: 48px;
        background: #f5c6cf;
        display: flex;
        align-items: center;
        padding: 0 16px;
        font-weight: 700;
        border-bottom: 1px solid #e5adba;
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        height: calc(100vh - 48px);
      }
      .left {
        display: flex;
        flex-direction: column;
        padding: 25px;
        border-right: 1px solid #e5e7eb;
        background: #fff;
        gap: 15px;
      }
      .right {
        padding: 25px;
        display: flex;
        flex-direction: column;
        background: #fff;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }
      .section-title {
        font-size: 16px;
        font-weight: 700;
        color: #1f2937;
      }

      .search-container {
        position: relative;
        width: 100%;
      }
      .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-top: none;
        border-radius: 0 0 8px 8px;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .auto-item {
        padding: 10px 15px;
        cursor: pointer;
        font-size: 14px;
      }
      .auto-item.selected {
        background: #eff6ff;
        color: #1f4ddc;
        font-weight: 600;
      }

      .flex-1 {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .flex-2 {
        flex: 2;
        display: flex;
        flex-direction: column;
      }
      .input,
      .textarea,
      .select {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
      }
      .textarea {
        flex: 1;
        resize: none;
        line-height: 1.6;
      }

      .btn {
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid #d1d5db;
        background: #fff;
        transition: 0.2s;
      }
      .btn.primary {
        background: #1f4ddc;
        color: #fff;
        border-color: #163aa5;
      }
      .btn.success {
        background: #10b981;
        color: #fff;
        border-color: #059669;
      }
      .btn.accent {
        background: #f59e0b;
        color: #fff;
        border-color: #d97706;
      }
      .btn.sm {
        padding: 6px 12px;
        font-size: 12px;
      }

      .preview-box {
        flex: 1;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 25px;
        font-size: 15px;
        line-height: 1.8;
        white-space: pre-wrap;
        outline: none;
        background: #fff;
        overflow-y: auto;
      }
      .counter {
        text-align: right;
        margin-top: 10px;
        font-size: 13px;
        color: #6b7280;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
      }
      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 1150px;
        height: 85vh;
        background: #fff;
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .modal-header {
        padding: 18px 25px;
        background: #f9fafb;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-body {
        display: grid;
        grid-template-columns: 240px 1fr;
        flex: 1;
        overflow: hidden;
      }

      .student-list {
        background: #f8fafc;
        border-right: 1px solid #e5e7eb;
        padding: 20px 0;
        overflow-y: auto;
      }
      .student-item {
        padding: 15px 30px;
        cursor: pointer;
        border-bottom: 1px solid #f1f5f9;
        font-size: 15px;
        transition: 0.2s;
      }
      .student-item:hover {
        background: #f1f5f9;
      }
      .student-item.active {
        background: #eff6ff;
        color: #1f4ddc;
        font-weight: 700;
        border-right: 4px solid #1f4ddc;
      }

      .log-entry {
        padding: 30px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      /* íƒ­ ìŠ¤íƒ€ì¼ */
      .tab-menu {
        display: flex;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 20px;
      }
      .tab-btn {
        flex: 1;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        font-weight: 600;
        color: #6b7280;
        transition: 0.2s;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
      }
      .tab-btn:hover {
        background: #f9fafb;
        color: #374151;
      }
      .tab-btn.active {
        color: #1f4ddc;
        border-bottom-color: #1f4ddc;
        background: #fff;
      }

      .tab-content {
        display: none;
        animation: fadeIn 0.3s;
      }
      .tab-content.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .input-group {
        background: #f8fafc;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        margin-bottom: 20px;
      }
      .form-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
      }
      .form-label {
        width: 80px;
        font-weight: 600;
        font-size: 13px;
        color: #4b5563;
      }

      .history-list {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 15px;
        background: #fff;
      }
      .history-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 8px;
        border: 1px solid #eee;
      }
      .history-date {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 4px;
        display: block;
      }
      .history-badge {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 4px;
        background: #e0e7ff;
        color: #3730a3;
        font-weight: 700;
        margin-right: 6px;
      }

      #toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 10px 20px;
        border-radius: 30px;
        font-size: 13px;
        opacity: 0;
        transition: 0.3s;
        z-index: 3000;
        pointer-events: none;
      }
      /* --- ëª¨ë°”ì¼ ì „ìš© ìŠ¤íƒ€ì¼ (í™”ë©´ í­ì´ 768px ì´í•˜ì¼ ë•Œ ì ìš©) --- */
@media (max-width: 768px) {
  
  /* 1. ì „ì²´ ì»¨í…Œì´ë„ˆ í¬ê¸° ì œí•œ í•´ì œ */
  body, .app, .container {
    width: 100% !important;
    height: auto !important;
    min-height: 100vh;
    display: block !important; /* Gridë‚˜ Flexë¥¼ í’€ê³  ë¸”ë¡ìœ¼ë¡œ ë³€ê²½ */
    overflow-y: auto !important; /* ì „ì²´ ìŠ¤í¬ë¡¤ í—ˆìš© */
  }

  /* 2. ì¢Œìš° ë¶„í• ì„ ìƒí•˜ ë°°ì¹˜ë¡œ ë³€ê²½ */
  .container {
    grid-template-columns: 1fr !important; /* 1ì—´ë¡œ ë³€ê²½ */
  }

  /* 3. ì¢Œì¸¡/ìš°ì¸¡ íŒ¨ë„ ìŠ¤íƒ€ì¼ ì¡°ì • */
  .left, .right, .left-panel, .right-panel {
    width: 100% !important;
    height: auto !important;
    border-right: none !important;
    border-bottom: 1px solid #e5e7eb;
    padding: 15px !important;
    overflow: visible !important; /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì—†ì• ê³  ì „ì²´ ìŠ¤í¬ë¡¤ë¡œ */
  }

  /* 4. ëª¨ë‹¬ì°½(íŒì—…) ëª¨ë°”ì¼ ìµœì í™” */
  .modal-content {
    width: 95% !important; /* í™”ë©´ ê½‰ ì°¨ê²Œ */
    height: 90vh !important; /* ë†’ì´ë„ ì ë‹¹íˆ */
    top: 50% !important;
    left: 50% !important;
  }
  
  .modal-body {
    grid-template-columns: 1fr !important; /* ì¢Œìš° ë¶„í•  ì œê±° */
    display: flex !important;
    flex-direction: column;
  }

  /* 5. í•™ìƒ ëª©ë¡ ë“± ë‚´ë¶€ ë¦¬ìŠ¤íŠ¸ ë†’ì´ ì œí•œ */
  .student-list {
    height: 150px !important; /* ëª©ë¡ì€ ì§§ê²Œ */
    border-right: none !important;
    border-bottom: 1px solid #eee;
    overflow-y: auto !important;
  }

  /* 6. í°íŠ¸ ë° ë²„íŠ¼ í¬ê¸° ì¡°ì • (í„°ì¹˜í•˜ê¸° ì¢‹ê²Œ) */
  .btn {
    padding: 12px 15px !important; /* ë²„íŠ¼ ë” í¬ê²Œ */
    font-size: 14px !important;
  }
  
  input, select, textarea {
    font-size: 16px !important; /* ì•„ì´í°ì—ì„œ ì…ë ¥ ì‹œ ì¤Œì¸ ë°©ì§€ */
  }
}
    </style>
  </head>
  <body>
    <div id="toast">ì•Œë¦¼ ë©”ì‹œì§€</div>
    <div class="topbar">ììœ¨Â·ìì¹˜í™œë™ê´€ë¦¬</div>

    <div class="container">
      <section class="left">
        <div class="section-header">
          <div class="section-title">ììœ¨ ë°ì´í„° ë¡œë“œ ë° ìƒì„±</div>
          <button class="btn accent" onclick="openModal()">
            ğŸ“… ìƒì„¸ ê¸°ë¡ ê´€ë¦¬
          </button>
        </div>

        <div class="search-container">
          <input
            type="text"
            class="input"
            id="studentSearch"
            placeholder="í•™ìƒ ì´ë¦„ì„ ê²€ìƒ‰í•˜ì„¸ìš” (ë°©í–¥í‚¤/ì—”í„° ì‚¬ìš©)"
            autocomplete="off"
          />
          <div id="autoList" class="autocomplete-list"></div>
        </div>

        <div class="flex-1">
          <div class="section-header">
            <label class="section-title">ë¶ˆëŸ¬ì˜¨ í™œë™ ìš”ì•½</label>
            <button class="btn sm" onclick="loadMainSummary()">
              ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            </button>
          </div>
          <textarea
            id="rawDataDisplay"
            class="textarea"
            readonly
            placeholder="íŒì—…ì—ì„œ ì €ì¥ëœ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤."
          ></textarea>
        </div>

        <button
          class="btn primary"
          style="height: 48px; font-size: 15px"
          onclick="generateAutoAI()"
        >
          âœ¨ AI ììœ¨ ë¬¸ì¥ ìƒì„±
        </button>

        <div class="flex-2">
          <label
            class="section-title"
            style="margin-bottom: 8px; display: block"
            >AI ìƒì„± ì´ˆì•ˆ (êµì‚¬ ìˆ˜ì •)</label
          >
          <textarea
            id="tempDraft"
            class="textarea"
            style="background: #fdfbff; border-color: #c7d2fe"
          ></textarea>
          <button
            class="btn success"
            style="width: 100%; margin-top: 10px"
            onclick="moveToFinal()"
          >
            ìš°ì¸¡ ê²°ê³¼ì°½ìœ¼ë¡œ ë³´ë‚´ê¸° â†’
          </button>
        </div>
      </section>

      <section class="right">
        <div class="section-header" style="margin-bottom: 15px">
          <div class="section-title">ììœ¨í™œë™ ìµœì¢… ê¸°ì¬ ë‚´ìš©</div>
          <div style="display: flex; gap: 8px">
            <button
              class="btn"
              onclick="alert('AIê°€ ë¬¸ì¥ íë¦„ê³¼ ë§ì¶¤ë²•ì„ ë³´ì •í•©ë‹ˆë‹¤.')"
            >
              ğŸª„ ì „ì²´ AI ë‹¤ë“¬ê¸°
            </button>
            <button class="btn success" onclick="finalApply()">
              ğŸ’¾ ì ìš©í•˜ê¸°
            </button>
          </div>
        </div>
        <div
          id="finalPreview"
          class="preview-box"
          contenteditable="true"
          oninput="updateByte()"
        >
          í•™ìƒì„ ì„ íƒí•˜ê³  ë¬¸ì¥ì„ ìƒì„±í•´ ì£¼ì„¸ìš”.
        </div>
        <div class="counter">
          ê¸€ììˆ˜: <span id="charNum" style="font-weight: 700">0</span>ì
          &nbsp;|&nbsp; NEIS ìš©ëŸ‰:
          <span id="byteNum" style="color: #1f4ddc; font-weight: 700">0</span> /
          1500 Byte
        </div>
      </section>
    </div>

    <div id="logModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span style="font-size: 18px; font-weight: 700; color: #374151"
            >ğŸ“… í•™ìƒë³„ ììœ¨í™œë™ ìƒì„¸ ê¸°ë¡ í†µí•© ê´€ë¦¬</span
          >
          <button class="btn" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
        <div class="modal-body">
          <div class="student-list" id="modalStudentList"></div>
          <div class="log-entry">
            <h3
              id="modalStudentTitle"
              style="
                margin-top: 0;
                margin-bottom: 20px;
                color: #1f4ddc;
                font-size: 22px;
              "
            >
              í•™ìƒì„ ì„ íƒí•´ ì£¼ì„¸ìš”
            </h3>

            <div class="tab-menu">
              <div class="tab-btn active" onclick="switchTab('tab-edu')">
                êµìœ¡ (ì•ˆì „/ì˜ˆë°©)
              </div>
              <div class="tab-btn" onclick="switchTab('tab-gov')">
                ìì¹˜ í™œë™ (ì„ì›)
              </div>
              <div class="tab-btn" onclick="switchTab('tab-event')">
                êµë‚´ í–‰ì‚¬
              </div>
            </div>

            <div id="tab-edu" class="tab-content active">
              <div class="input-group">
                <div class="form-row">
                  <span class="form-label">í™œë™ ë‚ ì§œ</span>
                  <input
                    type="date"
                    id="eduDate"
                    class="input"
                    style="width: 150px"
                  />
                </div>
                <div class="form-row">
                  <span class="form-label">êµìœ¡ ì£¼ì œ</span>
                  <select
                    id="eduTopic"
                    class="select"
                    style="flex: 1"
                    onchange="checkEduInput(this)"
                  >
                    <option value="" disabled selected>
                      ì£¼ì œë¥¼ ì„ íƒí•˜ì„¸ìš”
                    </option>
                    <option>í•™êµí­ë ¥ ì˜ˆë°©êµìœ¡</option>
                    <option>ë§ˆì•½ë¥˜ ì˜¤ë‚¨ìš© ì˜ˆë°©êµìœ¡</option>
                    <option>ìƒëª…ì¡´ì¤‘ ë° ìì‚´ì˜ˆë°© êµìœ¡</option>
                    <option>ì‹¬íì†Œìƒìˆ  ë° ì‘ê¸‰ì²˜ì¹˜ êµìœ¡</option>
                    <option>ì¥ì• ì´í•´ êµìœ¡</option>
                    <option>ì‚¬ì´ë²„ í­ë ¥ ì˜ˆë°©êµìœ¡</option>
                    <option>ì§ì ‘ ì…ë ¥</option>
                  </select>
                  <input
                    type="text"
                    id="eduTopicDirect"
                    class="input"
                    style="flex: 1; display: none"
                    placeholder="ì£¼ì œ ì§ì ‘ ì…ë ¥"
                  />
                </div>
                <div class="form-row">
                  <span class="form-label">ìƒì„¸ ë‚´ìš©</span>
                  <input
                    type="text"
                    id="eduDetail"
                    class="input"
                    style="flex: 1"
                    placeholder="ë¹„ì›Œë‘ë©´ '[ì£¼ì œ]ì— ì„±ì‹¤íˆ ì°¸ì—¬í•¨' ë“±ìœ¼ë¡œ ìë™ ìƒì„±ë©ë‹ˆë‹¤."
                  />
                </div>
                <div style="text-align: right; margin-top: 10px">
                  <button class="btn primary" onclick="addItemToList('êµìœ¡')">
                    + ëª©ë¡ì— ì¶”ê°€
                  </button>
                </div>
              </div>
            </div>

            <div id="tab-gov" class="tab-content">
              <div class="input-group">
                <div class="form-row">
                  <span class="form-label">ì—­í• </span>
                  <select id="govRole" class="select" style="flex: 1">
                    <option value="" disabled selected>ì—­í•  ì„ íƒ</option>
                    <option>í•™ê¸‰ ë°˜ì¥</option>
                    <option>í•™ê¸‰ ë¶€ë°˜ì¥</option>
                    <option>í•™ìƒíšŒì¥</option>
                    <option>í•™ìƒíšŒ ë¶€íšŒì¥</option>
                    <option>í•™ê¸‰ ì„œê¸°</option>
                    <option>í•™ê¸‰ ì´ë¬´</option>
                    <option>ì§ì ‘ ì…ë ¥</option>
                  </select>
                </div>
                <div class="form-row">
                  <span class="form-label">í™œë™ ê¸°ê°„</span>
                  <select id="govPeriod" class="select" style="flex: 1">
                    <option>1í•™ê¸°</option>
                    <option>2í•™ê¸°</option>
                    <option>1ë…„</option>
                  </select>
                </div>
                <div class="form-row">
                  <span class="form-label">í™œë™ ë‚´ìš©</span>
                  <textarea
                    id="govDetail"
                    class="textarea"
                    style="height: 80px"
                    placeholder="ë¹„ì›Œë‘ë©´ ì—­í• ì— ë§ëŠ” ê¸°ë³¸ ë¬¸êµ¬ê°€ ìƒì„±ë©ë‹ˆë‹¤."
                  ></textarea>
                </div>
                <div style="text-align: right; margin-top: 10px">
                  <button class="btn primary" onclick="addItemToList('ìì¹˜')">
                    + ëª©ë¡ì— ì¶”ê°€
                  </button>
                </div>
              </div>
            </div>

            <div id="tab-event" class="tab-content">
              <div class="input-group">
                <div class="form-row">
                  <span class="form-label">í™œë™ ë‚ ì§œ</span>
                  <input
                    type="date"
                    id="eventDate"
                    class="input"
                    style="width: 150px"
                  />
                </div>
                <div class="form-row">
                  <span class="form-label">í–‰ì‚¬ëª…</span>
                  <input
                    type="text"
                    id="eventName"
                    class="input"
                    style="flex: 1"
                    placeholder="ì˜ˆ: ì²´ìœ¡ëŒ€íšŒ, í•©ì°½ì œ, ê³¼í•™ì˜ ë‚ "
                  />
                </div>
                <div class="form-row">
                  <span class="form-label">ìƒì„¸ ë‚´ìš©</span>
                  <textarea
                    id="eventDetail"
                    class="textarea"
                    style="height: 80px"
                    placeholder="ë¹„ì›Œë‘ë©´ '[í–‰ì‚¬ëª…]ì— ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•¨' ë“±ìœ¼ë¡œ ìë™ ìƒì„±ë©ë‹ˆë‹¤."
                  ></textarea>
                </div>
                <div style="text-align: right; margin-top: 10px">
                  <button class="btn primary" onclick="addItemToList('í–‰ì‚¬')">
                    + ëª©ë¡ì— ì¶”ê°€
                  </button>
                </div>
              </div>
            </div>

            <div
              class="section-title"
              style="margin-top: 10px; font-size: 15px"
            >
              ğŸ•’ ì…ë ¥ëœ ê¸°ë¡ ëª©ë¡
            </div>
            <div id="historyListView" class="history-list">
              <div style="color: #999; text-align: center; padding: 20px">
                ìœ„ íƒ­ì—ì„œ ë‚´ìš©ì„ ì…ë ¥í•˜ê³  [ì¶”ê°€] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
              </div>
            </div>

            <div style="margin-top: 15px; text-align: right">
              <button
                class="btn success"
                style="padding: 12px 30px"
                onclick="saveToDB()"
              >
                ğŸ’¾ ì „ì²´ ëª©ë¡ ì €ì¥í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const students = ["ì´í˜„íƒœ"];
      let db = {};
      let selectedIndex = -1;
      let currentStudent = "";
      let tempItems = [];

      window.onload = () => {
        students.forEach((name) => (db[name] = { items: [] }));
        initModalList();

        const today = new Date().toISOString().split("T")[0];
        document
          .querySelectorAll('input[type="date"]')
          .forEach((el) => (el.value = today));
      };

      // --- íƒ­ ê¸°ëŠ¥ ---
      function switchTab(tabId) {
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((con) => con.classList.remove("active"));

        const buttons = document.querySelectorAll(".tab-btn");
        if (tabId === "tab-edu") buttons[0].classList.add("active");
        if (tabId === "tab-gov") buttons[1].classList.add("active");
        if (tabId === "tab-event") buttons[2].classList.add("active");

        document.getElementById(tabId).classList.add("active");
      }

      function checkEduInput(select) {
        const directInput = document.getElementById("eduTopicDirect");
        if (select.value === "ì§ì ‘ ì…ë ¥") {
          directInput.style.display = "block";
          directInput.focus();
        } else {
          directInput.style.display = "none";
        }
      }

      // --- ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ ë¡œì§ (ë°ì´í„° ì²˜ë¦¬ ê°œì„ ) ---
      function addItemToList(type) {
        if (!currentStudent) return alert("í•™ìƒì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");

        let date = "",
          title = "",
          detail = "",
          sub = "";

        if (type === "êµìœ¡") {
          date = document.getElementById("eduDate").value;
          const selectVal = document.getElementById("eduTopic").value;
          title =
            selectVal === "ì§ì ‘ ì…ë ¥"
              ? document.getElementById("eduTopicDirect").value
              : selectVal;
          detail = document.getElementById("eduDetail").value.trim();
          if (!title) return alert("êµìœ¡ ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        } else if (type === "ìì¹˜") {
          title = document.getElementById("govRole").value;
          sub = document.getElementById("govPeriod").value;
          detail = document.getElementById("govDetail").value.trim();
          if (!title || title === "ì—­í•  ì„ íƒ")
            return alert("ì—­í• ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        } else {
          // í–‰ì‚¬
          date = document.getElementById("eventDate").value;
          title = document.getElementById("eventName").value.trim();
          detail = document.getElementById("eventDetail").value.trim();
          if (!title) return alert("í–‰ì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }

        tempItems.push({
          id: Date.now(),
          type: type,
          date: date,
          title: title,
          sub: sub,
          detail: detail,
        });

        renderTempHistory();

        // ì…ë ¥ì°½ ë¹„ìš°ê¸° (ë‚ ì§œëŠ” ìœ ì§€)
        if (type === "êµìœ¡") {
          document.getElementById("eduDetail").value = "";
        }
        if (type === "ìì¹˜") {
          document.getElementById("govDetail").value = "";
        }
        if (type === "í–‰ì‚¬") {
          document.getElementById("eventName").value = "";
          document.getElementById("eventDetail").value = "";
        }
      }

      function renderTempHistory() {
        const view = document.getElementById("historyListView");
        if (tempItems.length === 0) {
          view.innerHTML =
            "<div style='color:#999; text-align:center; padding:20px;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
          return;
        }

        // ë‚ ì§œìˆœ ì •ë ¬ (ìì¹˜í™œë™ì€ ë‚ ì§œê°€ ì—†ìœ¼ë¯€ë¡œ ë§¨ ìœ„ë¡œ)
        tempItems.sort((a, b) => {
          if (!a.date) return -1;
          if (!b.date) return 1;
          return b.date.localeCompare(a.date);
        });

        let html = "";
        tempItems.forEach((item, idx) => {
          let titleText = item.title;
          let dateText = item.date ? item.date : "ê¸°ê°„: " + item.sub;
          let displayDetail = item.detail
            ? item.detail
            : "(ê¸°ë³¸ ë¬¸êµ¬ ìë™ ìƒì„± ì˜ˆì •)";

          html += `
                <div class="history-item">
                    <div style="flex:1;">
                        <span class="history-date">${dateText}</span>
                        <span class="history-badge">${item.type}</span>
                        <span style="font-weight:600; font-size:14px;">${titleText}</span>
                        <div style="margin-top:4px; font-size:13px; color:#4b5563;">${displayDetail}</div>
                    </div>
                    <button class="btn sm" style="color:red; border:1px solid #fee2e2;" onclick="removeTempItem(${idx})">ì‚­ì œ</button>
                </div>
            `;
        });
        view.innerHTML = html;
      }

      function removeTempItem(idx) {
        tempItems.splice(idx, 1);
        renderTempHistory();
      }

      function saveToDB() {
        if (!currentStudent) return;
        db[currentStudent].items = [...tempItems];
        showToast("ì „ì²´ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      // --- ê²€ìƒ‰ ë° ì„ íƒ ---
      const searchInput = document.getElementById("studentSearch");
      const autoList = document.getElementById("autoList");

      searchInput.addEventListener("input", () => {
        const val = searchInput.value;
        autoList.innerHTML = "";
        selectedIndex = -1;
        if (!val) {
          autoList.style.display = "none";
          return;
        }
        const matched = students.filter((s) => s.includes(val));
        matched.forEach((name) => {
          const div = document.createElement("div");
          div.className = "auto-item";
          div.textContent = name;
          div.onclick = () => selectStudent(name);
          autoList.appendChild(div);
        });
        autoList.style.display = matched.length ? "block" : "none";
      });

      searchInput.addEventListener("keydown", (e) => {
        const items = autoList.getElementsByClassName("auto-item");
        if (e.key === "ArrowDown") {
          e.preventDefault();
          selectedIndex++;
          if (selectedIndex >= items.length) selectedIndex = 0;
          updateSelection(items);
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          selectedIndex--;
          if (selectedIndex < 0) selectedIndex = items.length - 1;
          updateSelection(items);
        } else if (e.key === "Enter") {
          if (selectedIndex > -1)
            selectStudent(items[selectedIndex].textContent);
          else if (items.length > 0) selectStudent(items[0].textContent);
        }
      });

      function updateSelection(items) {
        Array.from(items).forEach((item, idx) =>
          item.classList.toggle("selected", idx === selectedIndex)
        );
      }
      function selectStudent(name) {
        searchInput.value = name;
        autoList.style.display = "none";
        loadMainSummary();
        showToast(`${name} í•™ìƒ ì„ íƒë¨`);
      }

      function openModal() {
        document.getElementById("logModal").style.display = "block";
      }
      function closeModal() {
        document.getElementById("logModal").style.display = "none";
      }
      function showToast(m) {
        const t = document.getElementById("toast");
        t.textContent = m;
        t.style.opacity = 1;
        setTimeout(() => (t.style.opacity = 0), 2000);
      }

      function initModalList() {
        const list = document.getElementById("modalStudentList");
        students.forEach((name) => {
          const div = document.createElement("div");
          div.className = "student-item";
          div.textContent = name;
          div.onclick = () => {
            currentStudent = name;
            document
              .querySelectorAll(".student-item")
              .forEach((i) => i.classList.remove("active"));
            div.classList.add("active");
            document.getElementById(
              "modalStudentTitle"
            ).textContent = `[${name}] ììœ¨í™œë™ ê¸°ë¡ ê´€ë¦¬`;

            tempItems = [...db[name].items];
            renderTempHistory();
          };
          list.appendChild(div);
        });
      }

      function loadMainSummary() {
        const name = searchInput.value;
        if (db[name] && db[name].items.length > 0) {
          let summary = "";
          const sorted = [...db[name].items].sort((a, b) => {
            if (!a.date) return -1;
            if (!b.date) return 1;
            return a.date.localeCompare(b.date);
          });
          sorted.forEach((item) => {
            let info = item.title + (item.sub ? `(${item.sub})` : "");
            let dateStr = item.date ? `[${item.date}] ` : "";
            summary += `${dateStr}[${item.type}] ${info} : ${
              item.detail || "(ë‚´ìš© ìë™ìƒì„±)"
            }\n`;
          });
          document.getElementById("rawDataDisplay").value = summary;
        } else {
          document.getElementById("rawDataDisplay").value =
            "ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
        }
      }

      // [AI ë¬¸ì¥ ìƒì„± ë¡œì§ - ì ‘ì†ì‚¬ ìˆ˜ì •]
      function generateAutoAI() {
        const name = searchInput.value;
        if (!db[name] || !db[name].items.length)
          return alert("ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

        const data = db[name].items;
        let eduText = [];
        let govText = [];
        let eventText = [];

        data.forEach((item) => {
          // ë‚´ìš©ì´ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ ë¬¸êµ¬ ìƒì„±
          let finalDetail = item.detail;

          if (item.type === "êµìœ¡") {
            if (!finalDetail)
              finalDetail = "ì„±ì‹¤íˆ ì°¸ì—¬í•˜ì—¬ ê´€ë ¨ ì§€ì‹ì„ í•¨ì–‘í•¨";
            eduText.push(`${item.title}ì— ì°¸ì—¬í•˜ì—¬ ${finalDetail}`);
          } else if (item.type === "ìì¹˜") {
            if (!finalDetail)
              finalDetail = "í•™ê¸‰ì„ ìœ„í•´ ë´‰ì‚¬í•˜ë©° ì±…ì„ê°ì„ ê¸°ë¦„";
            govText.push(`${item.sub} ë™ì•ˆ ${item.title}ë¡œì„œ ${finalDetail}`);
          } else if (item.type === "í–‰ì‚¬") {
            if (!finalDetail)
              finalDetail = "ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•˜ì—¬ ê³µë™ì²´ ì˜ì‹ì„ ë†’ì„";
            eventText.push(`${item.title} í™œë™ì—ì„œ ${finalDetail}`);
          }
        });

        let result = "";

        if (govText.length > 0) result += `${govText.join(", ")} `;
        if (eventText.length > 0) result += `${eventText.join(", ")} `;

        // [ìˆ˜ì •ëœ ë¶€ë¶„] êµìœ¡ í™œë™ ì ‘ì†ì‚¬ ì²˜ë¦¬
        if (eduText.length > 0) {
          // ì• ë‚´ìš©ì´ ìˆìœ¼ë©´ 'ë˜í•œ', ì—†ìœ¼ë©´(ì²« ë¬¸ì¥ì´ë©´) 'í‰ì†Œ'ë¡œ ì‹œì‘
          const prefix = result.length > 0 ? "ë˜í•œ " : "í‰ì†Œ ";
          result += `${prefix}${eduText.join(
            ", "
          )} ë“± ë‹¤ì–‘í•œ í™œë™ì„ í†µí•´ í•™êµìƒí™œì— ì¶©ì‹¤íˆ ì„í•¨.`;
        }

        document.getElementById("tempDraft").value = result;
      }

      function moveToFinal() {
        const text = document.getElementById("tempDraft").value;
        const target = document.getElementById("finalPreview");
        if (target.innerText.includes("í•™ìƒì„ ì„ íƒí•˜ê³ ")) target.innerText = "";
        target.innerText += (target.innerText ? "\n\n" : "") + text;
        updateByte();
      }

      function updateByte() {
        const text = document.getElementById("finalPreview").innerText;

        // [ìˆ˜ì •] ê¸€ììˆ˜ í‘œê¸° ì¶”ê°€
        document.getElementById("charNum").innerText = text.length;

        // Byte ê³„ì‚°
        let bytes = 0;
        for (let i = 0; i < text.length; i++) {
          bytes += text.charCodeAt(i) > 127 ? 3 : 1;
        }

        // Byte í‘œê¸° ë° ìƒ‰ìƒ ë³€ê²½
        const byteSpan = document.getElementById("byteNum");
        byteSpan.innerText = bytes;
        byteSpan.style.color = bytes > 1500 ? "red" : "#1f4ddc";
      }

      function finalApply() {
        alert("ì‘ì„±ëœ ë‚´ìš©ì„ NEISì— ì…ë ¥í•©ë‹ˆë‹¤.");
      }
    </script>
  </body>
</html>
