<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>í–‰ë™íŠ¹ì„± ê´€ë¦¬ - 1ì¸(ì´í˜„íƒœ) ì „ìš©</title>
    <style>
      /* [ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€] */
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", -apple-system, sans-serif;
        background: #f5f6f8;
        color: #333;
        overflow: hidden;
      }
      .topbar {
        height: 48px;
        background: #f5c6cf;
        display: flex;
        align-items: center;
        padding: 0 16px;
        font-weight: 700;
        border-bottom: 1px solid #e5adba;
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        height: calc(100vh - 48px);
      }
      .left {
        display: flex;
        flex-direction: column;
        padding: 25px;
        border-right: 1px solid #e5e7eb;
        background: #fff;
        gap: 15px;
      }
      .right {
        padding: 25px;
        display: flex;
        flex-direction: column;
        background: #fff;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }
      .section-title {
        font-size: 16px;
        font-weight: 700;
        color: #1f2937;
      }

      .search-container {
        position: relative;
        width: 100%;
      }
      .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-top: none;
        border-radius: 0 0 8px 8px;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .auto-item {
        padding: 10px 15px;
        cursor: pointer;
        font-size: 14px;
      }
      .auto-item.selected {
        background: #eff6ff;
        color: #1f4ddc;
        font-weight: 600;
      }

      .flex-1 {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .flex-2 {
        flex: 2;
        display: flex;
        flex-direction: column;
      }
      .input,
      .textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
      }
      .textarea {
        flex: 1;
        resize: none;
        line-height: 1.6;
      }

      .btn {
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid #d1d5db;
        background: #fff;
        transition: 0.2s;
      }
      .btn.primary {
        background: #1f4ddc;
        color: #fff;
        border-color: #163aa5;
      }
      .btn.success {
        background: #10b981;
        color: #fff;
        border-color: #059669;
      }
      .btn.accent {
        background: #f59e0b;
        color: #fff;
        border-color: #d97706;
      }
      .btn.sm {
        padding: 4px 8px;
        font-size: 11px;
      }
      .btn.danger-btn {
        /* ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³´ê°• */
        color: red;
        font-weight: bold;
        border: 1px solid #ffccc7;
        padding: 5px 8px;
        background: white;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
      }
      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 1100px;
        height: 85vh;
        background: #fff;
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }
      .modal-header {
        padding: 20px 30px;
        background: #f9fafb;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-body {
        display: grid;
        grid-template-columns: 260px 1fr;
        flex: 1;
        overflow: hidden;
      }

      .student-list {
        background: #f8fafc;
        border-right: 1px solid #e5e7eb;
        padding: 15px 0;
        overflow-y: auto;
      }
      .student-item {
        padding: 16px 30px;
        cursor: pointer;
        border-bottom: 1px solid #f1f5f9;
        font-size: 15px;
        transition: 0.2s;
      }
      .student-item.active {
        background: #eff6ff;
        color: #1f4ddc;
        font-weight: 700;
        border-right: 4px solid #1f4ddc;
      }

      .log-entry {
        padding: 35px;
        overflow-y: auto;
      }
      .history-view {
        margin-top: 25px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 20px;
      }
      .date-group {
        margin-bottom: 20px;
      }
      .date-header {
        font-size: 14px;
        font-weight: 700;
        color: #1f4ddc;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid #eee;
      }
      .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 6px;
        font-size: 13.5px;
      }
      .history-actions {
        display: flex;
        gap: 6px;
      }

      .preview-box {
        flex: 1;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 25px;
        font-size: 15px;
        line-height: 1.8;
        white-space: pre-wrap;
        outline: none;
        background: #fff;
        overflow-y: auto;
      }
      .counter {
        text-align: right;
        margin-top: 10px;
        font-size: 13px;
        color: #6b7280;
      }
      #toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 10px 25px;
        border-radius: 30px;
        font-size: 13px;
        opacity: 0;
        transition: 0.3s;
        z-index: 3000;
        pointer-events: none;
      }

      /* í‚¤ì›Œë“œ ì¹© ë° íŠ¸ë ˆì´ */
      .keyword-tray {
        display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        background: #f0f7ff;
        border: 1px solid #dbeafe;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        gap: 8px;
        flex-wrap: wrap;
      }
      .keyword-tray.show {
        display: flex;
      }
      .keyword-chip {
        font-size: 12px;
        background: #fff;
        border: 1px solid #bbd1f8;
        color: #1e40af;
        padding: 6px 12px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
      }
      .keyword-chip:hover {
        background: #1f4ddc;
        color: #fff;
        border-color: #1f4ddc;
      }

      .input-wrapper {
        border-bottom: 1px dashed #e5e7eb;
        padding-bottom: 10px;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div id="toast">ì•Œë¦¼</div>
    <div class="topbar">í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬</div>

    <div class="container">
      <section class="left">
        <div class="section-header">
          <div class="section-title">ê¸°ë¡ êµ¬ì„± ë° ê²€í† </div>
          <button class="btn accent" onclick="openModal()">ğŸ“… ëˆ„ê°€ê¸°ë¡</button>
        </div>
        <div class="search-container">
          <input
            type="text"
            class="input"
            id="studentSearch"
            placeholder="í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ë°©í–¥í‚¤/ì—”í„° ì¡°ì‘ ê°€ëŠ¥)"
            autocomplete="off"
          />
          <div id="autoList" class="autocomplete-list"></div>
        </div>
        <div class="flex-1">
          <div class="section-header">
            <label class="section-title">ë¶ˆëŸ¬ì˜¨ ì›ë³¸ ë°ì´í„° ìš”ì•½</label>
            <button class="btn sm" onclick="loadMainSummary()">
              ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            </button>
          </div>
          <textarea
            id="rawDataDisplay"
            class="textarea"
            readonly
            placeholder="ë‚ ì§œë³„ ê¸°ë¡ê³¼ ì‚¬ë¡€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."
          ></textarea>
        </div>
        <button
          class="btn primary"
          style="height: 48px; font-size: 15px"
          onclick="generateSummaryAI()"
        >
          âœ¨ AI ë¬¸ì¥ ìƒì„±
        </button>
        <div class="flex-2">
          <label
            class="section-title"
            style="margin-bottom: 8px; display: block"
            >AI ìƒì„± ì´ˆì•ˆ (êµì‚¬ ìˆ˜ì •)</label
          >
          <textarea
            id="tempDraft"
            class="textarea"
            style="background: #fdfbff; border-color: #c7d2fe"
          ></textarea>
          <button
            class="btn success"
            style="width: 100%; margin-top: 10px"
            onclick="moveToFinal()"
          >
            ìš°ì¸¡ ìµœì¢… ê²°ê³¼ë¡œ ë°˜ì˜ â†’
          </button>
        </div>
      </section>

      <section class="right">
        <div class="section-header" style="margin-bottom: 15px">
          <div class="section-title">NEIS ê¸°ì¬ ìµœì¢… ë‚´ìš©</div>
          <div style="display: flex; gap: 8px">
            <button
              class="btn"
              onclick="alert('AIê°€ ì „ì²´ ë¬¸ì¥ì˜ íë¦„ê³¼ ë§ì¶¤ë²•ì„ ë³´ì •í•©ë‹ˆë‹¤.')"
            >
              ğŸª„ ì „ì²´ AI ë‹¤ë“¬ê¸°
            </button>
            <button class="btn success" id="finalSubmitBtn">ğŸ’¾ ì ìš©í•˜ê¸°</button>
          </div>
        </div>
        <div
          id="finalPreview"
          class="preview-box"
          contenteditable="true"
          oninput="updateByte()"
        >
          í•™ìƒì„ ì„ íƒí•˜ê³  ë¬¸ì¥ì„ ìƒì„±í•´ ì£¼ì„¸ìš”.
        </div>
        <div class="counter">
          ì‹¤ì‹œê°„ ê¸€ììˆ˜:
          <span id="byteCount" style="color: #1f4ddc; font-weight: 700">0</span>
          / 1500 Byte
        </div>
      </section>
    </div>

    <div id="logModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span style="font-size: 18px; font-weight: 700; color: #374151"
            >ğŸ“… í•™ìƒë³„ ëˆ„ê°€ ê¸°ë¡</span
          >
          <button class="btn" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
        <div class="modal-body">
          <div class="student-list" id="modalStudentList"></div>
          <div class="log-entry">
            <h3
              id="modalStudentTitle"
              style="
                margin-top: 0;
                margin-bottom: 25px;
                color: #1f4ddc;
                font-size: 22px;
              "
            >
              í•™ìƒì„ ì„ íƒí•´ ì£¼ì„¸ìš”
            </h3>
            <div
              style="
                background: #f8fafc;
                padding: 25px;
                border-radius: 12px;
                border: 1px solid #e5e7eb;
              "
            >
              <div style="margin-bottom: 20px; font-weight: 600">
                ê¸°ë¡ ë‚ ì§œ:
                <input
                  type="date"
                  id="logDate"
                  class="input"
                  style="width: 180px; margin-left: 10px"
                />
              </div>

              <div id="inputRowsContainer"></div>

              <div
                style="
                  margin-top: 20px;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <button
                  class="btn sm"
                  style="padding: 6px 12px"
                  onclick="addRow()"
                >
                  + í™œë™ í•­ëª© ì¶”ê°€
                </button>
                <button
                  class="btn success"
                  style="padding: 10px 25px"
                  onclick="applyAndReset()"
                >
                  âœ… í˜„ì¬ ë‚ ì§œ ê¸°ë¡ ì ìš©
                </button>
              </div>
            </div>
            <div
              class="section-title"
              style="margin-top: 40px; font-size: 16px"
            >
              ğŸ•’ í˜„ì¬ê¹Œì§€ ì…ë ¥ëœ ì´ë ¥ (ë‚ ì§œë³„ ê·¸ë£¹í™”)
            </div>
            <div class="history-view" id="historyGroupView">
              ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. í™œë™ ë‚´ìš©ì„ ì…ë ¥í•˜ê³  [ì ìš©]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
            </div>
            <div
              style="
                margin-top: 40px;
                text-align: right;
                border-top: 1px solid #eee;
                padding-top: 25px;
              "
            >
              <button
                class="btn primary"
                style="padding: 14px 50px; font-size: 15px"
                onclick="saveAllToDB()"
              >
                ğŸ’¾ ì „ì²´ ë°ì´í„° ì €ì¥
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // [ìˆ˜ì •] í•™ìƒ ëª…ë‹¨ì„ "ì´í˜„íƒœ" 1ëª…ìœ¼ë¡œ ì œí•œ
      const students = ["ì´í˜„íƒœ"];
      
      const cats = [
        "ì„±ê²©",
        "êµìš°ê´€ê³„",
        "ìƒí™œíƒœë„",
        "ì ì„±Â·í™œë™",
        "ì§„ë¡œíƒœë„",
        "í•™ì—…íƒœë„",
        "ê¸°íƒ€",
      ];
      const levels = ["ë§¤ìš°ìš°ìˆ˜", "ìš°ìˆ˜", "ë³´í†µ", "ë…¸ë ¥"];

      // ì¹´í…Œê³ ë¦¬ë³„ í‚¤ì›Œë“œ DB (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)
      const KEYWORD_DB = {
        ì„±ê²©: [
          {
            word: "ê¸ì •ì ",
            s: {
              ë§¤ìš°ìš°ìˆ˜: "ë§¤ì‚¬ ê¸ì •ì ì¸ ì‚¬ê³ ë°©ì‹ìœ¼ë¡œ í•™ê¸‰ ë¶„ìœ„ê¸°ë¥¼ ë°ê²Œ ì£¼ë„í•¨.",
              ìš°ìˆ˜: "ë°ê³  ëª…ë‘í•œ íƒœë„ë¡œ ì¹œêµ¬ë“¤ì—ê²Œ ê¸ì •ì ì¸ ì—ë„ˆì§€ë¥¼ ì¤Œ.",
              ë³´í†µ: "ìƒí™©ì„ ê¸ì •ì ìœ¼ë¡œ ë°”ë¼ë³´ë ¤ ë…¸ë ¥í•˜ë©° ì›ë§Œí•˜ê²Œ ìƒí™œí•¨.",
              ë…¸ë ¥: "ê¸ì •ì ì¸ íƒœë„ë¥¼ ê¸°ë¥´ê¸° ìœ„í•œ ì§€ì†ì ì¸ ê²©ë ¤ê°€ í•„ìš”í•¨.",
            },
          },
          {
            word: "ì°¨ë¶„í•¨",
            s: {
              ë§¤ìš°ìš°ìˆ˜: "ì–´ë–¤ ìƒí™©ì—ì„œë„ ë™ìš”í•˜ì§€ ì•Šê³  ì°¨ë¶„í•˜ê²Œ ë¬¸ì œë¥¼ í•´ê²°í•¨.",
              ìš°ìˆ˜: "ì°¨ë¶„í•œ ì„±í’ˆìœ¼ë¡œ ë§¤ì‚¬ ì‹ ì¤‘í•˜ê²Œ ìƒê°í•˜ê³  í–‰ë™í•¨.",
              ë³´í†µ: "ëŒ€ì²´ë¡œ ì°¨ë¶„í•œ íƒœë„ë¥¼ ìœ ì§€í•˜ë©° ê³¼ì œë¥¼ ìˆ˜í–‰í•¨.",
              ë…¸ë ¥: "ìƒí™©ì— ë”°ë¼ ì¹¨ì°©í•¨ì„ ìœ ì§€í•˜ë ¤ëŠ” ë…¸ë ¥ì´ í•„ìš”í•¨.",
            },
          },
          {
            word: "ì±…ì„ê°",
            s: {
              ë§¤ìš°ìš°ìˆ˜: "ë§¡ì€ ì—­í• ì— ëŒ€í•œ ì±…ì„ê°ì´ íˆ¬ì² í•˜ì—¬ ëê¹Œì§€ ì™„ìˆ˜í•¨.",
              ìš°ìˆ˜: "ìì‹ ì˜ ì„ë¬´ë¥¼ ì„±ì‹¤í•˜ê²Œ ìˆ˜í–‰í•˜ë ¤ëŠ” ì±…ì„ê°ì´ ê°•í•¨.",
              ë³´í†µ: "ì£¼ì–´ì§„ ì—­í• ì— ëŒ€í•´ ì±…ì„ì„ ì§€ê³  ìˆ˜í–‰í•¨.",
              ë…¸ë ¥: "ë§¡ì€ ì¼ì„ ëê¹Œì§€ ì™„ìˆ˜í•˜ë ¤ëŠ” ì±…ì„ê°ì„ ê¸°ë¥¼ í•„ìš”ê°€ ìˆìŒ.",
            },
          },
          // ... (ë‚˜ë¨¸ì§€ í‚¤ì›Œë“œ ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ì‚¬ìš©ë¨) ...
        ],
        // ... (ë‚˜ë¨¸ì§€ ì¹´í…Œê³ ë¦¬ ìƒëµ) ...
      };
      
      // ë°ëª¨ìš© ë°ì´í„° ì±„ìš°ê¸°
      if(!KEYWORD_DB["êµìš°ê´€ê³„"]) KEYWORD_DB["êµìš°ê´€ê³„"] = []; 
      // (ì‹¤ì œ ì½”ë“œì—ì„œëŠ” ìœ„ KEYWORD_DB ì „ì²´ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì‹œë©´ ë©ë‹ˆë‹¤.)
      // ì—¬ê¸°ì„œëŠ” ì§€ë©´ìƒ í•µì‹¬ ë¡œì§ ìœ„ì£¼ë¡œ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.

      // ê°„ì†Œí™”ëœ ë°ì´í„° ì±„ìš°ê¸° (ë°ëª¨ìš©)
      for (let key of cats) {
        if (!KEYWORD_DB[key]) KEYWORD_DB[key] = [];
        if (KEYWORD_DB[key].length < 10) {
             const defaultKeywords = ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", "í‚¤ì›Œë“œ3", "í‚¤ì›Œë“œ4", "í‚¤ì›Œë“œ5", "í‚¤ì›Œë“œ6", "í‚¤ì›Œë“œ7", "í‚¤ì›Œë“œ8", "í‚¤ì›Œë“œ9", "í‚¤ì›Œë“œ10"];
             defaultKeywords.forEach(word => {
                 KEYWORD_DB[key].push({
                     word: word,
                     s: {
                        ë§¤ìš°ìš°ìˆ˜: `[${key}-${word}] ì¸¡ë©´ì—ì„œ íƒì›”í•œ ëŠ¥ë ¥ì„ ë³´ì„.`,
                        ìš°ìˆ˜: `[${key}-${word}] ê´€ë ¨ í™œë™ì— ìš°ìˆ˜í•˜ê²Œ ì°¸ì—¬í•¨.`,
                        ë³´í†µ: `[${key}-${word}] í™œë™ì„ ì›ë§Œí•˜ê²Œ ìˆ˜í–‰í•¨.`,
                        ë…¸ë ¥: `[${key}-${word}] ì¸¡ë©´ì—ì„œ ë…¸ë ¥ì´ í•„ìš”í•¨.`
                     }
                 });
             });
        }
      }

      let db = {};
      let selectedIndex = -1;
      let currentStudent = "";
      let recordIdCounter = 0;

      window.onload = () => {
        students.forEach((name) => (db[name] = []));
        initModalList();
        document.getElementById("logDate").value = new Date()
          .toISOString()
          .split("T")[0];
      };

      function showToast(m) {
        const t = document.getElementById("toast");
        t.textContent = m;
        t.style.opacity = 1;
        setTimeout(() => (t.style.opacity = 0), 2000);
      }

      const searchInput = document.getElementById("studentSearch");
      const autoList = document.getElementById("autoList");
      searchInput.addEventListener("input", () => {
        const val = searchInput.value;
        autoList.innerHTML = "";
        selectedIndex = -1;
        if (!val) {
          autoList.style.display = "none";
          return;
        }
        const matched = students.filter((s) => s.includes(val));
        matched.forEach((name, idx) => {
          const div = document.createElement("div");
          div.className = "auto-item";
          div.textContent = name;
          div.onclick = () => selectStudent(name);
          autoList.appendChild(div);
        });
        autoList.style.display = matched.length ? "block" : "none";
      });
      searchInput.addEventListener("keydown", (e) => {
        const items = autoList.getElementsByClassName("auto-item");
        if (e.key === "ArrowDown") {
          e.preventDefault();
          selectedIndex++;
          if (selectedIndex >= items.length) selectedIndex = 0;
          updateSelection(items);
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          selectedIndex--;
          if (selectedIndex < 0) selectedIndex = items.length - 1;
          updateSelection(items);
        } else if (e.key === "Enter") {
          if (selectedIndex > -1)
            selectStudent(items[selectedIndex].textContent);
          else if (items.length > 0) selectStudent(items[0].textContent);
        }
      });
      function updateSelection(items) {
        Array.from(items).forEach((item, idx) =>
          item.classList.toggle("selected", idx === selectedIndex)
        );
      }
      function selectStudent(name) {
        searchInput.value = name;
        autoList.style.display = "none";
        loadMainSummary();
        showToast(`${name} í•™ìƒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
      function openModal() {
        document.getElementById("logModal").style.display = "block";
      }
      function closeModal() {
        document.getElementById("logModal").style.display = "none";
      }
      function initModalList() {
        const list = document.getElementById("modalStudentList");
        students.forEach((name) => {
          const div = document.createElement("div");
          div.className = "student-item";
          div.textContent = name;
          div.onclick = () => {
            currentStudent = name;
            document
              .querySelectorAll(".student-item")
              .forEach((i) => i.classList.remove("active"));
            div.classList.add("active");
            document.getElementById(
              "modalStudentTitle"
            ).textContent = `[${name}] í•™ìƒ í–‰ë™ ê¸°ë¡ ìƒì„¸`;
            resetInputRows();
            renderHistory();
          };
          list.appendChild(div);
        });
      }

      function resetInputRows() {
        document.getElementById("inputRowsContainer").innerHTML = "";
        addRow();
      }

      function addRow() {
        const container = document.getElementById("inputRowsContainer");
        const wrapper = document.createElement("div");
        wrapper.className = "input-wrapper";

        const rowDiv = document.createElement("div");
        rowDiv.className = "input-row";
        rowDiv.style.display = "flex";
        rowDiv.style.gap = "12px";
        rowDiv.style.alignItems = "center";

        rowDiv.innerHTML = `
            <select class="input cat-select" style="width:130px;" onchange="updateKeywordTray(this)">${cats
              .map((c) => `<option>${c}</option>`)
              .join("")}</select>
            <select class="input level-select" style="width:110px;">${levels
              .map((l) => `<option>${l}</option>`)
              .join("")}</select>
            <input type="text" class="input case-input" style="flex:1;" placeholder="ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ [í‚¤ì›Œë“œ ì„ íƒ]ì„ ëˆ„ë¥´ì„¸ìš”">
            <button class="btn sm" onclick="toggleKeywordTray(this)">í‚¤ì›Œë“œ ì„ íƒ â–¼</button>
            <button class="btn sm danger-btn" style="color:red; font-weight:bold; border: 1px solid #ffccc7; padding: 5px 8px; background: white;" onclick="removeInputRow(this)">âœ•</button>
        `;

        const trayDiv = document.createElement("div");
        trayDiv.className = "keyword-tray";
        loadKeywordsToTray(trayDiv, "ì„±ê²©", rowDiv);

        wrapper.appendChild(rowDiv);
        wrapper.appendChild(trayDiv);
        container.appendChild(wrapper);
      }

      function toggleKeywordTray(btn) {
        const wrapper = btn.closest(".input-wrapper");
        const tray = wrapper.querySelector(".keyword-tray");
        const catSelect = wrapper.querySelector(".cat-select");

        if (tray.classList.contains("show")) {
          tray.classList.remove("show");
          btn.textContent = "í‚¤ì›Œë“œ ì„ íƒ â–¼";
        } else {
          loadKeywordsToTray(
            tray,
            catSelect.value,
            wrapper.querySelector(".input-row")
          );
          tray.classList.add("show");
          btn.textContent = "í‚¤ì›Œë“œ ë‹«ê¸° â–²";
        }
      }

      function updateKeywordTray(select) {
        const wrapper = select.closest(".input-wrapper");
        const tray = wrapper.querySelector(".keyword-tray");
        const row = wrapper.querySelector(".input-row");
        loadKeywordsToTray(tray, select.value, row);
      }

      function loadKeywordsToTray(tray, category, rowElement) {
        tray.innerHTML = "";
        const keywords = KEYWORD_DB[category] || [];

        keywords.forEach((kData) => {
          const chip = document.createElement("div");
          chip.className = "keyword-chip";
          chip.textContent = kData.word;
          chip.onclick = () => {
            const level = rowElement.querySelector(".level-select").value;
            const input = rowElement.querySelector(".case-input");
            const sentence = kData.s[level] || "";
            input.value = sentence; 
          };
          tray.appendChild(chip);
        });
      }

      function removeInputRow(btn) {
        const wrappers = document.querySelectorAll(".input-wrapper");
        if (wrappers.length > 1) {
          btn.closest(".input-wrapper").remove();
        } else {
          alert("ìµœì†Œ í•œ ê°œì˜ í–‰ì€ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.");
        }
      }

      function applyAndReset() {
        if (!currentStudent) return alert("í•™ìƒì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
        const date = document.getElementById("logDate").value;
        const wrappers = document.querySelectorAll(".input-wrapper");

        let selectedCats = new Set();
        let tempRecords = [];

        for (let w of wrappers) {
          const cat = w.querySelector(".cat-select").value;
          const level = w.querySelector(".level-select").value;
          let text = w.querySelector(".case-input").value.trim();

          if (selectedCats.has(cat)) {
            alert(`'${cat}' ì¹´í…Œê³ ë¦¬ê°€ ì¤‘ë³µë˜ì—ˆìŠµë‹ˆë‹¤. í•˜ë‚˜ë§Œ ë‚¨ê²¨ì£¼ì„¸ìš”.`);
            return;
          }
          selectedCats.add(cat);

          if (!text) {
            const kData = KEYWORD_DB[cat][0];
            text = kData ? kData.s[level] : "ê¸°ë¡ ë‚´ìš© ì—†ìŒ";
          }

          tempRecords.push({ id: recordIdCounter++, date, cat, level, text });
        }

        if (tempRecords.length > 0) {
          db[currentStudent].push(...tempRecords);
          showToast(`${date} ê¸°ë¡(${tempRecords.length}ê±´) ì ìš© ì™„ë£Œ`);
          resetInputRows();
          renderHistory();
        }
      }

      function renderHistory() {
        const view = document.getElementById("historyGroupView");
        const data = db[currentStudent];
        if (!data || data.length === 0) {
          view.innerHTML =
            "ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. í™œë™ ë‚´ìš©ì„ ì…ë ¥í•˜ê³  [ì ìš©]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
          return;
        }
        const grouped = data.reduce((acc, obj) => {
          if (!acc[obj.date]) acc[obj.date] = [];
          acc[obj.date].push(obj);
          return acc;
        }, {});

        let html = "";
        Object.keys(grouped)
          .sort()
          .reverse()
          .forEach((date) => {
            html += `<div class="date-group"><div class="date-header">ğŸ“… ${date}</div>`;
            grouped[date].forEach((item) => {
              html += `<div class="history-item">
                    <span><b>[${item.cat}]</b> ${item.text} (${item.level})</span>
                    <div class="history-actions">
                        <button class="btn sm" onclick="editRecord(${item.id})">ìˆ˜ì •</button>
                        <button class="btn sm" style="color:red; border-color: #ffcfcf;" onclick="deleteRecord(${item.id})">ì‚­ì œ</button>
                    </div>
                </div>`;
            });
            html += `</div>`;
          });
        view.innerHTML = html;
      }

      function deleteRecord(id) {
        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        db[currentStudent] = db[currentStudent].filter((r) => r.id !== id);
        renderHistory();
      }

      function editRecord(id) {
        const r = db[currentStudent].find((item) => item.id === id);
        document.getElementById("logDate").value = r.date;

        const container = document.getElementById("inputRowsContainer");
        container.innerHTML = "";

        const wrapper = document.createElement("div");
        wrapper.className = "input-wrapper";
        const rowDiv = document.createElement("div");
        rowDiv.className = "input-row";
        rowDiv.style.display = "flex";
        rowDiv.style.gap = "12px";
        rowDiv.style.alignItems = "center";

        rowDiv.innerHTML = `
            <select class="input cat-select" style="width:130px;" onchange="updateKeywordTray(this)"></select>
            <select class="input level-select" style="width:110px;"></select>
            <input type="text" class="input case-input" style="flex:1;" value="${r.text}">
            <button class="btn sm" onclick="toggleKeywordTray(this)">í‚¤ì›Œë“œ ì„ íƒ â–¼</button>
            <button class="btn sm danger-btn" style="color:red; font-weight:bold; border: 1px solid #ffccc7; background: white;" onclick="removeInputRow(this)">âœ•</button>
        `;

        const trayDiv = document.createElement("div");
        trayDiv.className = "keyword-tray";
        loadKeywordsToTray(trayDiv, r.cat, rowDiv);

        wrapper.appendChild(rowDiv);
        wrapper.appendChild(trayDiv);
        container.appendChild(wrapper);

        const catSel = rowDiv.querySelector(".cat-select");
        cats.forEach((c) => {
          const o = new Option(c, c);
          if (c === r.cat) o.selected = true;
          catSel.add(o);
        });
        const lvlSel = rowDiv.querySelector(".level-select");
        levels.forEach((l) => {
          const o = new Option(l, l);
          if (l === r.level) o.selected = true;
          lvlSel.add(o);
        });

        db[currentStudent] = db[currentStudent].filter(
          (item) => item.id !== id
        );
        renderHistory();
        showToast("ìˆ˜ì • ëª¨ë“œ: ë‚´ìš©ì„ ê³ ì¹œ í›„ ë‹¤ì‹œ 'ê¸°ë¡ ì ìš©'ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
      }

      function saveAllToDB() {
        showToast("ëª¨ë“  ë°ì´í„°ê°€ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
      function loadMainSummary() {
        const name = searchInput.value;
        if (db[name]) {
          const summary = db[name]
            .sort((a, b) => a.date.localeCompare(b.date))
            .map((r) => `${r.date}: [${r.cat}] ${r.text} (${r.level})`)
            .join("\n");
          document.getElementById("rawDataDisplay").value =
            summary || "ê¸°ë¡ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.";
        }
      }
      function generateSummaryAI() {
        const name = searchInput.value;
        if (!db[name] || db[name].length === 0)
          return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        let result = `í•™ê¸° ì „ë°˜ì— ê±¸ì³ `;
        db[name].forEach((r) => (result += `${r.text} `));
        document.getElementById("tempDraft").value =
          result +
          "ì´ëŸ¬í•œ ë‚´ìš©ì„ ì¢…í•©í•  ë•Œ ê³µë™ì²´ ì˜ì‹ì´ íˆ¬ì² í•˜ë©° ì§€ì†ì ì¸ ì„±ì¥ì´ ê¸°ëŒ€ë¨.";
      }
      function moveToFinal() {
        const text = document.getElementById("tempDraft").value;
        const target = document.getElementById("finalPreview");
        if (target.innerText.includes("í•™ìƒì„ ì„ íƒí•˜ê³ ")) target.innerText = "";
        target.innerText += (target.innerText ? "\n\n" : "") + text;
        updateByte();
      }
      function updateByte() {
        const text = document.getElementById("finalPreview").innerText;
        let bytes = 0;
        for (let i = 0; i < text.length; i++)
          bytes += text.charCodeAt(i) > 127 ? 3 : 1;
        document.getElementById("byteCount").textContent = bytes;
      }
      document.getElementById("finalSubmitBtn").onclick = () =>
        alert("ì‘ì„±ëœ ë‚´ìš©ì„ NEISì— ì…ë ¥í•©ë‹ˆë‹¤.");
    </script>
  </body>
</html>
