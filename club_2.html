<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë™ì•„ë¦¬í™œë™ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <style>
      /* --- [ìŠ¤í¬ë¡¤ ë° ë ˆì´ì•„ì›ƒ ìµœì í™”] --- */
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", -apple-system, sans-serif;
        background: #f5f6f8;
        color: #333;
        overflow: hidden;
      }
      .topbar {
        height: 48px;
        background: #f5c6cf;
        display: flex;
        align-items: center;
        padding: 0 16px;
        font-weight: 700;
        border-bottom: 1px solid #e5adba;
        color: #333;
        flex-shrink: 0;
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        height: calc(100vh - 48px);
      }
      .left,
      .right {
        padding: 25px;
        display: flex;
        flex-direction: column;
        background: #fff;
        overflow-y: auto;
        min-height: 0;
      }
      .left {
        border-right: 1px solid #e5e7eb;
        gap: 15px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
        flex-shrink: 0;
      }
      .section-title {
        font-size: 16px;
        font-weight: 700;
        color: #1f2937;
      }

      .input,
      .select {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: 0.2s;
      }
      .textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        resize: none;
        line-height: 1.6;
      }

      .btn {
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid #d1d5db;
        background: #fff;
        transition: 0.2s;
        flex-shrink: 0;
      }
      .btn.primary {
        background: #1f4ddc;
        color: #fff;
        border-color: #163aa5;
      }
      .btn.success {
        background: #10b981;
        color: #fff;
        border-color: #059669;
      }
      .btn.danger {
        background: #fff;
        color: #e11d48;
        border-color: #ffcccc;
      }
      .btn.warning {
        background: #f59e0b;
        color: #fff;
        border-color: #d97706;
      }
      .btn.sm {
        padding: 6px 12px;
        font-size: 12px;
      }

      .preview-box {
        flex: 6;
        min-height: 150px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 25px;
        font-size: 15px;
        line-height: 1.8;
        outline: none;
        background: #fff;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-all;
        scroll-behavior: smooth;
      }
      .sentence-block {
        cursor: text;
        transition: background 0.4s ease-out;
        border-radius: 4px;
        padding: 2px 0;
      }
      .sentence-block:hover {
        background-color: #eff6ff;
      }
      .highlight-active {
        background-color: #fef08a !important;
      }

      .counter {
        text-align: right;
        margin-top: 10px;
        font-size: 13px;
        color: #6b7280;
        flex-shrink: 0;
      }

      .info-layer {
        flex: 4;
        min-height: 150px;
        border: 1px solid #e5e7eb;
        background: #fafafa;
        border-radius: 12px;
        padding: 15px;
        overflow-y: auto;
        margin-top: 15px;
      }
      .info-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        font-size: 13px;
        border-left: 4px solid #1f4ddc;
        transition: 0.2s;
        position: relative;
        cursor: pointer;
      }
      .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }
      .info-card.deleted {
        border-left-color: #ef4444;
        opacity: 0.5;
        background: #fff5f5;
        pointer-events: none;
      }
      .info-card.modified {
        border-left-color: #10b981;
      }
      .info-card.optimized {
        border-left-color: #8b5cf6;
        background: #f5f3ff;
      }

      .info-header {
        font-weight: 700;
        color: #333;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }
      .tag {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
        background: #f3f4f6;
        color: #555;
        border: 1px solid #e5e7eb;
        margin-right: 4px;
        display: inline-block;
        margin-top: 4px;
      }
      .status-badge {
        font-size: 10px;
        padding: 3px 6px;
        border-radius: 4px;
        color: #fff;
        background: #10b981;
      }
      .delete-sentence-btn {
        background: #fee2e2;
        color: #ef4444;
        border: 1px solid #fca5a5;
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 11px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
      }
      .delete-sentence-btn:hover {
        background: #ef4444;
        color: #fff;
      }

      .info-role-group {
        margin-bottom: 8px;
        border-bottom: 1px dashed #eee;
        padding-bottom: 5px;
      }
      .info-role-group:last-child {
        border-bottom: none;
      }
      .info-role-title {
        font-weight: 700;
        color: #1e40af;
        margin-bottom: 4px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .dup-badge {
        background: #f59e0b;
        color: #fff;
        font-size: 10px;
        padding: 3px 8px;
        border-radius: 12px;
        font-weight: 700;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
      }
      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 1100px;
        height: 90vh;
        background: #fff;
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .modal-header {
        padding: 20px 30px;
        background: #f9fafb;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }
      .modal-body {
        display: grid;
        grid-template-columns: 240px 1fr;
        flex: 1;
        overflow: hidden;
        min-height: 0;
      }

      .student-list {
        background: #f8fafc;
        border-right: 1px solid #e5e7eb;
        padding: 15px 0;
        overflow-y: auto;
      }
      .student-item {
        padding: 16px 30px;
        background: #eff6ff;
        color: #1f4ddc;
        font-weight: 700;
        border-right: 4px solid #1f4ddc;
        font-size: 15px;
      }
      .log-entry {
        padding: 30px;
        overflow-y: auto;
        background: #fff;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .tab-menu {
        display: flex;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 20px;
        flex-shrink: 0;
      }
      .tab-btn {
        flex: 1;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        font-weight: 700;
        color: #6b7280;
        font-size: 14px;
        border-bottom: 3px solid transparent;
        transition: 0.2s;
      }
      .tab-btn:hover {
        color: #1f4ddc;
      }
      .tab-btn.active {
        color: #1f4ddc;
        border-bottom-color: #1f4ddc;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      .form-box {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        flex-shrink: 0;
      }
      .form-row {
        display: flex;
        margin-bottom: 15px;
        align-items: flex-start;
        gap: 15px;
      }
      .form-label {
        width: 100px;
        font-weight: 600;
        color: #4b5563;
        font-size: 13px;
        padding-top: 10px;
        flex-shrink: 0;
      }
      .form-input-group {
        flex: 1;
      }

      .history-item {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        align-items: flex-start;
        gap: 15px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
        transition: 0.2s;
      }
      .history-chk {
        margin-top: 4px;
        transform: scale(1.3);
        cursor: pointer;
        accent-color: #1f4ddc;
      }
      #toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 10px 25px;
        border-radius: 30px;
        font-size: 13px;
        opacity: 0;
        transition: 0.3s;
        pointer-events: none;
        z-index: 3000;
      }
    </style>
  </head>
  <body>
    <div id="toast">ì•Œë¦¼</div>
    <div class="topbar">ë™ì•„ë¦¬í™œë™ê´€ë¦¬ì‹œìŠ¤í…œ</div>

    <div class="container">
      <section class="left">
        <div class="section-header">
          <div class="section-title">í•™ìƒí™œë™ ë°ì´í„° êµ¬ì„±</div>
          <button class="btn accent" onclick="openModal()">
            ğŸ“… ëˆ„ê°€ê¸°ë¡ ìƒì„¸ ê´€ë¦¬
          </button>
        </div>

        <div
          style="
            background: #eef2ff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #c7d2fe;
            margin-bottom: 10px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
          "
        >
          <div style="display: flex; align-items: center; gap: 15px">
            <strong style="color: #3730a3; white-space: nowrap; font-size: 15px"
              >ğŸ§‘â€ğŸ“ ì´í˜„íƒœ</strong
            >
            <div style="flex: 1; display: flex; align-items: center; gap: 8px">
              <span style="font-size: 13px; font-weight: 600; color: #4f46e5"
                >ì†Œì† ë™ì•„ë¦¬ëª…:</span
              >
              <input
                type="text"
                id="globalClubName"
                class="input"
                style="
                  flex: 1;
                  padding: 8px 12px;
                  font-weight: bold;
                  background: #e5e7eb;
                  color: #6b7280;
                  border: 1px solid #d1d5db;
                  cursor: not-allowed;
                "
                value="ë°©ì†¡ë¶€"
                readonly
              />
            </div>
          </div>
          <div
            style="
              font-size: 12px;
              color: #ef4444;
              font-weight: 600;
              text-align: right;
            "
          >
            (â€» ë³¸ í”„ë¡œê·¸ë¨ì€ 'ë°©ì†¡ë¶€' ê¸°ì¤€ìœ¼ë¡œ ì„¸íŒ…ë˜ì–´ ë™ì•„ë¦¬ëª… ìˆ˜ì •ì´
            ì œí•œë©ë‹ˆë‹¤.)
          </div>
        </div>

        <div
          style="flex: 1; display: flex; flex-direction: column; min-height: 0"
        >
          <div class="section-header" style="margin-top: 5px; flex-shrink: 0">
            <label class="section-title">ìƒì„± ëŒ€ê¸° ì¤‘ì¸ í™œë™ (ì„ íƒë¨)</label>
          </div>
          <textarea
            id="rawDataDisplay"
            class="textarea"
            readonly
            placeholder="[ëˆ„ê°€ê¸°ë¡ ìƒì„¸ ê´€ë¦¬]ì—ì„œ ì²´í¬ëœ í™œë™ë“¤ì´ í‘œì‹œë©ë‹ˆë‹¤."
            style="background: #f9fafb; color: #555; flex: 1"
          ></textarea>
        </div>

        <button
          class="btn primary"
          style="height: 50px; font-size: 16px; margin: 15px 0; flex-shrink: 0"
          onclick="generateClubAI()"
        >
          âœ¨ AI ë™ì•„ë¦¬ ë¬¸ë‹¨ ìƒì„±
        </button>

        <div
          style="flex: 1; display: flex; flex-direction: column; min-height: 0"
        >
          <label
            class="section-title"
            style="margin-bottom: 8px; flex-shrink: 0"
            >AI ìƒì„± ì´ˆì•ˆ</label
          >
          <textarea
            id="tempDraft"
            class="textarea"
            style="background: #fdfbff; border-color: #c7d2fe; flex: 1"
          ></textarea>
          <button
            class="btn success"
            style="width: 100%; margin-top: 10px; flex-shrink: 0"
            onclick="moveToFinal()"
          >
            ìš°ì¸¡ ìµœì¢… ê²°ê³¼ë¡œ ë°˜ì˜ â†’
          </button>
        </div>
      </section>

      <section class="right">
        <div class="section-header" style="margin-bottom: 15px">
          <div class="section-title">NEIS ê¸°ì¬ ìµœì¢… ë‚´ìš©</div>
          <div style="display: flex; gap: 8px">
            <button class="btn danger" onclick="clearFinal()">
              ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
            </button>
            <button
              class="btn"
              style="background: #8b5cf6; color: white; border-color: #7c3aed"
              onclick="checkIntegrity()"
            >
              ğŸª„ ì „ì²´ ë¬¸ë§¥ ë‹¤ë“¬ê¸° (ì£¼ì–´ ì¤‘ë³µ ì œê±°)
            </button>
            <button class="btn success" onclick="finalApply()">
              ğŸ’¾ ì ìš©í•˜ê¸°
            </button>
          </div>
        </div>

        <div
          style="
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 15px;
            min-height: 0;
          "
        >
          <div
            id="finalPreview"
            class="preview-box"
            contenteditable="true"
            oninput="updateByte()"
          ></div>

          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              flex-shrink: 0;
            "
          >
            <div class="counter">
              ì‹¤ì‹œê°„ ìš©ëŸ‰:
              <span id="byteCount" style="color: #1f4ddc; font-weight: 700"
                >0</span
              >
              / 1500 Byte
            </div>
          </div>

          <div class="info-layer" id="infoLayer">
            <span style="font-weight: 700; display: block; margin-bottom: 8px"
              >ğŸ“‹ í¬í•¨ëœ ì •ë³´ ìš”ì•½ (ë‹¤ë“¬ê¸° ì‹œ í†µí•©ë¨)</span
            >
            <div id="infoContentContainer" style="color: #999">
              ìƒì„±ëœ ë¬¸ë‹¨ì— í¬í•¨ëœ ë™ì•„ë¦¬ í™œë™ ë‚´ì—­ì´ ëˆ„ì ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </section>
    </div>

    <div id="logModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span style="font-size: 18px; font-weight: 700; color: #374151"
            >í•™ìƒë³„ ë™ì•„ë¦¬ ëˆ„ê°€ê¸°ë¡ ìƒì„¸ ê´€ë¦¬</span
          >
          <button class="btn" onclick="closeModal()">ë‹«ê¸° (ìë™ ì €ì¥ë¨)</button>
        </div>
        <div class="modal-body">
          <div class="student-list" id="modalStudentList"></div>

          <div class="log-entry">
            <div class="tab-menu">
              <div class="tab-btn active" onclick="switchTab('normal', this)">
                ğŸ‘¥ ì¼ë°˜ í™œë™
              </div>
              <div class="tab-btn" onclick="switchTab('project', this)">
                ğŸš€ í”„ë¡œì íŠ¸ / ì‹¬í™” íƒêµ¬
              </div>
            </div>

            <div id="tab-normal" class="tab-content active">
              <div class="form-box">
                <div class="form-row">
                  <div class="form-label">í™œë™ ì¼ì</div>
                  <div class="form-input-group">
                    <input
                      type="date"
                      id="normDate"
                      class="input"
                      style="width: 200px"
                    />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-label">í™œë™ ì—­í• </div>
                  <div class="form-input-group">
                    <div style="display: flex; gap: 10px">
                      <select
                        id="normRole"
                        class="select"
                        onchange="toggleRoleInput('norm')"
                        style="flex: 1"
                      >
                        <option value="member" selected>ë™ì•„ë¦¬ì›</option>
                        <option value="leader">ë™ì•„ë¦¬ íšŒì¥</option>
                        <option value="sub_leader">ë™ì•„ë¦¬ ë¶€íšŒì¥</option>
                        <option value="exec">ì„ì›</option>
                        <option value="custom">ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)</option>
                      </select>
                      <input
                        type="text"
                        id="normRoleCustom"
                        class="input"
                        placeholder="ì˜ˆ: ë©”ì¸ PD, ì¹´ë©”ë¼ ê°ë…"
                        style="flex: 1; display: none"
                      />
                    </div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-label">í™œë™ ì˜ì—­/ìˆ˜ì¤€</div>
                  <div
                    class="form-input-group"
                    style="display: flex; gap: 10px"
                  >
                    <select id="normCat" class="select" style="flex: 1">
                      <option disabled selected>í™œë™ ì˜ì—­</option>
                      <option>ì°¸ì—¬íƒœë„</option>
                      <option>í˜‘ë ¥ì†Œí†µ</option>
                      <option>ì°½ì˜ì„±</option>
                      <option>ë¦¬ë”ì‹­</option>
                      <option>ê³¼ì œìˆ˜í–‰</option>
                      <option>ì§„ë¡œì—­ëŸ‰</option>
                      <option>ê¸°íƒ€</option>
                    </select>
                    <select id="normLevel" class="select" style="flex: 1">
                      <option disabled selected>ì„±ì·¨ ìˆ˜ì¤€</option>
                      <option>ë§¤ìš°ìš°ìˆ˜</option>
                      <option>ìš°ìˆ˜</option>
                      <option>ë³´í†µ</option>
                      <option>ë…¸ë ¥</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-label">í™œë™ ë‚´ìš©</div>
                  <div class="form-input-group">
                    <textarea
                      id="normContent"
                      class="textarea"
                      style="height: 80px"
                      placeholder="ìƒì„¸ í™œë™ ë‚´ìš© (ì˜ˆ: ì²´ìœ¡ëŒ€íšŒ ë¼ì´ë¸Œ ì¤‘ê³„ ì¥ë¹„ ì„¸íŒ… ë° ì´¬ì˜. ë¹ˆì¹¸ ì‹œ ì˜ì—­ëª… ìë™ ì¹˜í™˜)"
                    ></textarea>
                  </div>
                </div>
                <div style="text-align: right">
                  <button class="btn primary" onclick="saveActivity('normal')">
                    + ëª©ë¡ì— ì¶”ê°€/ì €ì¥
                  </button>
                </div>
              </div>
            </div>

            <div id="tab-project" class="tab-content">
              <div class="form-box">
                <div class="form-row">
                  <div class="form-label">í™œë™ ì¼ì</div>
                  <div class="form-input-group">
                    <input
                      type="date"
                      id="projDate"
                      class="input"
                      style="width: 200px"
                    />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-label">í™œë™ ì—­í• </div>
                  <div class="form-input-group">
                    <div style="display: flex; gap: 10px">
                      <select
                        id="projRole"
                        class="select"
                        onchange="toggleRoleInput('proj')"
                        style="flex: 1"
                      >
                        <option value="member" selected>ë™ì•„ë¦¬ì›</option>
                        <option value="leader">ë™ì•„ë¦¬ íšŒì¥</option>
                        <option value="sub_leader">ë™ì•„ë¦¬ ë¶€íšŒì¥</option>
                        <option value="exec">ì„ì›</option>
                        <option value="custom">ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)</option>
                      </select>
                      <input
                        type="text"
                        id="projRoleCustom"
                        class="input"
                        placeholder="ì˜ˆ: í¸ì§‘ì¥, ê¸°íšë‹´ë‹¹"
                        style="flex: 1; display: none"
                      />
                    </div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-label">ì˜ìƒ/í”„ë¡œì íŠ¸ëª…</div>
                  <div class="form-input-group">
                    <input
                      type="text"
                      id="projTopic"
                      class="input"
                      placeholder="ì˜ˆ: 2026í•™ë…„ë„ í•™êµ í™ë³´ ì˜ìƒ ì œì‘"
                    />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-label">íƒêµ¬ ë‚´ìš©/ê²°ê³¼</div>
                  <div class="form-input-group">
                    <textarea
                      id="projContent"
                      class="textarea"
                      style="height: 80px"
                      placeholder="ì˜ˆ: í”„ë¦¬ë¯¸ì–´ í”„ë¡œë¥¼ í™œìš©í•´ ì»· í¸ì§‘ì„ ì£¼ë„í•˜ê³  ì™„ì„±ë„ ë†’ì€ ì˜ìƒì„ ì†¡ì¶œí•¨."
                    ></textarea>
                  </div>
                </div>
                <div style="text-align: right">
                  <button class="btn primary" onclick="saveActivity('project')">
                    + ëª©ë¡ì— ì¶”ê°€/ì €ì¥
                  </button>
                </div>
              </div>
            </div>

            <div
              style="
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 0;
              "
            >
              <div
                style="
                  margin-bottom: 10px;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  flex-shrink: 0;
                "
              >
                <span style="font-weight: 700; color: #374151"
                  >ğŸ•’ ì…ë ¥ëœ ê¸°ë¡ ëª©ë¡</span
                >
                <div>
                  <button class="btn sm" onclick="checkAll(true)">
                    ì „ì²´ ì„ íƒ
                  </button>
                  <button class="btn sm" onclick="checkAll(false)">
                    ì „ì²´ í•´ì œ
                  </button>
                </div>
              </div>
              <div
                id="historyListContainer"
                style="overflow-y: auto; flex: 1; padding-right: 5px"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      /* --- [ë™ì•„ë¦¬ í•µì‹¬ ë°ì´í„°ë² ì´ìŠ¤] --- */
      const ROLE_NAMES = {
        leader: "ë™ì•„ë¦¬ íšŒì¥",
        sub_leader: "ë™ì•„ë¦¬ ë¶€íšŒì¥",
        exec: "ì„ì›",
        member: "ë™ì•„ë¦¬ì›",
      };

      const CAT_ENDINGS = {
        ì°¸ì—¬íƒœë„: {
          3: "ë§¤ì‚¬ ì—´ì •ì ìœ¼ë¡œ ë°©ì†¡ ì¤€ë¹„ ë° ì¥ë¹„ ì„¸íŒ…ì— ì°¸ì—¬í•˜ì—¬ íƒ€ì˜ ëª¨ë²”ì´ ë¨",
          2: "ì ê·¹ì ì¸ íƒœë„ë¡œ ì˜ìƒ ê¸°íš ë° ì´¬ì˜ í™œë™ì— ì„í•˜ì—¬ ëšœë ·í•œ ì„±ì¥ì„ ë³´ì„",
          1: "ì„±ì‹¤í•œ ìì„¸ë¡œ ì •ê·œ ë°©ì†¡ ë° êµë‚´ í–‰ì‚¬ì— ì°¸ì—¬í•¨",
          0: "ê´€ì‹¬ì„ ê°€ì§€ê³  ê¾¸ì¤€íˆ ë°©ì†¡ë¶€ í™œë™ì— ì°¸ì—¬í•˜ë ¤ ë…¸ë ¥í•¨",
        },
        í˜‘ë ¥ì†Œí†µ: {
          3: "ë›°ì–´ë‚œ ì†Œí†µ ëŠ¥ë ¥ìœ¼ë¡œ ê¸°íš, ì´¬ì˜, í¸ì§‘ íŒŒíŠ¸ ê°„ì˜ íŒ€ì›Œí¬ë¥¼ ê·¹ëŒ€í™”í•¨",
          2: "ë¶€ì›ë“¤ê³¼ ì›í™œí•˜ê²Œ ì†Œí†µí•˜ë©° ì„±ê³µì ì¸ ë°©ì†¡ ì†¡ì¶œì„ ì´ëŒì–´ëƒ„",
          1: "ì¡°ì›ë“¤ê³¼ í˜‘ë ¥í•˜ì—¬ ì›ë§Œí•˜ê²Œ ì˜ìƒ ì œì‘ì„ ìˆ˜í–‰í•¨",
          0: "ë‹¤ë¥¸ ë¶€ì›ì˜ ì˜ê²¬ì„ ê²½ì²­í•˜ë©° í˜‘ë ¥ì ì¸ íƒœë„ë¥¼ ë³´ì„",
        },
        ì°½ì˜ì„±: {
          3: "ë…ì°½ì ì¸ ê¸°íšë ¥ê³¼ ì°¸ì‹ í•œ ì•µê¸€ë¡œ ìˆ˜ì¤€ ë†’ì€ ì˜ìƒ ì½˜í…ì¸ ë¥¼ ì œì‘í•¨",
          2: "ì°½ì˜ì ì¸ ì‹œê°ìœ¼ë¡œ ì ‘ê·¼í•˜ì—¬ ê¸°ì¡´ê³¼ ë‹¤ë¥¸ ìƒˆë¡œìš´ ë°©ì†¡ í¬ë§·ì„ ì‹œë„í•¨",
          1: "ë‹¤ì–‘í•œ ì•„ì´ë””ì–´ë¥¼ ì œì‹œí•˜ë©° íš¨ê³¼ì ì¸ ì˜ìƒ í¸ì§‘ ê¸°ìˆ ì„ íƒêµ¬í•¨",
          0: "ìƒˆë¡œìš´ ì´¬ì˜ ê¸°ë²• ë° ì¥ë¹„ í™œìš©ì— í¥ë¯¸ë¥¼ ê°€ì§€ê³  ì ‘ê·¼í•¨",
        },
        ë¦¬ë”ì‹­: {
          3: "íƒì›”í•œ ë¦¬ë”ì‹­ìœ¼ë¡œ ìŠ¤íƒœí”„ë“¤ì„ ì´ëŒê³  ëŒë°œ ìƒí™©ì—ì„œë„ ì™„ë²½í•œ ëŒ€ì²˜ ëŠ¥ë ¥ì„ ë³´ì—¬ì¤Œ",
          2: "ë¶€ì›ë“¤ì„ ê²©ë ¤í•˜ë©° ì£¼ë„ì ìœ¼ë¡œ í•™êµ í–‰ì‚¬ ì¤‘ê³„ ë° ì˜ìƒ í”„ë¡œì íŠ¸ë¥¼ ì´ë",
          1: "ë§¡ì€ ë°” ì—­í• ì„ ë‹¤í•˜ë©° ì›í™œí•œ íì‹œíŠ¸ ì§„í–‰ì— ê¸°ì—¬í•¨",
          0: "ì±…ì„ê°ì„ ê°€ì§€ê³  ë°©ì†¡ë¶€ ìš´ì˜ì„ ë•ê¸° ìœ„í•´ ë¬µë¬µíˆ ë…¸ë ¥í•¨",
        },
        ê³¼ì œìˆ˜í–‰: {
          3: "ë§ˆê° ê¸°í•œì„ ì—„ìˆ˜í•˜ë©° ë†’ì€ ì™„ì„±ë„ì˜ ìµœì¢… í¸ì§‘ë³¸ì„ ì œì¶œí•˜ëŠ” ê°•í•œ ì±…ì„ê°ì„ ë³´ì—¬ì¤Œ",
          2: "ì£¼ì–´ì§„ ì·¨ì¬ ë° ì´¬ì˜ ê³¼ì œë¥¼ í›Œë¥­íˆ í•´ê²°í•˜ë©° ë†’ì€ ê¸°ê¸° ì´í•´ë„ë¥¼ ë³´ì„",
          1: "ì±…ì„ê°ì„ ê°€ì§€ê³  ëŒ€ë³¸ ì‘ì„± ë° ì¥ë¹„ ê´€ë¦¬ë¥¼ ëê¹Œì§€ ìˆ˜í–‰í•¨",
          0: "ì£¼ì–´ì§„ ë°©ì†¡ ê³¼ì œ í•´ê²°ì„ ìœ„í•´ ëˆê¸° ìˆê²Œ ë…¸ë ¥í•¨",
        },
        ì§„ë¡œì—­ëŸ‰: {
          3: "í™œë™ì„ í†µí•´ ë¯¸ë””ì–´ ë¶„ì•¼ ë° ë°©ì†¡ ì—°ì¶œì— ëŒ€í•œ ì‹¬ë„ ìˆëŠ” íƒêµ¬ ì—­ëŸ‰ê³¼ ì „ë¬¸ì„±ì„ ì…ì¦í•¨",
          2: "ë°©ì†¡ ë©”ì»¤ë‹ˆì¦˜ì„ ì´í•´í•˜ê³  ìì‹ ì˜ ì§„ë¡œì™€ ì—°ê³„í•˜ì—¬ í™œë™ì„ í™•ì¥í•´ ë‚˜ê°€ëŠ” ëª¨ìŠµì´ ë‹ë³´ì„",
          1: "ìì‹ ì˜ ì§„ë¡œ(ì–¸ë¡ /ì˜ìƒ)ì— ëŒ€í•´ ì§„ì§€í•˜ê²Œ ê³ ë¯¼í•˜ê³  íƒêµ¬í•¨",
          0: "ë°©ì†¡ ì—°ì¶œ ë° ì˜ìƒ ì œì‘ ë¶„ì•¼ì— ëŒ€í•œ ë†’ì€ ê´€ì‹¬ì„ ë³´ì„",
        },
        ê¸°íƒ€: {
          3: "íƒì›”í•œ ë°©ì†¡ ê¸°íš ë° ê¸°ìˆ  ì—­ëŸ‰ì„ ë°œíœ˜í•˜ì—¬ ë™ì•„ë¦¬ ë°œì „ì— í¬ê²Œ ê¸°ì—¬í•¨",
          2: "ìš°ìˆ˜í•œ ì„±ê³¼ë¥¼ ë‚´ë©° ë°©ì†¡ë¶€ í™œë™ì— í™œë ¥ì„ ë¶ˆì–´ë„£ìŒ",
          1: "ì„±ì‹¤í•˜ê²Œ ì°¸ì—¬í•˜ì—¬ ë°©ì†¡ì— ê´€ë ¨ëœ ì˜ë¯¸ ìˆëŠ” ê²½í—˜ì„ ìŒ“ìŒ",
          0: "ê¾¸ì¤€í•œ í™œë™ì„ í†µí•´ ë¯¸ë””ì–´ ì†Œì–‘ì„ ë°œì „ì‹œí‚¤ëŠ” ëª¨ìŠµì„ ë³´ì„",
        },
      };

      let studentHistory = [];
      let finalHistoryStack = [];
      let historyIdCounter = 0;
      let tempContext = null;

      function resolveJosa(word, type) {
        if (!word) return "";
        const lastChar = word.charCodeAt(word.length - 1);
        if (lastChar < 0xac00 || lastChar > 0xd7a3)
          return type === "ul" ? "ì„(ë¥¼)" : "ì´(ê°€)";
        const hasBatchim = (lastChar - 0xac00) % 28 > 0;
        if (type === "ul") return hasBatchim ? "ì„" : "ë¥¼";
        if (type === "i") return hasBatchim ? "ì´" : "ê°€";
        return "";
      }

      window.onload = () => {
        const list = document.getElementById("modalStudentList");
        const div = document.createElement("div");
        div.className = "student-item active";
        div.textContent = "ì´í˜„íƒœ";
        list.appendChild(div);
        renderHistory();
      };

      function openModal() {
        document.getElementById("logModal").style.display = "block";
      }
      function closeModal() {
        document.getElementById("logModal").style.display = "none";
        updateMainSummary();
      }

      function switchTab(tabId, btn) {
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));
        document.getElementById("tab-" + tabId).classList.add("active");
      }

      function toggleRoleInput(prefix) {
        const val = document.getElementById(prefix + "Role").value;
        document.getElementById(prefix + "RoleCustom").style.display =
          val === "custom" ? "block" : "none";
      }

      function saveActivity(type) {
        let data = { id: ++historyIdCounter, type, checked: true };
        let prefix = type === "normal" ? "norm" : "proj";

        data.date = document.getElementById(prefix + "Date").value;
        let roleKey = document.getElementById(prefix + "Role").value;
        let customRole = document
          .getElementById(prefix + "RoleCustom")
          .value.trim();

        if (!data.date) return alert("ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        data.roleKey = roleKey;
        data.roleName =
          roleKey === "custom" && customRole
            ? customRole
            : roleKey === "custom"
            ? "ë™ì•„ë¦¬ì›"
            : ROLE_NAMES[roleKey];
        data.customName = roleKey === "custom" ? data.roleName : null;

        if (type === "normal") {
          data.cat = document.getElementById("normCat").value;
          data.level = document.getElementById("normLevel").value;
          data.content = document.getElementById("normContent").value.trim();
          if (data.cat === "í™œë™ ì˜ì—­") data.cat = "ê¸°íƒ€";
          if (!data.content && data.cat === "ê¸°íƒ€")
            return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ í™œë™ ì˜ì—­ì„ ì„ íƒí•˜ì„¸ìš”.");

          data.hashKey = `NORM|${data.date}|${data.roleName}|${data.cat}|${data.content}`;
        } else {
          data.topic = document.getElementById("projTopic").value.trim();
          data.content = document.getElementById("projContent").value.trim();
          if (!data.topic && !data.content)
            return alert("ì£¼ì œë‚˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

          data.hashKey = `PROJ|${data.date}|${data.roleName}|${data.topic}`;
        }

        if (studentHistory.some((h) => h.hashKey === data.hashKey))
          return alert("ì´ë¯¸ ë“±ë¡ëœ ë™ì¼í•œ í™œë™ì´ ìˆìŠµë‹ˆë‹¤.");

        studentHistory.forEach((h) => (h.checked = false));
        studentHistory.push(data);

        document.getElementById(prefix + "Date").value = "";
        if (type === "normal") {
          document.getElementById("normContent").value = "";
        } else {
          document.getElementById("projTopic").value = "";
          document.getElementById("projContent").value = "";
        }

        renderHistory();
        showToast("ëª©ë¡ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      function renderHistory() {
        const container = document.getElementById("historyListContainer");
        if (!studentHistory.length) {
          container.innerHTML =
            '<div style="text-align:center;color:#999;padding:20px; border:1px solid #e5e7eb; border-radius:8px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        let html = "";
        [...studentHistory]
          .sort((a, b) => b.date.localeCompare(a.date))
          .forEach((item) => {
            let badgeColor = item.type === "normal" ? "#10b981" : "#3b82f6";
            let badgeText = item.type === "normal" ? "ì¼ë°˜" : "í”„ë¡œì íŠ¸";
            let dTitle =
              item.type === "normal"
                ? item.content
                  ? item.content.substring(0, 20) + "..."
                  : `[${item.cat}] í™œë™`
                : item.topic;
            let dDesc = item.content || "(ì˜ì—­ëª…ìœ¼ë¡œ ìë™ ì¹˜í™˜ë¨)";

            html += `
            <div class="history-item" style="${
              item.checked
                ? "border-left:4px solid #1f4ddc;"
                : "border-left:4px solid transparent;"
            }">
                <input type="checkbox" class="history-chk" ${
                  item.checked ? "checked" : ""
                } onchange="toggleCheck(${item.id})" style="margin-top:2px;">
                <div style="flex:1;">
                    <div style="font-size:12px; color:#666; margin-bottom:4px;">
                        <span style="background:#e0f2fe; color:#0369a1; padding:2px 6px; border-radius:4px; font-weight:bold; margin-right:5px;">${
                          item.roleName
                        }</span>
                        ${item.date}
                    </div>
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:6px;">
                        <span style="background:${badgeColor}; color:#fff; font-size:11px; padding:2px 6px; border-radius:4px; font-weight:bold;">${badgeText}</span>
                        <strong style="font-size:14px; color:#333;">${dTitle}</strong>
                    </div>
                    <div style="font-size:13px; color:#555; line-height:1.4;">${dDesc}</div>
                </div>
                <div style="display:flex; flex-direction:column; gap:5px;">
                    <button class="btn sm warning" onclick="editHistory(${
                      item.id
                    })">ìˆ˜ì •</button>
                    <button class="btn sm" style="color:red; border:1px solid #ffcccc; background:#fff;" onclick="deleteHistory(${
                      item.id
                    })">ì‚­ì œ</button>
                </div>
            </div>`;
          });
        container.innerHTML = html;
      }

      function editHistory(id) {
        const item = studentHistory.find((i) => i.id === id);
        if (!item) return;

        studentHistory = studentHistory.filter((i) => i.id !== id);
        renderHistory();
        updateMainSummary();

        let btnIndex = item.type === "normal" ? 0 : 1;
        document.querySelectorAll(".tab-btn")[btnIndex].click();
        let prefix = item.type === "normal" ? "norm" : "proj";

        document.getElementById(prefix + "Date").value = item.date;
        document.getElementById(prefix + "Role").value = item.roleKey;
        toggleRoleInput(prefix);
        if (item.roleKey === "custom")
          document.getElementById(prefix + "RoleCustom").value =
            item.customName;

        if (item.type === "normal") {
          if (item.cat !== "ê¸°íƒ€")
            document.getElementById("normCat").value = item.cat;
          if (item.level !== "ì„±ì·¨ ìˆ˜ì¤€")
            document.getElementById("normLevel").value = item.level;
          document.getElementById("normContent").value = item.content;
        } else {
          document.getElementById("projTopic").value = item.topic;
          document.getElementById("projContent").value = item.content;
        }
      }

      function toggleCheck(id) {
        const item = studentHistory.find((i) => i.id === id);
        if (item) item.checked = !item.checked;
        renderHistory();
        updateMainSummary();
      }
      function checkAll(state) {
        studentHistory.forEach((h) => (h.checked = state));
        renderHistory();
        updateMainSummary();
      }
      function deleteHistory(id) {
        if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        studentHistory = studentHistory.filter((i) => i.id !== id);
        renderHistory();
        updateMainSummary();
      }

      function updateMainSummary() {
        const active = studentHistory.filter((h) => h.checked);
        let text = "[ìƒì„± ëŒ€ê¸° ëª©ë¡]\n\n";
        active
          .sort((a, b) => a.date.localeCompare(b.date))
          .forEach((h, i) => {
            let dTitle =
              h.type === "normal" ? h.content || `(${h.cat} ê´€ë ¨)` : h.topic;
            text += `${i + 1}. [${h.roleName}] ${h.date}\n   : ${dTitle}\n\n`;
          });
        document.getElementById("rawDataDisplay").value = active.length
          ? text
          : "ì²´í¬ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.";
      }

      /* --- ê³ ì • ë™ì•„ë¦¬ëª… ë° ì—­í• ë³„ ì¸íŠ¸ë¡œ ë§µí•‘ --- */
      const CLUB_NAME = "ë°©ì†¡ë¶€";

      const DYN_INTROS = {
        leader: `${CLUB_NAME} íšŒì¥ìœ¼ë¡œì„œ ë›°ì–´ë‚œ ë¦¬ë”ì‹­ê³¼ ì±…ì„ê°ì„ ë°”íƒ•ìœ¼ë¡œ ë¶€ì›ë“¤ì„ ì´ëŒë©° ì „ë°˜ì ì¸ í™œë™ì„ ì£¼ë„í•¨. `,
        sub_leader: `${CLUB_NAME} ë¶€íšŒì¥ìœ¼ë¡œì„œ íšŒì¥ì„ ë³´ì¢Œí•˜ê³  ë¶€ì› ê°„ì˜ ì˜ê²¬ì„ ì¡°ìœ¨í•˜ë©° ì›í™œí•œ ë™ì•„ë¦¬ ìš´ì˜ì— í—Œì‹ í•¨. `,
        exec: `${CLUB_NAME} ì„ì›ìœ¼ë¡œì„œ ë§¡ì€ ë°” ì§ì±…ì„ ì„±ì‹¤íˆ ìˆ˜í–‰í•˜ë©° ë™ì•„ë¦¬ ë°œì „ì— í•µì‹¬ì ì¸ ì—­í• ì„ í•¨. `,
        member: `${CLUB_NAME} ë™ì•„ë¦¬ì›ìœ¼ë¡œì„œ ë™ë£Œë“¤ê³¼ í˜‘ë ¥í•˜ê³  ëª¨ë“  í™œë™ì— ì£¼ë„ì ìœ¼ë¡œ ì°¸ì—¬í•˜ì—¬ ì—­ëŸ‰ì˜ ì„±ì¥ì„ ë³´ì„. `,
      };
      const DYN_TRANS = {
        leader: `ì´í›„ ${CLUB_NAME} íšŒì¥ìœ¼ë¡œ ì„ ì¶œë˜ì–´ ë¦¬ë”ì‹­ì„ ë°œíœ˜í•˜ë©°, `,
        sub_leader: `ë˜í•œ ${CLUB_NAME} ë¶€íšŒì¥ì„ ë§¡ì•„ í—Œì‹ í•˜ë©°, `,
        exec: `ë‚˜ì•„ê°€ ${CLUB_NAME} ì„ì›ìœ¼ë¡œì„œ ì±…ì„ì„ ë‹¤í•˜ë©°, `,
        member: `ì´ì–´ì„œ ${CLUB_NAME} ë™ì•„ë¦¬ í™œë™ì— ì§€ì†ì ìœ¼ë¡œ ì°¸ì—¬í•˜ì—¬, `,
      };
      const OUTRO_TEXT = `ì´ëŸ¬í•œ ${CLUB_NAME} í™œë™ì„ í†µí•´ ìì‹ ì˜ ê´€ì‹¬ ë¶„ì•¼ì— ëŒ€í•œ ì‹¤ë¬´ì  ì „ë¬¸ì„±ì„ ê¸°ë¥´ê³  í›Œë¥­í•œ ì¸ì¬ë¡œ ì„±ì¥í•˜ëŠ” ê³„ê¸°ë¥¼ ë§ˆë ¨í•¨.`;

      function generateClubAI() {
        let targets = studentHistory.filter((h) => h.checked);
        if (targets.length === 0) return alert("ìƒì„±í•  í™œë™ì„ ì„ íƒí•˜ì„¸ìš”.");

        targets.sort((a, b) => a.date.localeCompare(b.date));

        let blocks = [];
        let currentBlock = { roleKey: null, roleName: null, items: [] };

        targets.forEach((item) => {
          if (currentBlock.roleName !== item.roleName) {
            if (currentBlock.roleName !== null) blocks.push(currentBlock);
            currentBlock = {
              roleKey: item.roleKey,
              roleName: item.roleName,
              customName: item.customName,
              items: [item],
            };
          } else {
            currentBlock.items.push(item);
          }
        });
        if (currentBlock.roleName !== null) blocks.push(currentBlock);

        let finalParagraphs = [];
        let summaryData = {};
        let actsMapping = [];

        blocks.forEach((block, index) => {
          let intro = "";
          if (index === 0) {
            intro =
              block.roleKey === "custom"
                ? `${block.customName}ë¡œì„œ ${CLUB_NAME} í™œë™ì— ì£¼ë„ì ìœ¼ë¡œ ì°¸ì—¬í•˜ë©°, `
                : DYN_INTROS[block.roleKey];
          } else {
            intro =
              block.roleKey === "custom"
                ? `ë˜í•œ, ${block.customName} ì—­í• ì„ ë§¡ì•„ `
                : DYN_TRANS[block.roleKey];
          }

          let contentMap = new Map();
          block.items.forEach((item) => {
            let coreContent = item.content.trim();
            if (!coreContent && item.cat) coreContent = `${item.cat} ê´€ë ¨ í™œë™`;

            let cKey =
              item.type === "normal"
                ? `NORMAL|${coreContent}`
                : `PROJ|${item.topic.trim()}`;
            if (!contentMap.has(cKey)) contentMap.set(cKey, []);
            contentMap.get(cKey).push(item);

            actsMapping.push({
              hashKey: item.hashKey,
              name:
                item.type === "normal"
                  ? item.content.substring(0, 10) || item.cat
                  : item.topic,
            });
          });

          let body = "";
          let blockSummary = [];

          for (let [cKey, cItems] of contentMap) {
            const count = cItems.length;
            const first = cItems[0];
            let freqAdverb =
              count === 2
                ? "ì§€ì†ì ìœ¼ë¡œ"
                : count >= 3
                ? "ë§¤íšŒ ë¹ ì§ì—†ì´ ì£¼ë„ì ìœ¼ë¡œ"
                : "";

            if (first.type === "normal") {
              let actName =
                first.content.trim() || `[${first.cat} ì—­ëŸ‰] ê´€ë ¨ í™œë™`;
              const josa = resolveJosa(actName, "ul");

              let bestLvlStr = "ë³´í†µ";
              const lvlMap = { ë§¤ìš°ìš°ìˆ˜: 3, ìš°ìˆ˜: 2, ë³´í†µ: 1, ë…¸ë ¥: 0 };
              cItems.forEach((i) => {
                if (lvlMap[i.level] > lvlMap[bestLvlStr]) bestLvlStr = i.level;
              });
              let lvlScore = lvlMap[bestLvlStr];

              let ending = CAT_ENDINGS[first.cat]
                ? CAT_ENDINGS[first.cat][lvlScore]
                : CAT_ENDINGS["ê¸°íƒ€"][lvlScore];

              body += `${actName}${josa} ${freqAdverb} ${ending}. `;
              blockSummary.push(`${actName}(${count})`);
            } else {
              const tJosa = resolveJosa(first.topic, "ul");
              let pContent = first.content.trim() || "ìœ ì˜ë¯¸í•œ ê²°ê³¼ë¬¼";
              if (count >= 2)
                body += `${first.topic}${tJosa} ì£¼ì œë¡œ ì‹¬í™” í”„ë¡œì íŠ¸ë¥¼ ${freqAdverb} ì§„í–‰í•˜ì—¬ ${pContent}ë¥¼ ë„ì¶œí•¨. `;
              else
                body += `${first.topic}${tJosa} ì£¼ì œë¡œ ë¯¸ë””ì–´ í”„ë¡œì íŠ¸ë¥¼ ìˆ˜í–‰í•˜ì—¬ ${pContent}ë¥¼ ì™„ì„±í•¨. `;
              blockSummary.push(`[P]${first.topic}(${count})`);
            }
          }
          finalParagraphs.push(intro + body.trim());
          if (!summaryData[block.roleName]) summaryData[block.roleName] = [];
          summaryData[block.roleName].push(...blockSummary);
        });

        let resultText = finalParagraphs.join(" ") + " " + OUTRO_TEXT;
        resultText = resultText
          .replace(/['"\[\]]/g, "")
          .replace(/\s+/g, " ")
          .trim();

        document.getElementById("tempDraft").value = resultText;
        tempContext = {
          summary: summaryData,
          actsMap: actsMapping,
          len: resultText.length,
        };
        showToast(`AI ë¬¸ë‹¨ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (ì ìš© ë™ì•„ë¦¬: ${CLUB_NAME})`);
      }

      function updateDuplicateStatus() {
        let hashCounts = {};
        finalHistoryStack.forEach((item) => {
          if (item.status === "active" && item.actsMap) {
            item.actsMap.forEach((act) => {
              hashCounts[act.hashKey] = (hashCounts[act.hashKey] || 0) + 1;
            });
          }
        });
        finalHistoryStack.forEach((item) => {
          if (item.status === "active" && item.actsMap) {
            let dupActs = item.actsMap.filter(
              (act) => hashCounts[act.hashKey] > 1
            );
            item.isDuplicate = dupActs.length > 0;
            item.dupNames = dupActs.map((a) => a.name);
          } else {
            item.isDuplicate = false;
            item.dupNames = [];
          }
        });
      }

      function moveToFinal() {
        const text = document.getElementById("tempDraft").value;
        const preview = document.getElementById("finalPreview");
        if (!text || !tempContext) return alert("ìƒì„±ëœ ë¬¸ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.");

        let duplicateNames = [];
        tempContext.actsMap.forEach((act) => {
          if (
            finalHistoryStack.some(
              (fh) =>
                fh.status === "active" &&
                fh.actsMap &&
                fh.actsMap.some((a) => a.hashKey === act.hashKey)
            )
          ) {
            duplicateNames.push(act.name);
          }
        });
        let isDuplicate = duplicateNames.length > 0;

        if (preview.innerText.trim() === "") preview.innerText = "";
        else preview.appendChild(document.createTextNode(" "));

        const uniqueId = "block_" + Date.now();
        const span = document.createElement("span");
        span.className = "sentence-block";
        span.id = uniqueId;
        span.innerText = text;
        preview.appendChild(span);

        finalHistoryStack.push({
          id: uniqueId,
          summary: tempContext.summary,
          actsMap: tempContext.actsMap,
          len: text.length,
          status: "active",
          isDuplicate: isDuplicate,
          dupNames: duplicateNames,
        });

        updateDuplicateStatus();
        renderInfoLayer();
        updateByte();
      }

      function renderInfoLayer() {
        const con = document.getElementById("infoContentContainer");
        con.innerHTML = "";
        if (finalHistoryStack.length === 0) {
          con.innerHTML = "ìƒì„± ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        finalHistoryStack.forEach((item) => {
          const div = document.createElement("div");
          div.className = `info-card ${item.status} ${
            item.isDuplicate ? "duplicate" : ""
          }`;
          div.onclick = () => highlightSentence(item.id);

          let contentHtml = "";
          for (const [role, acts] of Object.entries(item.summary)) {
            let tags = acts
              .map((a) => `<span class="tag">${a}</span>`)
              .join("");
            contentHtml += `<div class="info-role-group"><div class="info-role-title">ğŸ‘¤ ${role}</div><div class="info-tags">${tags}</div></div>`;
          }

          // [ìˆ˜ì • ì™„ë£Œ] ìµœì í™”ëœ ìƒíƒœ(optimized)ì—ì„œë„ ì‚­ì œ ë²„íŠ¼ì´ í•­ìƒ ë³´ì´ë„ë¡ ë³€ê²½
          let delBtn = `<button class="delete-sentence-btn" onclick="deleteFinalSentence(event, '${item.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>`;
          let dupAlert = item.isDuplicate
            ? `<span class="dup-badge" style="margin-left:8px;" title="${item.dupNames.join(
                ", "
              )} ì¤‘ë³µ">âš ï¸ ì¤‘ë³µ ê°ì§€</span>`
            : "";

          let statBadge = "";
          if (item.status === "deleted")
            statBadge =
              "<span class='status-badge' style='background:#ef4444;'>âŒ ì‚­ì œë¨</span>";
          else if (item.status === "modified")
            statBadge = "<span class='status-badge'>âœ… ì§ì ‘ ìˆ˜ì •í•¨</span>";
          else if (item.status === "optimized")
            statBadge =
              "<span class='status-badge' style='background:#8b5cf6;'>ğŸª„ ë¬¸ë§¥ ìµœì í™”ë¨</span>";

          div.innerHTML = `
            <div class="info-header">
                <span style="display:flex; align-items:center;">ğŸ“ ë™ì•„ë¦¬ í™œë™ ë¬¸ë‹¨ ${dupAlert}</span>
                ${delBtn}
            </div>
            ${
              item.status !== "active"
                ? `<div style="margin-bottom:6px;">${statBadge}</div>`
                : ""
            }
            ${contentHtml}`;
          con.appendChild(div);
        });
      }

      function highlightSentence(id) {
        document
          .querySelectorAll(".sentence-block")
          .forEach((el) => el.classList.remove("highlight-active"));
        const target = document.getElementById(id);
        if (target) {
          target.scrollIntoView({ behavior: "smooth", block: "center" });
          target.classList.add("highlight-active");
          setTimeout(() => {
            target.classList.remove("highlight-active");
          }, 2000);
        }
      }

      function deleteFinalSentence(event, id) {
        event.stopPropagation();
        const target = document.getElementById(id);
        if (target) {
          if (target.previousSibling && target.previousSibling.nodeType === 3)
            target.previousSibling.remove();
          target.remove();
        }
        finalHistoryStack = finalHistoryStack.filter((item) => item.id !== id);
        updateDuplicateStatus();
        renderInfoLayer();
        updateByte();
        showToast("ë¬¸ë‹¨ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      /* --- [ìµœì í™” ë‹¤ë“¬ê¸° ì—”ì§„] --- */
      function checkIntegrity() {
        let text = document.getElementById("finalPreview").innerText;
        if (!text.trim()) return showToast("ë‹¤ë“¬ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");

        // 1. ì¸íŠ¸ë¡œ(ì£¼ì–´) ì¤‘ë³µ ì œê±°
        Object.values(DYN_INTROS).forEach((intro) => {
          let parts = text.split(intro);
          if (parts.length > 2) {
            let newText = parts[0] + intro;
            for (let i = 1; i < parts.length; i++) {
              newText += " " + parts[i].trimStart();
            }
            text = newText;
          }
        });

        // 2. ì•„ì›ƒíŠ¸ë¡œ ì¤‘ë³µ ì œê±°
        let outroParts = text.split(OUTRO_TEXT);
        if (outroParts.length > 1) {
          text = outroParts.join(" ").trim() + " " + OUTRO_TEXT;
        }

        // 3. ë‹¤ì¤‘ ê³µë°± ì •ì œ
        text = text.replace(/\s+/g, " ").trim();

        // 4. í”„ë¦¬ë·° ë¸”ë¡ í†µí•© êµì²´
        const preview = document.getElementById("finalPreview");
        preview.innerHTML = "";

        const uniqueId = "opt_" + Date.now();
        const span = document.createElement("span");
        span.className = "sentence-block";
        span.id = uniqueId;
        span.innerText = text;
        preview.appendChild(span);

        // 5. ë°±ê·¸ë¼ìš´ë“œ ìŠ¤íƒ ë‹¨ì¼í™” ë³‘í•©
        let mergedActs = [];
        let mergedSummary = {};

        finalHistoryStack.forEach((item) => {
          if (item.status !== "deleted") {
            if (item.actsMap) mergedActs.push(...item.actsMap);
            for (const [role, acts] of Object.entries(item.summary)) {
              if (!mergedSummary[role]) mergedSummary[role] = [];
              mergedSummary[role].push(...acts);
            }
          }
        });

        for (let role in mergedSummary) {
          mergedSummary[role] = [...new Set(mergedSummary[role])];
        }

        finalHistoryStack = [
          {
            id: uniqueId,
            summary: mergedSummary,
            actsMap: mergedActs,
            len: text.length,
            status: "optimized",
            isDuplicate: false,
            dupNames: [],
          },
        ];

        renderInfoLayer();
        updateByte();
        showToast("ì£¼ì–´ ì¤‘ë³µ ë° ë¬¸ë§¥ì´ ì™„ë²½í•˜ê²Œ ìµœì í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      function clearFinal() {
        if (confirm("ì „ì²´ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          document.getElementById("finalPreview").innerText = "";
          finalHistoryStack = [];
          renderInfoLayer();
          updateByte();
        }
      }
      function updateByte() {
        const text = document.getElementById("finalPreview").innerText;
        let bytes = 0;
        for (let i = 0; i < text.length; i++)
          bytes += text.charCodeAt(i) > 127 ? 3 : 1;
        document.getElementById("byteCount").innerText = bytes;
        document.getElementById("byteCount").style.color =
          bytes > 1500 ? "red" : "#1f4ddc";
      }
      function finalApply() {
        alert("NEIS ì…ë ¥ ì™„ë£Œ");
      }
      function showToast(m) {
        const t = document.getElementById("toast");
        t.textContent = m;
        t.style.opacity = 1;
        setTimeout(() => (t.style.opacity = 0), 2000);
      }
    </script>
  </body>
</html>
