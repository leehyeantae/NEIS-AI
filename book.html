<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ë…ì„œí™œë™ìƒí™©ê´€ë¦¬ - íŒŒì¼ ê¸°ëŠ¥ ê°•í™”</title>
    <style>
      /* [ê¸°ì¡´ ë””ìì¸ ìœ ì§€] */
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", -apple-system, sans-serif;
        background: #f5f6f8;
        color: #333;
      }

      .topbar {
        height: 48px;
        background: #f5c6cf;
        display: flex;
        align-items: center;
        padding: 0 16px;
        font-weight: 700;
        border-bottom: 1px solid #e5adba;
        color: #333;
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        height: calc(100vh - 48px);
      }
      .left,
      .right {
        padding: 25px;
        background: #fff;
        overflow-y: auto;
      }
      .left {
        border-right: 1px solid #e5e7eb;
      }

      /* ì…ë ¥ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
      .card {
        border-radius: 12px;
        border: 1px solid #d1d5db;
        background: #fff;
        padding: 25px;
        margin-bottom: 20px;
        position: relative;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .card-title {
        font-weight: 700;
        margin-bottom: 15px;
        font-size: 16px;
        color: #1f2937;
        border-bottom: 2px solid #f3f4f6;
        padding-bottom: 10px;
      }
      .field {
        margin-bottom: 15px;
      }

      .label {
        font-size: 13px;
        font-weight: 600;
        color: #4b5563;
        margin-bottom: 6px;
        display: block;
      }
      .input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 14px;
        transition: border 0.2s;
        background: #fff;
      }
      .input:focus {
        outline: none;
        border-color: #1f4ddc;
        box-shadow: 0 0 0 3px rgba(31, 77, 220, 0.1);
      }

      .btn {
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid #d1d5db;
        background: #fff;
        transition: 0.2s;
        color: #374151;
      }
      .btn:hover {
        background: #f9fafb;
        border-color: #9ca3af;
      }
      .btn.primary {
        background: #1f4ddc;
        color: #fff;
        border-color: #163aa5;
      }
      .btn.primary:hover {
        background: #1b43c1;
      }
      .btn.danger {
        background: #fff;
        color: #e11d48;
        border-color: #ffcccc;
      }
      .btn.danger:hover {
        background: #fff1f2;
      }
      .btn.success {
        background: #10b981;
        color: #fff;
        border-color: #059669;
      }
      .btn.success:hover {
        background: #059669;
      }

      .btn.add {
        width: 100%;
        margin-top: 10px;
        background: #eff6ff;
        border-color: #bfdbfe;
        color: #1d4ed8;
        padding: 12px;
      }
      .btn.add:hover {
        background: #dbeafe;
      }

      .btn-row {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 20px;
      }

      /* ìë™ ì™„ì„± */
      .autocomplete-wrapper {
        position: relative;
      }
      .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 100;
        background: #fff;
        border: 1px solid #d1d5db;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: none;
      }
      .autocomplete-item {
        padding: 10px 15px;
        font-size: 14px;
        cursor: pointer;
      }
      .autocomplete-item:hover,
      .autocomplete-item.selected {
        background: #eff6ff;
        color: #1f4ddc;
      }

      /* í•™ìƒ ì„ íƒ ì˜ì—­ */
      .student-selector-area {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px dashed #e5e7eb;
      }
      .student-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
      }
      .student-select-btn {
        padding: 8px 14px;
        border-radius: 20px;
        border: 1px solid #d1d5db;
        background: #fff;
        font-size: 13px;
        cursor: pointer;
        transition: 0.2s;
        color: #4b5563;
      }
      .student-select-btn:hover {
        background: #f3f4f6;
      }
      .student-select-btn.active {
        background: #1f4ddc;
        color: #fff;
        border-color: #1f4ddc;
        font-weight: 600;
      }
      .selection-controls {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }
      .selection-controls .btn {
        padding: 6px 12px;
        font-size: 12px;
      }
      .selection-status {
        font-size: 13px;
        color: #6b7280;
      }

      /* ìš°ì¸¡ ì˜ì—­ */
      .right-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .right-title {
        font-weight: 700;
        font-size: 18px;
        color: #1f2937;
      }
      .right-buttons {
        display: flex;
        gap: 8px;
      }

      .student-record-block {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        background: #fff;
        transition: all 0.2s ease;
      }
      .student-record-block:hover {
        border-color: #1f4ddc;
      }
      .student-record-block.delete-mode-active {
        cursor: pointer;
        border-color: #fca5a5;
      }
      .student-record-block.delete-mode-active:hover {
        background: #fef2f2;
        border-color: #ef4444;
      }

      .record-name-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f3f4f6;
      }
      .record-name {
        font-weight: 700;
        color: #1f4ddc;
        font-size: 15px;
      }
      .char-count {
        font-size: 13px;
        font-weight: 600;
        color: #6b7280;
      }

      .record-content {
        font-size: 14px;
        color: #374151;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-all;
      }
      .no-record {
        color: #9ca3af;
        font-style: italic;
      }

      /* [ìˆ˜ì •] ì¦ë¹™ìë£Œ ìŠ¤íƒ€ì¼ ê°•í™” */
      .doc-list-container {
        margin-top: 15px;
        padding-top: 12px;
        border-top: 1px dashed #e5e7eb;
        font-size: 13px;
      }
      .doc-list-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
      }
      .doc-list-header span {
        font-weight: 600;
        color: #4b5563;
      }
      .doc-list {
        padding-left: 0;
        list-style: none;
        margin: 0;
      }

      /* ê°œë³„ íŒŒì¼ ì•„ì´í…œ */
      .doc-item {
        color: #2563eb;
        padding: 4px 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f0f9ff;
        border-radius: 6px;
        margin-bottom: 4px;
        border: 1px solid #dbeafe;
      }
      .doc-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* ì‚­ì œ ë²„íŠ¼ */
      .btn-del-doc {
        background: transparent;
        border: none;
        color: #ef4444;
        font-weight: bold;
        cursor: pointer;
        padding: 2px 6px;
        font-size: 12px;
        border-radius: 4px;
      }
      .btn-del-doc:hover {
        background: #fee2e2;
      }

      .no-doc-item {
        color: #9ca3af;
        padding: 4px 0;
        font-style: italic;
      }

      #toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 10px 25px;
        border-radius: 30px;
        font-size: 13px;
        opacity: 0;
        transition: 0.3s;
        pointer-events: none;
        z-index: 2000;
      }
      #toast.show {
        opacity: 1;
        bottom: 40px;
      }
    </style>
  </head>

  <body>
    <div id="toast">ì•Œë¦¼</div>
    <div class="topbar">ë…ì„œí™œë™ìƒí™©ê´€ë¦¬</div>

    <div class="container">
      <section class="left">
        <div id="bookList"></div>
        <button class="btn add" id="btnAddBook">+ ë„ì„œ ê¸°ë¡ ì¹´ë“œ ì¶”ê°€</button>
      </section>

      <section class="right">
        <div class="right-header">
          <div class="right-title">í•™ê¸‰ í•™ìƒë³„ ë…ì„œ ê¸°ë¡ í˜„í™©</div>
          <div class="right-buttons">
            <button type="button" class="btn danger" id="btnDeleteMode">
              ê¸°ë¡ ì‚­ì œ ëª¨ë“œ
            </button>
            <button type="button" class="btn success" id="btnCopy">
              ğŸ’¾ ì ìš©í•˜ê¸°
            </button>
          </div>
        </div>

        <div id="studentRecordsList"></div>
      </section>
    </div>

    <div id="toast" class="toast"></div>

    <script>
      const bookList = document.getElementById("bookList");
      const MAX_BYTE = 1500;

      const STUDENT_LIST = [
        { id: "s1", name: "ê¹€íƒœì—°" },
        { id: "s2", name: "ë°•ì§€ì„±" },
        { id: "s3", name: "ìµœë¯¼í˜¸" },
        { id: "s4", name: "ì •ì†Œë¯¼" },
        { id: "s5", name: "ì´í•˜ì€" },
      ];

      const DUMMY_BOOKS = [
        { title: "ì½”ìŠ¤ëª¨ìŠ¤", author: "ì¹¼ ì„¸ì´ê±´" },
        { title: "ì‚¬í”¼ì—”ìŠ¤", author: "ìœ ë°œ í•˜ë¼ë¦¬" },
        { title: "ë°ë¯¸ì•ˆ", author: "í—¤ë¥´ë§Œ í—¤ì„¸" },
        { title: "ì´, ê· , ì‡ ", author: "ì¬ë ˆë“œ ë‹¤ì´ì•„ëª¬ë“œ" },
        { title: "ì´ê¸°ì  ìœ ì „ì", author: "ë¦¬ì²˜ë“œ ë„í‚¨ìŠ¤" },
        { title: "ë¯¸ì›€ë°›ì„ ìš©ê¸°", author: "ê¸°ì‹œë¯¸ ì´ì¹˜ë¡œ" },
        { title: "íŒ©íŠ¸í’€ë‹ˆìŠ¤", author: "í•œìŠ¤ ë¡œìŠ¬ë§" },
        { title: "ì–´ë¦° ì™•ì", author: "ì•™íˆ¬ì•ˆ ë“œ ìƒí…ì¥í˜ë¦¬" },
        { title: "ëˆìœ¼ë¡œ ì‚´ ìˆ˜ ì—†ëŠ” ê²ƒë“¤", author: "ë§ˆì´í´ ìƒŒë¸" },
        { title: "ì¹¨ë¬µì˜ ë´„", author: "ë ˆì´ì²¼ ì¹´ìŠ¨" },
        { title: "ë…¸ì¸ê³¼ ë°”ë‹¤", author: "ì–´ë‹ˆìŠ¤íŠ¸ í—¤ë°ì›¨ì´" },
        { title: "í˜¸ëª¨ ë°ìš°ìŠ¤", author: "ìœ ë°œ í•˜ë¼ë¦¬" },
        { title: "ì‹œê°„ì€ íë¥´ì§€ ì•ŠëŠ”ë‹¤", author: "ì¹´ë¥¼ë¡œ ë¡œë²¨ë¦¬" },
        { title: "íŒŒê³¼", author: "êµ¬ë³‘ëª¨" },
        { title: "82ë…„ìƒ ê¹€ì§€ì˜", author: "ì¡°ë‚¨ì£¼" },
        { title: "ì—­ì‚¬ì˜ ì“¸ëª¨", author: "ìµœíƒœì„±" },
        { title: "ì›ì”½", author: "ê²Œë¦¬ ì¼ˆëŸ¬" },
      ];

      let studentRecords = new Map();
      let studentDocuments = new Map();
      STUDENT_LIST.forEach((s) => {
        studentRecords.set(s.id, "");
        studentDocuments.set(s.id, []);
      });
      let isDeleteMode = false;
      let cardIdCounter = 0;

      function showToast(msg) {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 1500);
      }

      function getByteLength(s) {
        let b = 0;
        for (let i = 0; i < s.length; i++) {
          const c = s.charCodeAt(i);
          b += c >> 7 ? 3 : 1;
        }
        return b;
      }

      function sliceByByte(str, maxByte) {
        let b = 0;
        let result = "";
        for (let i = 0; i < str.length; i++) {
          const c = str.charCodeAt(i);
          const size = c >> 7 ? 3 : 1;
          if (b + size > maxByte) break;
          b += size;
          result += str[i];
        }
        return result;
      }

      // [ìˆ˜ì •] íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ (ëˆ„ì  ì €ì¥ ë°©ì‹)
      function handleDocumentUpload(event) {
        const fileInput = event.target;
        const studentId = fileInput.dataset.studentId;
        const student = STUDENT_LIST.find((s) => s.id === studentId);

        if (fileInput.files.length > 0) {
          const newFileNames = Array.from(fileInput.files).map(
            (file) => file.name
          );
          const currentDocs = studentDocuments.get(studentId) || [];

          // ê¸°ì¡´ íŒŒì¼ ëª©ë¡ì— ìƒˆ íŒŒì¼ ëª©ë¡ ì¶”ê°€ (ëˆ„ì )
          studentDocuments.set(studentId, [...currentDocs, ...newFileNames]);

          showToast(
            `${student.name} í•™ìƒì—ê²Œ ${newFileNames.length}ê°œì˜ íŒŒì¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`
          );
        }
        renderStudentRecords();
        fileInput.value = null; // ì…ë ¥ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ)
      }

      // [ì¶”ê°€] ê°œë³„ íŒŒì¼ ì‚­ì œ í•¨ìˆ˜
      function deleteDocument(studentId, docIndex) {
        const student = STUDENT_LIST.find((s) => s.id === studentId);
        if (!confirm(`${student.name} í•™ìƒì˜ í•´ë‹¹ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))
          return;

        const currentDocs = studentDocuments.get(studentId);
        currentDocs.splice(docIndex, 1); // í•´ë‹¹ ì¸ë±ìŠ¤ íŒŒì¼ ì œê±°
        studentDocuments.set(studentId, currentDocs);

        renderStudentRecords();
        showToast("íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      function renderStudentRecords() {
        const listEl = document.getElementById("studentRecordsList");
        listEl.innerHTML = "";

        STUDENT_LIST.forEach((student, index) => {
          const wrap = document.createElement("div");
          wrap.className = "student-record-block";
          wrap.dataset.id = student.id;

          if (isDeleteMode) wrap.classList.add("delete-mode-active");

          const recordText = studentRecords.get(student.id).trim();
          const docList = studentDocuments.get(student.id);

          const finalCopyText = recordText.replace(/[ã€ã€]/g, "");
          const totalByte = getByteLength(finalCopyText);

          let contentHtml;
          if (recordText) {
            contentHtml = `<div class="record-content">${finalCopyText}</div>`;
          } else {
            contentHtml = `<div class="record-content no-record">ì…ë ¥ëœ ë…ì„œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
          }

          // [ìˆ˜ì •] íŒŒì¼ ëª©ë¡ ë Œë”ë§ (ì‚­ì œ ë²„íŠ¼ í¬í•¨)
          const docListItems =
            docList.length > 0
              ? docList
                  .map(
                    (name, idx) => `
                  <li class="doc-item">
                    <span class="doc-name">ğŸ“ ${name}</span>
                    <button class="btn-del-doc" onclick="event.stopPropagation(); deleteDocument('${student.id}', ${idx})">âœ•</button>
                  </li>
                `
                  )
                  .join("")
              : `<li class="no-doc-item">ì—…ë¡œë“œëœ íŒŒì¼ ì—†ìŒ</li>`;

          const docControlHtml = `
              <div class="doc-list-container">
                  <div class="doc-list-header">
                      <span>ì¦ë¹™ìë£Œ (${docList.length}ê°œ):</span>
                      <input type="file" id="upload_${student.id}" style="display: none;" 
                             data-student-id="${student.id}" multiple onchange="handleDocumentUpload(event)" />
                      <button type="button" class="btn sm" 
                          style="background: #e0f7fa; color: #006064; border-color: #b2ebf2;"
                          onclick="event.stopPropagation(); document.getElementById('upload_${student.id}').click()">
                          + íŒŒì¼ ì¶”ê°€
                      </button>
                  </div>
                  <ul class="doc-list">${docListItems}</ul>
              </div>
          `;

          wrap.innerHTML = `
            <div class="record-name-row">
                <div class="record-name">${index + 1}. ${student.name}</div>
                <div class="char-count" style="color: ${
                  totalByte > MAX_BYTE ? "#ef4444" : "#6b7280"
                }">
                    ${totalByte} Byte / ${MAX_BYTE} Byte
                </div>
            </div>
            <div style="font-size: 13px; font-weight: 600; margin-bottom: 6px; color:#4b5563;">ì‘ì„± ë‚´ìš©:</div>
            ${contentHtml}
            ${docControlHtml}
          `;

          wrap.addEventListener("click", () => {
            if (isDeleteMode) deleteStudentRecords(student.id, student.name);
          });
          listEl.appendChild(wrap);
        });
      }

      function deleteStudentRecords(studentId, studentName) {
        if (confirm(`${studentName} í•™ìƒì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          studentRecords.set(studentId, "");
          studentDocuments.set(studentId, []);
          showToast(`${studentName} í•™ìƒì˜ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          renderStudentRecords();
        }
      }

      function createStudentSelectorHTML(cardId) {
        let buttonsHTML = STUDENT_LIST.map(
          (student) => `
              <button type="button" class="student-select-btn" 
                  data-id="${student.id}" data-name="${student.name}">${student.name}</button>
          `
        ).join("");

        return `
              <div class="student-selector-area">
                  <div class="label">ğŸ“š ê¸°ë¡ì„ ì ìš©í•  í•™ìƒ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</div>
                  <div class="selection-controls">
                      <button type="button" class="btn" id="${cardId}_select_all">ì „ì²´ ì„ íƒ</button>
                      <button type="button" class="btn" id="${cardId}_clear_all">ì „ì²´ ì·¨ì†Œ</button>
                  </div>
                  <div class="student-buttons" id="${cardId}_student_buttons">${buttonsHTML}</div>
                  <div class="selection-status" id="${cardId}_selection_status">ì„ íƒëœ í•™ìƒ: 0ëª…</div>
              </div>
          `;
      }

      function updateSelectionStatus(cardId) {
        const cardEl = document.getElementById(cardId);
        const activeButtons = cardEl.querySelectorAll(
          ".student-select-btn.active"
        );
        const statusEl = document.getElementById(`${cardId}_selection_status`);
        const names = Array.from(activeButtons).map((btn) => btn.dataset.name);

        if (names.length === 0) statusEl.textContent = "ì„ íƒëœ í•™ìƒ: 0ëª…";
        else if (names.length <= 3)
          statusEl.textContent = `ì„ íƒëœ í•™ìƒ: ${names.join(", ")} (${
            names.length
          }ëª…)`;
        else
          statusEl.textContent = `ì„ íƒëœ í•™ìƒ: ${names[0]} ì™¸ ${
            names.length - 1
          }ëª… (${names.length}ëª…)`;
      }

      function createBookCard() {
        cardIdCounter++;
        const id = `book_${cardIdCounter}`;
        const card = document.createElement("div");
        card.className = "card";
        card.id = id;
        card.innerHTML = `
        <div class="card-title">ğŸ“– ë…ì„œ ê¸°ë¡ ì…ë ¥ ì¹´ë“œ ${cardIdCounter}</div>
        
        <div class="field">
          <div class="label">ë„ì„œëª… ê²€ìƒ‰ (ìë™ ì™„ì„±)</div>
          <div class="autocomplete-wrapper">
            <input type="text" class="input book-title" id="${id}_search_title" placeholder="ì±… ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì½”ìŠ¤ëª¨ìŠ¤)" autocomplete="off" />
            <div class="autocomplete-results" id="${id}_results" style="display: none;"></div>
          </div>
        </div>

        <div class="field" style="display: flex; gap: 10px;">
            <div style="flex: 1;">
              <div class="label">í™•ì •ëœ ì±… ì œëª©</div>
              <input type="text" class="input final-title" id="${id}_final_title" placeholder="ì œëª©" />
            </div>
            <div style="flex: 1;">
              <div class="label">í™•ì •ëœ ì €ì</div>
              <input type="text" class="input final-author" id="${id}_final_author" placeholder="ì €ì" />
            </div>
        </div>

        ${createStudentSelectorHTML(id)}
        
        <div class="btn-row">
            <button class="btn danger" id="${id}_delete">ì¹´ë“œ ì‚­ì œ</button>
            <button class="btn primary" id="${id}_apply">ì„ íƒ í•™ìƒì—ê²Œ ì ìš©</button>
        </div>
      `;

        setTimeout(() => {
          const cardEl = document.getElementById(id);
          const titleInput = document.getElementById(`${id}_search_title`);
          const resultsEl = document.getElementById(`${id}_results`);
          const studentButtonsEl = document.getElementById(
            `${id}_student_buttons`
          );
          const finalTitleInput = document.getElementById(`${id}_final_title`);
          const finalAuthorInput = document.getElementById(
            `${id}_final_author`
          );

          let selectedIndex = -1;
          const updateAutocomplete = () => {
            const query = titleInput.value.toLowerCase().trim();
            resultsEl.innerHTML = "";
            if (query.length < 2) {
              resultsEl.style.display = "none";
              selectedIndex = -1;
              return;
            }
            const filtered = DUMMY_BOOKS.filter(
              (book) =>
                book.title.toLowerCase().includes(query) ||
                book.author.toLowerCase().includes(query)
            );
            if (filtered.length === 0) {
              resultsEl.style.display = "none";
              selectedIndex = -1;
              return;
            }

            filtered.forEach((book) => {
              const item = document.createElement("div");
              item.className = "autocomplete-item";
              item.textContent = `${book.title} (${book.author})`;
              item.addEventListener("click", () =>
                selectBook(book.title, book.author)
              );
              resultsEl.appendChild(item);
            });
            resultsEl.style.display = "block";
            selectedIndex = -1;
          };

          const selectBook = (title, author) => {
            titleInput.value = `${title} (${author})`;
            finalTitleInput.value = title;
            finalAuthorInput.value = author;
            resultsEl.style.display = "none";
            showToast(`'${title}' ì„ íƒë¨`);
          };

          titleInput.addEventListener("keydown", (e) => {
            const items = resultsEl.querySelectorAll(".autocomplete-item");
            if (items.length === 0) return;
            if (e.key === "ArrowDown") {
              e.preventDefault();
              selectedIndex = (selectedIndex + 1) % items.length;
            } else if (e.key === "ArrowUp") {
              e.preventDefault();
              selectedIndex = (selectedIndex - 1 + items.length) % items.length;
            } else if (e.key === "Enter") {
              e.preventDefault();
              if (selectedIndex !== -1) items[selectedIndex].click();
              return;
            }
            items.forEach((item, index) =>
              item.classList.toggle("selected", index === selectedIndex)
            );
            if (selectedIndex !== -1)
              items[selectedIndex].scrollIntoView({ block: "nearest" });
          });
          titleInput.addEventListener("input", updateAutocomplete);
          titleInput.addEventListener("blur", () => {
            setTimeout(() => {
              resultsEl.style.display = "none";
            }, 200);
          });

          studentButtonsEl.addEventListener("click", (e) => {
            if (e.target.classList.contains("student-select-btn")) {
              e.target.classList.toggle("active");
              updateSelectionStatus(id);
            }
          });

          document
            .getElementById(`${id}_select_all`)
            .addEventListener("click", () => {
              cardEl
                .querySelectorAll(".student-select-btn")
                .forEach((btn) => btn.classList.add("active"));
              updateSelectionStatus(id);
            });

          document
            .getElementById(`${id}_clear_all`)
            .addEventListener("click", () => {
              cardEl
                .querySelectorAll(".student-select-btn")
                .forEach((btn) => btn.classList.remove("active"));
              updateSelectionStatus(id);
            });

          document
            .getElementById(`${id}_apply`)
            .addEventListener("click", () => applyBookRecord(id));
          document
            .getElementById(`${id}_delete`)
            .addEventListener("click", () => {
              card.remove();
              showToast("ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            });

          updateSelectionStatus(id);
        }, 10);
        return card;
      }

      function applyBookRecord(cardId) {
        const cardEl = document.getElementById(cardId);
        const finalTitle = cardEl.querySelector(".final-title").value.trim();
        const finalAuthor = cardEl.querySelector(".final-author").value.trim();
        const selectedStudentButtons = cardEl.querySelectorAll(
          ".student-select-btn.active"
        );

        if (!finalTitle || !finalAuthor)
          return showToast("ì±… ì œëª©ê³¼ ì €ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        if (selectedStudentButtons.length === 0)
          return showToast("í•™ìƒì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");

        let cleanTitle = finalTitle.replace(/[()]/g, "").trim();
        const finalRecord = `ã€${cleanTitle}ã€(${finalAuthor})`;
        const selectedStudentIds = Array.from(selectedStudentButtons).map(
          (btn) => btn.dataset.id
        );
        let appliedCount = 0;

        selectedStudentIds.forEach((studentId) => {
          let currentText = studentRecords.get(studentId).trim();
          if (currentText.includes(finalRecord)) return;
          let merged = currentText
            ? currentText + ", " + finalRecord
            : finalRecord;

          if (getByteLength(merged) > MAX_BYTE)
            merged = sliceByByte(merged, MAX_BYTE);

          studentRecords.set(studentId, merged);
          appliedCount++;
        });

        renderStudentRecords();
        if (appliedCount > 0)
          showToast(`${appliedCount}ëª…ì—ê²Œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        else showToast("ì´ë¯¸ ëª¨ë“  í•™ìƒì—ê²Œ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
      }

      document.getElementById("btnDeleteMode").addEventListener("click", () => {
        isDeleteMode = !isDeleteMode;
        const btn = document.getElementById("btnDeleteMode");
        if (isDeleteMode) {
          btn.textContent = "ì‚­ì œ ëª¨ë“œ í™œì„±í™”";
          btn.style.backgroundColor = "#dcfce7";
          btn.style.borderColor = "#bbf7d0";
          btn.style.color = "#15803d";
          showToast("ê¸°ë¡ì„ í´ë¦­í•˜ì—¬ ì‚­ì œí•˜ì„¸ìš”.");
        } else {
          btn.textContent = "ê¸°ë¡ ì‚­ì œ ëª¨ë“œ";
          btn.style.backgroundColor = "";
          btn.style.borderColor = "";
          btn.style.color = "";
          showToast("ì‚­ì œ ëª¨ë“œ í•´ì œ");
        }
        renderStudentRecords();
      });

      document.getElementById("btnCopy").addEventListener("click", () => {
        if (isDeleteMode) return showToast("ì‚­ì œ ëª¨ë“œë¥¼ í•´ì œí•´ì£¼ì„¸ìš”.");
        const studentsWithRecord = STUDENT_LIST.filter(
          (s) => studentRecords.get(s.id).trim().length > 0
        );
        if (studentsWithRecord.length === 0)
          return showToast("ê¸°ë¡ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");

        let totalCopyText = "";
        studentsWithRecord.forEach((student) => {
          const text = studentRecords.get(student.id).trim();
          if (!totalCopyText) totalCopyText = text.replace(/[ã€ã€]/g, ""); // ì²« í•™ìƒë§Œ ë³µì‚¬
        });

        if (totalCopyText) navigator.clipboard.writeText(totalCopyText);
        alert("ì‘ì„±ëœ ë‚´ìš©ì„ NEISì— ì…ë ¥í•©ë‹ˆë‹¤.");
      });

      document.getElementById("btnAddBook").addEventListener("click", () => {
        bookList.appendChild(createBookCard());
      });

      window.onload = () => {
        renderStudentRecords();
        bookList.appendChild(createBookCard());
      };
    </script>
  </body>
</html>
