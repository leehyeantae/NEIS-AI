<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê³¼ëª©ë³„ ì„¸ë¶€ëŠ¥ë ¥ ë° íŠ¹ê¸°ì‚¬í•­</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", -apple-system, sans-serif;
        background: #f5f6f8;
        color: #333;
        overflow: hidden;
      }
      .topbar {
        height: 48px;
        background: #f5c6cf;
        display: flex;
        align-items: center;
        padding: 0 16px;
        font-weight: 700;
        border-bottom: 1px solid #e5adba;
        color: #333;
        flex-shrink: 0;
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        height: calc(100vh - 48px);
      }
      .left,
      .right {
        padding: 25px;
        display: flex;
        flex-direction: column;
        background: #fff;
        overflow-y: auto;
        min-height: 0;
      }
      .left {
        border-right: 1px solid #e5e7eb;
        gap: 15px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
        flex-shrink: 0;
      }
      .section-title {
        font-size: 16px;
        font-weight: 700;
        color: #1f2937;
      }

      .label {
        font-size: 13px;
        font-weight: 600;
        color: #4b5563;
        margin-bottom: 6px;
        display: block;
      }
      .input,
      .textarea,
      .select {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: 0.2s;
      }
      .textarea {
        resize: none;
        line-height: 1.6;
      }

      .btn {
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid #d1d5db;
        background: #fff;
        transition: 0.2s;
        flex-shrink: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      .btn.primary {
        background: #1f4ddc;
        color: #fff;
        border-color: #163aa5;
      }
      .btn.success {
        background: #10b981;
        color: #fff;
        border-color: #059669;
      }
      .btn.danger {
        background: #fff;
        color: #e11d48;
        border-color: #ffcccc;
      }
      .btn.sm {
        padding: 6px 12px;
        font-size: 12px;
      }

      .chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 5px;
      }
      .chip {
        padding: 8px 14px;
        border-radius: 20px;
        font-size: 13px;
        border: 1px solid #d1d5db;
        background: #fff;
        cursor: pointer;
        color: #4b5563;
        transition: 0.2s;
      }
      .chip:hover {
        background: #f3f4f6;
        border-color: #cbd5e1;
      }
      .chip.active {
        background: #1f4ddc;
        color: #fff;
        border-color: #1f4ddc;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(31, 77, 220, 0.2);
      }

      .subunit-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 5px;
      }
      .subunit-btn {
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        font-size: 12px;
        cursor: pointer;
        transition: 0.2s;
      }
      .subunit-btn:hover {
        background: #f3f4f6;
      }
      .subunit-btn.active {
        background: #eff6ff;
        border-color: #1f4ddc;
        color: #1f4ddc;
        font-weight: 600;
      }

      .radio-group {
        display: flex;
        gap: 15px;
        padding: 10px;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #f3f4f6;
        margin-bottom: 5px;
      }
      .radio-group label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
      }
      .radio-group input[type="radio"] {
        accent-color: #1f4ddc;
        transform: scale(1.1);
      }

      .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        padding: 10px;
        background: #f0fdf4;
        border-radius: 8px;
        border: 1px solid #dcfce7;
        margin-bottom: 5px;
      }
      .checkbox-group label {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        color: #166534;
      }
      .checkbox-group input[type="checkbox"] {
        accent-color: #15803d;
        transform: scale(1.1);
      }

      .card-info-box {
        padding: 12px;
        background: #f8fafc;
        border-left: 4px solid #94a3b8;
        border-radius: 4px;
        margin-bottom: 10px;
      }
      .card-title {
        font-weight: 700;
        font-size: 13px;
        color: #334155;
        margin-bottom: 4px;
      }
      .card-desc {
        font-size: 12px;
        color: #475569;
        line-height: 1.4;
      }

      .preview-box {
        flex: 6;
        min-height: 150px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 25px;
        font-size: 15px;
        line-height: 1.8;
        outline: none;
        background: #fff;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-all;
        scroll-behavior: smooth;
      }
      .sentence-block {
        cursor: text;
        transition: background 0.4s ease-out;
        border-radius: 4px;
        padding: 2px 0;
      }
      .sentence-block:hover {
        background-color: #eff6ff;
      }
      .highlight-active {
        background-color: #fef08a !important;
      }

      .counter {
        text-align: right;
        margin-top: 10px;
        font-size: 13px;
        color: #6b7280;
        flex-shrink: 0;
      }
      .info-layer {
        flex: 4;
        min-height: 150px;
        border: 1px solid #e5e7eb;
        background: #fafafa;
        border-radius: 12px;
        padding: 15px;
        overflow-y: auto;
        margin-top: 15px;
      }

      .info-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 8px;
        font-size: 13px;
        border-left: 4px solid #1f4ddc;
        transition: 0.2s;
        position: relative;
        cursor: pointer;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
      }
      .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border-color: #cbd5e1;
      }
      .info-card.deleted {
        border-left-color: #ef4444;
        opacity: 0.5;
        background: #fff5f5;
        pointer-events: none;
      }
      .info-card.optimized {
        border-left-color: #8b5cf6;
        background: #f5f3ff;
      }

      .accordion-header {
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 700;
        color: #333;
      }
      .accordion-chevron {
        transition: transform 0.3s ease;
        color: #9ca3af;
        font-size: 12px;
      }
      .info-card.expanded .accordion-chevron {
        transform: rotate(180deg);
      }

      .accordion-body-wrapper {
        display: grid;
        grid-template-rows: 0fr;
        transition: grid-template-rows 0.3s ease;
      }
      .info-card.expanded .accordion-body-wrapper {
        grid-template-rows: 1fr;
      }
      .accordion-body {
        overflow: hidden;
        padding: 0 12px;
      }
      .accordion-content {
        padding-bottom: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .tag {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
        background: #f3f4f6;
        color: #555;
        border: 1px solid #e5e7eb;
        display: inline-block;
        font-weight: bold;
      }
      .status-badge {
        font-size: 10px;
        padding: 3px 6px;
        border-radius: 4px;
        color: #fff;
        background: #10b981;
      }
      .delete-sentence-btn {
        background: #fee2e2;
        color: #ef4444;
        border: 1px solid #fca5a5;
        border-radius: 6px;
        padding: 4px 10px;
        font-size: 11px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
        align-self: flex-end;
      }
      .delete-sentence-btn:hover {
        background: #ef4444;
        color: #fff;
      }

      #toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 12px 25px;
        border-radius: 30px;
        font-size: 13px;
        font-weight: 600;
        opacity: 0;
        transition: 0.3s;
        pointer-events: none;
        z-index: 3000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <div id="toast">ì•Œë¦¼</div>
    <div class="topbar">ê³¼ëª©ë³„ ì„¸ë¶€ëŠ¥ë ¥ ë° íŠ¹ê¸°ì‚¬í•­</div>

    <div class="container">
      <section class="left">
        <div class="section-header">
          <div class="section-title">í•™ìŠµ ë‚´ìš© ë° ì„±ì·¨ ìˆ˜ì¤€ ì„¤ì •</div>
          <button
            class="btn sm"
            style="color: #6b7280; border-color: #d1d5db"
            onclick="resetForm()"
          >
            ğŸ”„ í¼ ì´ˆê¸°í™”
          </button>
        </div>

        <div class="label" style="margin-top: 5px">1. ëŒ€ë‹¨ì› ì„ íƒ</div>
        <div class="chip-row" id="unitChips">
          <div class="chip active" data-unit="ì»´í“¨íŒ… ì‹œìŠ¤í…œ">ì»´í“¨íŒ… ì‹œìŠ¤í…œ</div>
          <div class="chip" data-unit="ë°ì´í„°">ë°ì´í„°</div>
          <div class="chip" data-unit="ì•Œê³ ë¦¬ì¦˜ê³¼ í”„ë¡œê·¸ë˜ë°">
            ì•Œê³ ë¦¬ì¦˜ê³¼ í”„ë¡œê·¸ë˜ë°
          </div>
          <div class="chip" data-unit="ì¸ê³µì§€ëŠ¥">ì¸ê³µì§€ëŠ¥</div>
          <div class="chip" data-unit="ë””ì§€í„¸ ë¬¸í™”">ë””ì§€í„¸ ë¬¸í™”</div>
        </div>

        <div class="label" style="margin-top: 10px">2. ì†Œë‹¨ì› ì„ íƒ</div>
        <div class="subunit-row" id="subunitRow"></div>

        <div class="card-info-box">
          <div class="card-title" id="cardUnitTitle">
            [ì»´í“¨íŒ… ì‹œìŠ¤í…œ / ìœ ë¬´ì„  ë„¤íŠ¸ì›Œí¬]
          </div>
          <div class="card-desc" id="cardCriterion">ì„±ì·¨ê¸°ì¤€ ë¡œë”© ì¤‘...</div>
        </div>

        <div class="label">3. ì‹¬í™” í•™ìŠµ ëª©í‘œ/ì£¼ì œ (ì„ íƒ)</div>
        <input
          type="text"
          id="customObjectiveInput"
          class="input"
          placeholder="ì˜ˆ) ì¸ê³µì§€ëŠ¥ ìœ¤ë¦¬, ë‹¤ì´ìµìŠ¤íŠ¸ë¼ ì•Œê³ ë¦¬ì¦˜ íƒêµ¬ (ë¯¸ì…ë ¥ ì‹œ ì†Œë‹¨ì›ëª… ìë™ ë°˜ì˜)"
          maxlength="30"
          style="margin-bottom: 10px"
        />

        <div class="label">4. 2022 ê°œì • êµê³¼ í•µì‹¬ ì—­ëŸ‰</div>
        <div class="checkbox-group" id="competencyGroup">
          <label
            ><input type="checkbox" value="ì§€ì‹ì •ë³´ì²˜ë¦¬" /> ì§€ì‹ì •ë³´ì²˜ë¦¬</label
          >
          <label
            ><input type="checkbox" value="ì°½ì˜ì  ì‚¬ê³ " /> ì°½ì˜ì  ì‚¬ê³ </label
          >
          <label
            ><input type="checkbox" value="í˜‘ë ¥ì  ì†Œí†µ" /> í˜‘ë ¥ì  ì†Œí†µ</label
          >
          <label
            ><input type="checkbox" value="ê³µë™ì²´ ì—­ëŸ‰" /> ê³µë™ì²´ ì—­ëŸ‰</label
          >
        </div>

        <div class="label">5. ì„±ì·¨ìˆ˜ì¤€ í‰ê°€ (A~E)</div>
        <div style="font-size: 11px; color: #6b7280; margin-bottom: 6px">
          â€» ì„ íƒ ìˆ˜ì¤€ì— ë”°ë¼ ìƒê¸°ë¶€ ì „ìš© ê³ ê¸‰ ì„œìˆ ì–´ì™€ ì—­ëŸ‰ì´ ì„œì‚¬ ì†ì— ìë™
          ìœµí•©ë©ë‹ˆë‹¤.
        </div>
        <div class="radio-group" id="levelGroup">
          <label
            ><input type="radio" name="level" value="A" checked /> A
            (íƒì›”)</label
          >
          <label><input type="radio" name="level" value="B" /> B (ìš°ìˆ˜)</label>
          <label><input type="radio" name="level" value="C" /> C (ë³´í†µ)</label>
          <label
            ><input type="radio" name="level" value="D" /> D (ë…¸ë ¥/ì„±ì¥)</label
          >
          <label><input type="radio" name="level" value="E" /> E (ì°¸ì—¬)</label>
        </div>

        <div class="label" style="margin-top: 10px">
          6. êµ¬ì²´ì  í™œë™ ì‚¬ë¡€ (ìƒê¸°ë¶€ì˜ í•µì‹¬)
        </div>
        <textarea
          id="caseInput"
          class="textarea"
          style="height: 60px; min-height: 60px"
          placeholder="ì˜ˆ) ê³µê³µë°ì´í„° APIë¥¼ í™œìš©í•˜ì—¬ ë¯¸ì„¸ë¨¼ì§€ ì‹œê°í™” í”„ë¡œì íŠ¸ë¥¼ ìˆ˜í–‰í•¨."
        ></textarea>

        <button
          class="btn primary"
          style="
            height: 48px;
            font-size: 15px;
            margin-top: 15px;
            flex-shrink: 0;
          "
          onclick="generateSubjectAI()"
        >
          âœ¨ AI ê³¼ì„¸íŠ¹ ë¬¸ì¥ ìƒì„±
        </button>

        <div
          style="
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 180px;
            margin-top: 15px;
          "
        >
          <label class="label">AI ìƒì„± ì´ˆì•ˆ (ê²€í†  ë° ìˆ˜ì •/ì§ì ‘ ì…ë ¥)</label>
          <textarea
            id="tempDraft"
            class="textarea"
            style="
              background: #fdfbff;
              border-color: #c7d2fe;
              flex: 1;
              min-height: 120px;
              line-height: 1.8;
            "
          ></textarea>
          <button
            class="btn success"
            style="width: 100%; margin-top: 10px; flex-shrink: 0"
            onclick="moveToFinal()"
          >
            ìš°ì¸¡ ìµœì¢… ê¸°ì¬ë€ìœ¼ë¡œ ë°˜ì˜ â”
          </button>
        </div>
      </section>

      <section class="right">
        <div class="section-header" style="margin-bottom: 15px">
          <div class="section-title">NEIS ê¸°ì¬ ìµœì¢… ë‚´ìš©</div>
          <div style="display: flex; gap: 8px">
            <button class="btn danger" onclick="clearFinal()">
              ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
            </button>
            <button
              class="btn"
              style="background: #8b5cf6; color: white; border-color: #7c3aed"
              onclick="checkAndUpgradeIntegrity()"
            >
              ğŸª„ ì „ì²´ AI ë‹¤ë“¬ê¸° (ìˆ˜ë™ ì‘ì„± ë³´ì¡´ ë° êµì •)
            </button>
            <button class="btn success" onclick="finalApply()">
              ğŸ’¾ ì ìš©í•˜ê¸°
            </button>
          </div>
        </div>

        <div
          style="
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 15px;
            min-height: 0;
          "
        >
          <div
            id="finalPreview"
            class="preview-box"
            contenteditable="true"
            oninput="updateByte()"
          ></div>

          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              flex-shrink: 0;
            "
          >
            <div class="counter">
              ì‹¤ì‹œê°„ ìš©ëŸ‰:
              <span id="byteCount" style="color: #1f4ddc; font-weight: 700"
                >0</span
              >
              / 1500 Byte
            </div>
          </div>

          <div class="info-layer" id="infoLayer">
            <span
              style="
                font-weight: 700;
                display: block;
                margin-bottom: 8px;
                color: #374151;
              "
              >ğŸ“‹ ì‘ì„±ëœ ì†Œë‹¨ì› ìš”ì•½ (í´ë¦­í•˜ì—¬ ìƒì„¸ í™•ì¸ ë° ì‚­ì œ)</span
            >
            <div
              id="infoContentContainer"
              style="color: #9ca3af; font-size: 13px"
            >
              ìƒì„±ëœ ë¬¸ì¥ì— ëŒ€í•œ ì •ë³´ê°€ ì´ê³³ì— ì•„ì½”ë””ì–¸ í˜•íƒœë¡œ ëˆ„ì ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </section>
    </div>

    <script>
      /* =========================================================================
         [ë¬¸ì¥ ì¶”ì¶œ ë° ë¶„í•´ ë„êµ¬] 
      ========================================================================== */
      function getSentences(text) {
          if (!text) return [];
          let matches = text.replace(/\n/g, " ").match(/[^.!?]+[.!?]*/g);
          return matches ? matches.map(s => s.trim()).filter(s => s) : [];
      }

      /* =========================================================================
         [ë…ë¦½ í´ë˜ìŠ¤ V8.0] ìì—°ì–´ ë§ì¶¤ë²•/ì¢…ê²°ì–´ë¯¸ ë³€í™˜ ì—”ì§„ (Korean Grammar Engine)
      ========================================================================== */
      class GrammarEngine {
        constructor() {
          this.irregularDict = {
            "ë“ ë‹¤": "ë“¦", "ë“¤ë‹¤": "ë“¦", "ë“¤ì—ˆë‹¤": "ë“¦",
            "ë§Œë“ ë‹¤": "ë§Œë“¦", "ë§Œë“¤ë‹¤": "ë§Œë“¦", "ë§Œë“¤ì—ˆë‹¤": "ë§Œë“¦",
            "ì´ëˆë‹¤": "ì´ë", "ì´ëŒë‹¤": "ì´ë", "ì´ëŒì—ˆë‹¤": "ì´ë",
            "ë² í‘¼ë‹¤": "ë² í’‚", "ë² í’€ë‹¤": "ë² í’‚", "ë² í’€ì—ˆë‹¤": "ë² í’‚",
            "ë•ëŠ”ë‹¤": "ë„ì›€", "ë•ë‹¤": "ë„ì›€", "ë„ì™”ë‹¤": "ë„ì›€",
            "ì–´ë µë‹¤": "ì–´ë ¤ì›€", "ì–´ë ¤ì› ë‹¤": "ì–´ë ¤ì›€",
            "ì‰½ë‹¤": "ì‰¬ì›€", "ì‰¬ì› ë‹¤": "ì‰¬ì›€",
            "ì¦ê²ë‹¤": "ì¦ê±°ì›€", "ì¦ê±°ì› ë‹¤": "ì¦ê±°ì›€",
            "ì•„ë¦„ë‹µë‹¤": "ì•„ë¦„ë‹¤ì›€", "ì•„ë¦„ë‹¤ì› ë‹¤": "ì•„ë¦„ë‹¤ì›€",
            "ë¬´ê²ë‹¤": "ë¬´ê±°ì›€", "ë¬´ê±°ì› ë‹¤": "ë¬´ê±°ì›€",
            "ê°€ë³ë‹¤": "ê°€ë²¼ì›€", "ê°€ë²¼ì› ë‹¤": "ê°€ë²¼ì›€",
            "ìƒˆë¡­ë‹¤": "ìƒˆë¡œì›€", "ìƒˆë¡œì› ë‹¤": "ìƒˆë¡œì›€",
            "ê¸°ì˜ë‹¤": "ê¸°ì¨", "ê¸°ë»¤ë‹¤": "ê¸°ì¨",
            "ìŠ¬í”„ë‹¤": "ìŠ¬í””", "ìŠ¬íë‹¤": "ìŠ¬í””",
            "ê·¸ë ‡ë‹¤": "ê·¸ëŸ¬í•¨", "ê·¸ë¬ë‹¤": "ê·¸ëŸ¬í•¨",
            "ë“£ë‹¤": "ë“¤ìŒ", "ë“£ëŠ”ë‹¤": "ë“¤ìŒ", "ë“¤ì—ˆë‹¤": "ë“¤ìŒ",
            "ë¬»ë‹¤": "ë¬¼ìŒ", "ë¬»ëŠ”ë‹¤": "ë¬¼ìŒ", "ë¬¼ì—ˆë‹¤": "ë¬¼ìŒ",
            "ê±·ë‹¤": "ê±¸ìŒ", "ê±·ëŠ”ë‹¤": "ê±¸ìŒ", "ê±¸ì—ˆë‹¤": "ê±¸ìŒ",
            "ê¹¨ë‹«ë‹¤": "ê¹¨ë‹¬ìŒ", "ê¹¨ë‹«ëŠ”ë‹¤": "ê¹¨ë‹¬ìŒ", "ê¹¨ë‹¬ì•˜ë‹¤": "ê¹¨ë‹¬ìŒ",
            "ì§“ë‹¤": "ì§€ìŒ", "ì§“ëŠ”ë‹¤": "ì§€ìŒ", "ì§€ì—ˆë‹¤": "ì§€ìŒ",
            "ë‚«ë‹¤": "ë‚˜ìŒ", "ë‚˜ì•˜ë‹¤": "ë‚˜ìŒ",
            "ì‡ë‹¤": "ì´ìŒ", "ì‡ëŠ”ë‹¤": "ì´ìŒ", "ì´ì—ˆë‹¤": "ì´ìŒ",
            "ê¸‹ë‹¤": "ê·¸ìŒ", "ê·¸ì—ˆë‹¤": "ê·¸ìŒ"
          };

          this.patternDict = [
            [/ê¹ë‹¤$/, "ê¹Œì›€"], [/ê¹Œì› ë‹¤$/, "ê¹Œì› ìŒ"], 
            [/ê²¹ë‹¤$/, "ê²¨ì›€"], [/ê²¨ì› ë‹¤$/, "ê²¨ì› ìŒ"], 
            [/ëë‹¤$/, "ë¼ì›€"], [/ë¼ì› ë‹¤$/, "ë¼ì› ìŒ"],
            [/ê°‘ë‹¤$/, "ê°€ì›€"], [/ê°€ì› ë‹¤$/, "ê°€ì› ìŒ"], 
            [/ë§™ë‹¤$/, "ë§ˆì›€"], [/ë§ˆì› ë‹¤$/, "ë§ˆì› ìŒ"], 
            [/ìŠµë‹¤$/, "ìŠ¤ì›€"], [/ìŠ¤ì› ë‹¤$/, "ìŠ¤ì› ìŒ"], 
            [/ë¡­ë‹¤$/, "ë¡œì›€"], [/ë¡œì› ë‹¤$/, "ë¡œì› ìŒ"], 
            [/ëŸ½ë‹¤$/, "ëŸ¬ì›€"], [/ëŸ¬ì› ë‹¤$/, "ëŸ¬ì› ìŒ"], 
            [/ë‹µë‹¤$/, "ë‹¤ì›€"], [/ë‹¤ì› ë‹¤$/, "ë‹¤ì› ìŒ"], 
            [/ê²ë‹¤$/, "ê±°ì›€"], [/ê±°ì› ë‹¤$/, "ê±°ì› ìŒ"], 
            [/ì–´ë‘¡ë‹¤$/, "ì–´ë‘ì›€"], [/ì–´ë‘ì› ë‹¤$/, "ì–´ë‘ì› ìŒ"], 
            [/ê»ë‹¤$/, "êº¼ì›€"], [/êº¼ì› ë‹¤$/, "êº¼ì› ìŒ"], 
            [/ë‚©ë‹¤$/, "ë‚˜ì›€"], [/ë‚˜ì› ë‹¤$/, "ë‚˜ì› ìŒ"], 
            [/ì—½ë‹¤$/, "ì—¬ì›€"], [/ì—¬ì› ë‹¤$/, "ì—¬ì› ìŒ"], 
            [/ë¥ë‹¤$/, "ë”ì›€"], [/ë”ì› ë‹¤$/, "ë”ì› ìŒ"], 
            [/ë ‡ë‹¤$/, "ëŸ¬í•¨"], [/ë¬ë‹¤$/, "ë¬ìŒ"], [/ë–»ë‹¤$/, "ë– í•¨"], [/ë• ë‹¤$/, "ë• ìŒ"],
            [/ë—ë‹¤$/, "ë¼í•¨"], [/ê°›ë‹¤$/, "ê°€í•¨"], [/ì–—ë‹¤$/, "ì•¼í•¨"], [/ë§£ë‹¤$/, "ë§ˆí•¨"],
            [/ê³ ë‹¤$/, "ê³ ì„"], [/ìˆ˜ë‹¤$/, "ìˆ˜ì„"], [/ì¬ë‹¤$/, "ì¬ì„"], [/í‘œë‹¤$/, "í‘œì„"],
            [/ì‘¤ë‹¤$/, "ì‘¤ì„"], [/ê¸°ë‹¤$/, "ê¸°ì„"], [/íšŒë‹¤$/, "íšŒì„"], [/ë‘ë‹¤$/, "ë‘ì„"],
            [/ì•„ë‹ˆë‹¤$/, "ì•„ë‹˜"], [/ì•„ë‹ˆì—ˆë‹¤$/, "ì•„ë…”ìŒ"],
            [/í•˜ì˜€ë‹¤$/, "í•¨"], [/í–ˆë‹¤$/, "í•¨"], [/í•œë‹¤$/, "í•¨"], [/í•˜ë‹¤$/, "í•¨"],
            [/ì´ë‹¤$/, "ì„"], [/ì´ì—ˆë‹¤$/, "ì„"], [/ì˜€ë‹¤$/, "ì„"],
            [/ë³´ì˜€ë‹¤$/, "ë³´ì„"], [/ë³´ì¸ë‹¤$/, "ë³´ì„"], [/ë³´ì´ë‹¤$/, "ë³´ì„"],
            [/ë˜ì—ˆë‹¤$/, "ë¨"], [/ëœë‹¤$/, "ë¨"], [/ë˜ë‹¤$/, "ë¨"],
            [/ì£¼ì—ˆë‹¤$/, "ì¤Œ"], [/ì¤€ë‹¤$/, "ì¤Œ"], [/ì£¼ë‹¤$/, "ì¤Œ"],
            [/ë°›ì•˜ë‹¤$/, "ë°›ìŒ"], [/ë°›ëŠ”ë‹¤$/, "ë°›ìŒ"], [/ë°›ë‹¤$/, "ë°›ìŒ"],
            [/ê°€ì¡Œë‹¤$/, "ê°€ì§"], [/ê°€ì§„ë‹¤$/, "ê°€ì§"], [/ê°€ì§€ë‹¤$/, "ê°€ì§"],
            [/ëŠê¼ˆë‹¤$/, "ëŠë‚Œ"], [/ëŠë‚€ë‹¤$/, "ëŠë‚Œ"], [/ëŠë¼ë‹¤$/, "ëŠë‚Œ"],
            [/ë§ë‹¤$/, "ë§ìŒ"], [/ì ë‹¤$/, "ì ìŒ"], [/í¬ë‹¤$/, "í¼"], [/ì‘ë‹¤$/, "ì‘ìŒ"],
            [/ìˆë‹¤$/, "ìˆìŒ"], [/ì—†ë‹¤$/, "ì—†ìŒ"], [/ê°™ë‹¤$/, "ê°™ìŒ"], [/ì•Šë‹¤$/, "ì•ŠìŒ"],
            [/ëŠ”ë‹¤$/, "ìŒ"], [/ì€ë‹¤$/, "ìŒ"],
            [/ì—ˆë‹¤$/, "ì—ˆìŒ"], [/ì•˜ë‹¤$/, "ì•˜ìŒ"], [/ê² ë‹¤$/, "ê² ìŒ"]
          ];
        }

        convert(text) {
          if (!text) return "";
          let sentences = text.match(/[^.!?]+[.!?]*/g) || [text];
          
          let converted = sentences.map((sentence) => {
            let s = sentence.trim();
            if (!s) return "";
            
            let puncMatch = s.match(/[.!?]+$/);
            let sentencePunc = puncMatch ? puncMatch[0] : "";
            let body = s.replace(/[.!?]+$/, "");

            let words = body.split(/\s+/);
            
            for (let i = 0; i < words.length; i++) {
                let word = words[i];
                let wordPuncMatch = word.match(/[.,!?]+$/);
                let wordPunc = wordPuncMatch ? wordPuncMatch[0] : "";
                let cleanWord = word.replace(/[.,!?]+$/, "");

                let isConverted = false;

                if (this.irregularDict[cleanWord]) {
                    cleanWord = this.irregularDict[cleanWord];
                    isConverted = true;
                } else {
                    for (let [pattern, rep] of this.patternDict) {
                        if (pattern.test(cleanWord)) {
                            cleanWord = cleanWord.replace(pattern, rep);
                            isConverted = true;
                            break;
                        }
                    }
                }

                if (!isConverted && i === words.length - 1 && cleanWord.endsWith("ë‹¤")) {
                    const lastChar = cleanWord.charCodeAt(cleanWord.length - 2);
                    if (lastChar >= 0xac00 && lastChar <= 0xd7a3) {
                        const jongseong = (lastChar - 0xac00) % 28;
                        if (jongseong === 0) { 
                            cleanWord = cleanWord.slice(0, -2) + String.fromCharCode(lastChar + 16);
                        } else if (jongseong === 8) { 
                            cleanWord = cleanWord.slice(0, -2) + String.fromCharCode(lastChar + 2);
                        } else if (jongseong === 4) { 
                            cleanWord = cleanWord.slice(0, -2) + String.fromCharCode(lastChar + 12);
                        } else {
                            cleanWord = cleanWord.slice(0, -1) + "ìŒ";
                        }
                        isConverted = true;
                    }
                }

                if (isConverted && i < words.length - 1 && !wordPunc) {
                    wordPunc = ".";
                }

                words[i] = cleanWord + wordPunc;
            }

            let finalSentence = words.join(" ");
            if (!sentencePunc) sentencePunc = ".";
            let result = finalSentence + sentencePunc;
            return result.replace(/\.{2,}/g, "."); 
          });

          return converted.join(" ").replace(/\.{2,}/g, ".").replace(/\s+\./g, ".").trim();
        }
      }

      const grammarEngine = new GrammarEngine();

      /* --- [ê³¼ì„¸íŠ¹ ë°ì´í„°ë² ì´ìŠ¤] --- */
      const CURRICULUM_DATA = {
        "ì»´í“¨íŒ… ì‹œìŠ¤í…œ": {
          subunits: ["ìœ ë¬´ì„  ë„¤íŠ¸ì›Œí¬", "ì‚¬ë¬¼ ì¸í„°ë„·", "ì‚¬ë¬¼ ì¸í„°ë„· ì„¤ê³„í•˜ê¸°"],
          standards: {
            "ìœ ë¬´ì„  ë„¤íŠ¸ì›Œí¬": "ì„±ì·¨ê¸°ì¤€ [12ì •01-01]: ìœ ë¬´ì„  ë„¤íŠ¸ì›Œí¬ì˜ íŠ¹ì„±ì„ ì´í•´í•˜ê³ , ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì„ êµ¬ì„±í•œë‹¤.",
            "ì‚¬ë¬¼ ì¸í„°ë„·": "ì„±ì·¨ê¸°ì¤€ [12ì •01-02]: ì‚¬ë¬¼ì¸í„°ë„·ì˜ êµ¬ì„±ê³¼ ë™ì‘ ì›ë¦¬ë¥¼ ë¶„ì„í•œë‹¤.",
            "ì‚¬ë¬¼ ì¸í„°ë„· ì„¤ê³„í•˜ê¸°": "ì„±ì·¨ê¸°ì¤€ [12ì •01-03]: ë¬¸ì œ í•´ê²°ì— ì í•©í•œ ì‚¬ë¬¼ì¸í„°ë„· ì‹œìŠ¤í…œì„ ì„¤ê³„í•œë‹¤.",
          },
        },
        ë°ì´í„°: {
          subunits: [
            "ë°ì´í„° ì••ì¶•",
            "ë°ì´í„° ì•”í˜¸í™”",
            "ë¹…ë°ì´í„°ì™€ ë°ì´í„° ìˆ˜ì§‘",
            "ë°ì´í„° ì‹œê°í™”ì™€ í•´ì„",
          ],
          standards: {
            "ë°ì´í„° ì••ì¶•": "ì„±ì·¨ê¸°ì¤€ [12ì •02-01]: ë””ì§€í„¸ ë°ì´í„° ì••ì¶•ì˜ ê°œë…ê³¼ í•„ìš”ì„±ì„ ì´í•´í•œë‹¤.",
            "ë°ì´í„° ì•”í˜¸í™”": "ì„±ì·¨ê¸°ì¤€ [12ì •02-02]: ì•”í˜¸í™”ì˜ ê°œë…ì„ ì´í•´í•˜ê³  ì‚¬ë¡€ë¥¼ ë¶„ì„í•œë‹¤.",
            "ë¹…ë°ì´í„°ì™€ ë°ì´í„° ìˆ˜ì§‘": "ì„±ì·¨ê¸°ì¤€ [12ì •02-03]: ë¹…ë°ì´í„°ì˜ ê°œë…ì„ ì´í•´í•˜ê³  ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•œë‹¤.",
            "ë°ì´í„° ì‹œê°í™”ì™€ í•´ì„": "ì„±ì·¨ê¸°ì¤€ [12ì •02-04]: ë°ì´í„°ë¥¼ ì‹œê°í™”í•˜ê³  ê·¸ ì˜ë¯¸ë¥¼ í•´ì„í•œë‹¤.",
          },
        },
        "ì•Œê³ ë¦¬ì¦˜ê³¼ í”„ë¡œê·¸ë˜ë°": {
          subunits: [
            "ë¬¸ì œ ë¶„í•´ì™€ ëª¨ë¸ë§",
            "ì •í˜• ì•Œê³ ë¦¬ì¦˜",
            "íƒìƒ‰ ì•Œê³ ë¦¬ì¦˜",
            "ìë£Œí˜•",
            "í‘œì¤€ ì…ì¶œë ¥ê³¼ íŒŒì¼ ì…ì¶œë ¥",
            "ë‹¤ì°¨ì› ë°ì´í„° êµ¬ì¡°",
            "ë‹¤ì–‘í•œ ì œì–´ êµ¬ì¡°",
            "ê°ì²´ë¥¼ êµ¬í˜„í•˜ëŠ” í´ë˜ìŠ¤",
            "ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ í˜‘ë ¥ì  í”„ë¡œì íŠ¸",
          ],
          standards: {
            "ë¬¸ì œ ë¶„í•´ì™€ ëª¨ë¸ë§": "ì„±ì·¨ê¸°ì¤€ [12ì •03-01]: ë¬¸ì œë¥¼ ë¶„í•´í•˜ê³  ëª¨ë¸ë§í•œë‹¤.",
            "ì •í˜• ì•Œê³ ë¦¬ì¦˜": "ì„±ì·¨ê¸°ì¤€ [12ì •03-02]: ì •ë ¬ ì•Œê³ ë¦¬ì¦˜ì˜ íŠ¹ì§•ê³¼ íš¨ìœ¨ì„ ë¹„êµí•œë‹¤.",
            "íƒìƒ‰ ì•Œê³ ë¦¬ì¦˜": "ì„±ì·¨ê¸°ì¤€ [12ì •03-03]: íƒìƒ‰ ì•Œê³ ë¦¬ì¦˜ì˜ íŠ¹ì§•ê³¼ íš¨ìœ¨ì„ ë¹„êµí•œë‹¤.",
            ìë£Œí˜•: "ì„±ì·¨ê¸°ì¤€ [12ì •03-04]: ì í•©í•œ ìë£Œí˜•ì„ ì„ íƒí•˜ì—¬ í”„ë¡œê·¸ë¨ì„ ì‘ì„±í•œë‹¤.",
            "í‘œì¤€ ì…ì¶œë ¥ê³¼ íŒŒì¼ ì…ì¶œë ¥": "ì„±ì·¨ê¸°ì¤€ [12ì •03-05]: ì…ì¶œë ¥ì„ í™œìš©í•œ í”„ë¡œê·¸ë¨ì„ ì‘ì„±í•œë‹¤.",
            "ë‹¤ì°¨ì› ë°ì´í„° êµ¬ì¡°": "ì„±ì·¨ê¸°ì¤€ [12ì •03-06]: ë‹¤ì°¨ì› ë°ì´í„° êµ¬ì¡°ë¥¼ í™œìš©í•œë‹¤.",
            "ë‹¤ì–‘í•œ ì œì–´ êµ¬ì¡°": "ì„±ì·¨ê¸°ì¤€ [12ì •03-07]: ë‹¤ì–‘í•œ ì œì–´ êµ¬ì¡°ë¥¼ í™œìš©í•œë‹¤.",
            "ê°ì²´ë¥¼ êµ¬í˜„í•˜ëŠ” í´ë˜ìŠ¤": "ì„±ì·¨ê¸°ì¤€ [12ì •03-08]: í´ë˜ìŠ¤ì™€ ì¸ìŠ¤í„´ìŠ¤ë¥¼ í™œìš©í•œë‹¤.",
            "ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ í˜‘ë ¥ì  í”„ë¡œì íŠ¸": "ì„±ì·¨ê¸°ì¤€ [12ì •03-09]: í”„ë¡œê·¸ë¨ì„ í˜‘ë ¥ì ìœ¼ë¡œ ì„¤ê³„ ë° êµ¬í˜„í•œë‹¤.",
          },
        },
        ì¸ê³µì§€ëŠ¥: {
          subunits: [
            "ì§€ëŠ¥ ì—ì´ì „íŠ¸",
            "ê¸°ê³„í•™ìŠµì˜ ê°œë…ê³¼ ìœ í˜•",
            "ê¸°ê³„í•™ìŠµê³¼ ë¬¸ì œ í•´ê²°",
          ],
          standards: {
            "ì§€ëŠ¥ ì—ì´ì „íŠ¸": "ì„±ì·¨ê¸°ì¤€ [12ì •04-01]: ì§€ëŠ¥ ì—ì´ì „íŠ¸ì˜ ê°œë…ê³¼ íŠ¹ì„±ì„ ì´í•´í•œë‹¤.",
            "ê¸°ê³„í•™ìŠµì˜ ê°œë…ê³¼ ìœ í˜•": "ì„±ì·¨ê¸°ì¤€ [12ì •04-02]: ì§€ë„í•™ìŠµê³¼ ë¹„ì§€ë„í•™ìŠµì˜ ì°¨ì´ë¥¼ ë¹„êµí•œë‹¤.",
            "ê¸°ê³„í•™ìŠµê³¼ ë¬¸ì œ í•´ê²°": "ì„±ì·¨ê¸°ì¤€ [12ì •04-03]: ì‚¬íšŒë¬¸ì œ í•´ê²°ì— ê¸°ê³„í•™ìŠµì„ ì ìš©í•œë‹¤.",
          },
        },
        "ë””ì§€í„¸ ë¬¸í™”": {
          subunits: [
            "ë””ì§€í„¸ ì‚¬íšŒì™€ ì§„ë¡œ",
            "ì •ë³´ ë³´í˜¸ì™€ ì •ë³´ ê³µìœ ",
            "ì •ë³´ ë³´ì•ˆ",
          ],
          standards: {
            "ë””ì§€í„¸ ì‚¬íšŒì™€ ì§„ë¡œ": "ì„±ì·¨ê¸°ì¤€ [12ì •05-01]: ë””ì§€í„¸ ê¸°ìˆ ì˜ ì˜í–¥ë ¥ì„ ë¶„ì„í•˜ê³  ì§„ë¡œë¥¼ ì„¤ê³„í•œë‹¤.",
            "ì •ë³´ ë³´í˜¸ì™€ ì •ë³´ ê³µìœ ": "ì„±ì·¨ê¸°ì¤€ [12ì •05-02]: ì˜¬ë°”ë¥¸ ì •ë³´ ë³´í˜¸ ë°©ë²•ì„ ì‹¤ì²œí•œë‹¤.",
            "ì •ë³´ ë³´ì•ˆ": "ì„±ì·¨ê¸°ì¤€ [12ì •05-03]: ë³´ì•ˆ ê¸°ìˆ ì„ í™œìš©í•˜ì—¬ ë””ì§€í„¸ ìœ¤ë¦¬ë¥¼ ì‹¤ì²œí•œë‹¤.",
          },
        },
      };

      let state = { unit: "ì»´í“¨íŒ… ì‹œìŠ¤í…œ", subunit: "ìœ ë¬´ì„  ë„¤íŠ¸ì›Œí¬" };
      let finalHistoryStack = [];
      let tempContext = null;

      window.onload = () => {
        renderSubunitButtons(state.unit);
      };

      document.getElementById("unitChips").addEventListener("click", (e) => {
        const chip = e.target.closest(".chip");
        if (!chip) return;
        document
          .querySelectorAll(".chip")
          .forEach((c) => c.classList.remove("active"));
        chip.classList.add("active");
        state.unit = chip.dataset.unit;
        renderSubunitButtons(state.unit);
      });

      document.getElementById("subunitRow").addEventListener("click", (e) => {
        const btn = e.target.closest(".subunit-btn");
        if (!btn) return;
        document
          .querySelectorAll(".subunit-btn")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        state.subunit = btn.dataset.sub;
        updateCardInfo();
      });

      function renderSubunitButtons(unit) {
        const row = document.getElementById("subunitRow");
        row.innerHTML = "";
        const subunits = CURRICULUM_DATA[unit]?.subunits || [];
        subunits.forEach((name, idx) => {
          const btn = document.createElement("button");
          btn.className = `subunit-btn ${idx === 0 ? "active" : ""}`;
          btn.dataset.sub = name;
          btn.textContent = name;
          row.appendChild(btn);
        });
        state.subunit = subunits[0] || "";
        updateCardInfo();
      }

      function updateCardInfo() {
        document.getElementById(
          "cardUnitTitle"
        ).textContent = `[${state.unit} / ${state.subunit}]`;
        document.getElementById("cardCriterion").textContent =
          CURRICULUM_DATA[state.unit]?.standards?.[state.subunit] ||
          "ì„±ì·¨ê¸°ì¤€ ë¡œë”© ì¤‘...";
      }

      function resetForm() {
        document.getElementById("customObjectiveInput").value = "";
        document.getElementById("caseInput").value = "";
        document.getElementById("tempDraft").value = "";
        document
          .querySelectorAll("input[type=checkbox]")
          .forEach((cb) => (cb.checked = false));
        document.querySelector('input[name="level"][value="A"]').checked = true;
        showToast("ì…ë ¥ í¼ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      function formatCompetencies(comps) {
        if (!comps || comps.length === 0) return "";
        if (comps.length === 1) return comps[0];
        if (comps.length === 2) return `${comps[0]} ë° ${comps[1]}`;
        const last = comps.pop();
        return `${comps.join(", ")} ë° ${last}`;
      }

      /* --- [í•µì‹¬ ìˆ˜ì •] ê³¼ì„¸íŠ¹ ë¬¸ì¥ ìƒì„± ë° ë§ì¶¤ë²• ì—”ì§„ ê²°í•© --- */
      function generateSubjectAI() {
        const level = document.querySelector('input[name="level"]:checked')?.value || "C";
        const customObj = document.getElementById("customObjectiveInput").value.trim();
        
        // ì‚¬ìš©ìê°€ ì…ë ¥í•œ êµ¬ì²´ì  í™œë™ ì‚¬ë¡€ (ì¤„ë°”ê¿ˆ ì œê±°)
        let activity = document.getElementById("caseInput").value.trim().replace(/\n/g, " ");

        const comps = [];
        document.querySelectorAll("input[type=checkbox]:checked").forEach((cb) => comps.push(cb.value));

        const topic = customObj ? customObj : state.subunit;

        // 1. ì—­ë™ì ì¸ ë„ì…ë¶€ (ë”°ì˜´í‘œ ì œê±°)
        const intros = [
          `${state.unit} ë‹¨ì›ì˜ ${topic} ì˜ì—­ì„ í•™ìŠµí•˜ëŠ” ê³¼ì •ì—ì„œ, `,
          `${topic}ì— ëŒ€í•œ ê¹Šì€ í•™êµ¬ì  í˜¸ê¸°ì‹¬ì„ ë°”íƒ•ìœ¼ë¡œ `,
          `ìˆ˜ì—… ì¤‘ ë‹¤ë£¬ ${topic} ê°œë…ì„ ì‹¬ì¸µì ìœ¼ë¡œ íƒêµ¬í•˜ê³ ì `,
          `${topic}ì˜ í•µì‹¬ ì›ë¦¬ë¥¼ ì´í•´í•˜ëŠ” ë° ê·¸ì¹˜ì§€ ì•Šê³  ì´ë¥¼ ì£¼ë„ì ìœ¼ë¡œ í™•ì¥í•˜ì—¬, `,
          `í‰ì†Œ ${state.unit} ë¶„ì•¼ì— ëŒ€í•œ ê´€ì‹¬ì´ ë†’ì•„ ${topic} íŒŒíŠ¸ì—ì„œ íƒì›”í•œ ìˆ˜ì—… ì°¸ì—¬ë„ë¥¼ ë³´ì´ë©° `
        ];
        const neutralIntros = [
          `${state.unit} ë‹¨ì›ì˜ ${topic} í•™ìŠµ ê³¼ì •ì—ì„œ `,
          `${topic} ê°œë…ì„ í•™ìŠµí•˜ë©° `,
          `êµê³¼ ìˆ˜ì—… ì¤‘ ${topic} íŒŒíŠ¸ì— ì°¸ì—¬í•˜ì—¬ `
        ];
        let intro =
          level === "D" || level === "E"
            ? neutralIntros[Math.floor(Math.random() * neutralIntros.length)]
            : intros[Math.floor(Math.random() * intros.length)];

        // 2. í™œë™ ì—°ê²°ë¶€ (íŠ¹ìˆ˜ë¬¸ì ê´„í˜¸ ì œê±° ë° ìˆ˜ì‹ì–´ ì¶”ê°€)
        let actText = "";
        if (activity) {
          actText = `êµ¬ì²´ì ì¸ í™œë™ìœ¼ë¡œ ${activity}. `;
        }

        // 3. ìƒê¸°ë¶€ ì „ìš© ê³ ê¸‰ ì„œìˆ ì–´ DB 
        const bodies = {
          A: [
            `ì´ ê³¼ì •ì—ì„œ í•µì‹¬ ì›ë¦¬ë¥¼ ê¹Šì´ ìˆê²Œ í†µì°°í•˜ê³  ë‹¤ê°ì ì¸ ì‹œê°ìœ¼ë¡œ ë¬¸ì œë¥¼ ë¶„ì„í•˜ì—¬ ìµœì ì˜ í•´ê²°ì±…ì„ ë„ì¶œí•˜ëŠ” ë“± ë›°ì–´ë‚œ êµê³¼ ì—­ëŸ‰ì„ ë°œíœ˜í•¨.`,
            `ë³µì¡í•œ ê°œë… ê°„ì˜ ìœ ê¸°ì  ì—°ê²°ì„±ì„ íŒŒì•…í•˜ëŠ” ëŠ¥ë ¥ì´ íƒì›”í•˜ë©°, ì°½ì˜ì ì¸ ë¬¸ì œí•´ê²°ë ¥ì„ ë°”íƒ•ìœ¼ë¡œ ì™„ì„±ë„ ë†’ì€ ê²°ê³¼ë¬¼ì„ ì‚°ì¶œí•˜ì—¬ í•™ì—…ì  ìš°ìˆ˜ì„±ì„ ì¦ëª…í•¨.`,
            `ë‹¨ìˆœí•œ ì§€ì‹ ìŠµë“ì„ ë„˜ì–´ ë¹„íŒì  ì‚¬ê³ ì™€ ë…¼ë¦¬ì  ì¶”ë¡ ì„ í†µí•´ ìŠ¤ìŠ¤ë¡œ ê²°ë¡ ì„ ë„ì¶œí•˜ëŠ” ê³¼ì •ì´ ë‹ë³´ì´ë©°, íƒì›”í•œ íƒêµ¬ ì—­ëŸ‰ê³¼ ì§€ì  ì„±ì¥ì„ ë³´ì—¬ì¤Œ.`
          ],
          B: [
            `ê°œë…ì„ ì •í™•í•˜ê²Œ ì´í•´í•˜ê³  ìˆìœ¼ë©°, ì´ë¥¼ ë…¼ë¦¬ì ìœ¼ë¡œ ì ìš©í•˜ëŠ” ì‘ìš©ë ¥ì´ ë‹ë³´ì„. ì ê·¹ì ì¸ ìë£Œ íƒìƒ‰ê³¼ ë¶„ì„ì„ í†µí•´ ê³¼ì œë¥¼ í›Œë¥­íˆ í•´ê²°í•˜ë©° ë¶„ì„ì  ì‚¬ê³  ì—­ëŸ‰ì„ ë‚˜íƒ€ëƒ„.`,
            `í•™ìŠµ ë‚´ìš©ì— ëŒ€í•œ ë†’ì€ ì´í•´ë„ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìŠ¤ìŠ¤ë¡œ ë¬¸ì œë¥¼ ì •ì˜í•˜ê³  í•´ê²°í•´ ë‚˜ê°€ëŠ” ìê¸°ì£¼ë„ì  í•™ìŠµ íƒœë„ë¥¼ ê°–ì¶”ê³  ìˆìœ¼ë©°, ìš°ìˆ˜í•œ í•™ì—… ì„±ì·¨ë„ë¥¼ ë³´ì„.`,
            `ìˆ˜ì—… ì¤‘ ìŠµë“í•œ ì´ë¡ ì„ ì‹¤ì œ ìƒí™©ì— ì ì ˆíˆ ëŒ€ì…í•˜ì—¬ í•´ì„í•˜ëŠ” ëŠ¥ë ¥ì´ ìš°ìˆ˜í•˜ë©°, ì£¼ì–´ì§„ ê³¼ì œë¥¼ ì²´ê³„ì ìœ¼ë¡œ ë¶„ì„í•˜ê³  ë…¼ë¦¬ì ìœ¼ë¡œ ì„œìˆ í•˜ëŠ” ì—­ëŸ‰ì„ ë°œíœ˜í•¨.`
          ],
          C: [
            `í•´ë‹¹ ë‹¨ì›ì˜ ê¸°ë³¸ ê°œë…ì„ ì¶©ì‹¤íˆ í•™ìŠµí•˜ê³ , ì£¼ì–´ì§„ ê³¼ì œë¥¼ ì±…ì„ê° ìˆê²Œ ì™„ìˆ˜í•˜ëŠ” ì„±ì‹¤í•¨ì„ ë³´ì„. ë°°ìš´ ì§€ì‹ì„ ì‹¤ì œ ì‚¬ë¡€ì™€ ì—°ê²°í•˜ë ¤ëŠ” ë…¸ë ¥ì„ í†µí•´ ì‹¤ë¬´ì  ì—­ëŸ‰ì„ ê¸°ë¦„.`,
            `ìˆ˜ì—…ì— ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•˜ë©° êµê³¼ ì§€ì‹ì„ ì•ˆì •ì ìœ¼ë¡œ ìŠµë“í•¨. íŠ¹íˆ ê³¼ì œ ìˆ˜í–‰ ì‹œ ì›í™œí•œ ì†Œí†µì„ ë°”íƒ•ìœ¼ë¡œ ê³µë™ì²´ ì—­ëŸ‰ê³¼ í˜‘ë ¥ì  íƒœë„ë¥¼ ë‚˜íƒ€ëƒ„.`,
            `ìì‹ ì—ê²Œ ì£¼ì–´ì§„ ì—­í• ì„ ëª…í™•íˆ ì¸ì§€í•˜ê³  ì„±ì‹¤í•œ íƒœë„ë¡œ íƒêµ¬ì— ì„í•˜ë©°, êµê³¼ì—ì„œ ìš”êµ¬í•˜ëŠ” ê¸°ì´ˆ ì†Œì–‘ê³¼ ì •ë³´ì²˜ë¦¬ ëŠ¥ë ¥ì„ ì•ˆì •ì ìœ¼ë¡œ í•¨ì–‘í•¨.`
          ],
          D: [
            `ì´ˆê¸°ì—ëŠ” ìƒˆë¡œìš´ ê°œë… ì ìš©ì— ë‹¤ì†Œ ì–´ë ¤ì›€ì„ ê²ªì—ˆìœ¼ë‚˜, í¬ê¸°í•˜ì§€ ì•Šê³  ì ê·¹ì ì¸ ì§ˆë¬¸ê³¼ ë°˜ë³µ í•™ìŠµì„ í†µí•´ ì´í•´ë„ë¥¼ ë†’ì´ëŠ” ëˆê¸°ë¥¼ ë³´ì„.`,
            `ê³¼ì œ ìˆ˜í–‰ ì¤‘ ë§ˆì£¼í•œ í•œê³„ë¥¼ ê·¹ë³µí•˜ê¸° ìœ„í•´ ì§€ì†ì ìœ¼ë¡œ ë…¸ë ¥í•˜ë©°, ê¾¸ì¤€í•œ ì„±ì‹¤í•¨ì„ ë°”íƒ•ìœ¼ë¡œ ëê¹Œì§€ ì™„ìˆ˜í•´ ë‚´ëŠ” ê¸ì •ì ì¸ ë°œì „ ê°€ëŠ¥ì„±ì„ ë‚˜íƒ€ëƒ„.`,
            `í•™ìŠµ ê³¼ì •ì—ì„œ ë¶€ì¡±í•œ ë¶€ë¶„ì„ ìŠ¤ìŠ¤ë¡œ ì¸ì§€í•˜ê³  ì´ë¥¼ ë³´ì™„í•˜ê¸° ìœ„í•´ ì ê·¹ì ìœ¼ë¡œ ì†Œí†µí•˜ë©° ì ì§„ì ìœ¼ë¡œ í•™ì—… ì—­ëŸ‰ì„ ì„±ì¥ì‹œì¼œ ë‚˜ê°.`
          ],
          E: [
            `ê¸°ì´ˆì ì¸ ë‚´ìš©ì— ê´€ì‹¬ì„ ê°€ì§€ê³  ì„±ì‹¤í•œ íƒœë„ë¡œ ìˆ˜ì—…ì— ì°¸ì—¬í•¨. ìì‹ ë§Œì˜ í•™ìŠµ ì†ë„ì— ë§ì¶° êµê³¼ ë‚´ìš©ì„ ì´í•´í•˜ë ¤ ë…¸ë ¥í•˜ë©° ì •ë³´í™” ì†Œì–‘ì„ ê¸°ë¥´ê³ ì ë…¸ë ¥í•¨.`,
            `ìˆ˜ì—… í™œë™ì— ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•˜ì—¬ ê¸°ë³¸ì ì¸ ê°œë…ì„ ìŠµë“í•˜ê³ , êµì‚¬ì˜ í”¼ë“œë°±ì„ ìˆ˜ìš©í•˜ë©° ê³¼ì œë¥¼ ìˆ˜í–‰í•´ ë‚˜ê°€ëŠ” ë“± ê¾¸ì¤€í•œ ì°¸ì—¬ë„ë¥¼ ë³´ì„.`
          ]
        };

        let body = bodies[level][Math.floor(Math.random() * bodies[level].length)];

        let compText = "";
        if (comps.length > 0) {
          const formattedComps = formatCompetencies(comps);
          const endings = [
            `ì •ë³´ êµê³¼ ì†Œì–‘ì„ í•œì¸µ ë” ì‹ ì¥ì‹œí‚´.`,
            `êµê³¼ ì—­ëŸ‰ì„ ëšœë ·í•˜ê²Œ ë³´ì—¬ì¤Œ.`,
            `ì‹¤ì§ˆì ì¸ ë¬¸ì œí•´ê²°ë ¥ì„ ì…ì¦í•¨.`
          ];
          let randomEnding = endings[Math.floor(Math.random() * endings.length)];
          compText = ` íŠ¹íˆ, ${formattedComps} ì—­ëŸ‰ì„ ë°”íƒ•ìœ¼ë¡œ ${randomEnding}`;
        }

        // [í•µì‹¬] ì¡°ë¦½ëœ ë¬¸ì¥ì„ ë§ì¶¤ë²• ì—”ì§„ì— í†µê³¼ì‹œì¼œ ì™„ë²½í•œ í˜•íƒœì†Œë¡œ ì •ì œ
        let rawText = (intro + actText + body + compText).replace(/\s+/g, " ").trim();
        let resultText = grammarEngine.convert(rawText);

        document.getElementById("tempDraft").value = resultText;

        let hashKey = `SUBJ|${topic}`; 

        tempContext = {
          topic: topic,
          level: level,
          comps: comps,
          hashKey: hashKey,
          aiGeneratedText: resultText, // ì¶”í›„ ë‹¤ë“¬ê¸° ë¡œì§ì„ ìœ„í•œ ì›ë³¸ ì €ì¥
          len: resultText.length,
        };
        showToast("ë‹¤ì±„ë¡œìš´ ì–´íœ˜ê°€ ì ìš©ëœ ì´ˆì•ˆì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      function moveToFinal() {
        const draftText = document.getElementById("tempDraft").value;
        const preview = document.getElementById("finalPreview");
        if (!draftText || !tempContext) return alert("ìƒì„±ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.");

        // ì™„ë²½í•œ ì†Œë‹¨ì› ì¤‘ë³µ ì°¨ë‹¨ (Strict Block)
        let isDuplicateSubunit = finalHistoryStack.some(
          (fh) => fh.topic === tempContext.topic && fh.status !== "deleted"
        );
        if (isDuplicateSubunit) {
          alert(`âš ï¸ [${tempContext.topic}]ì— ëŒ€í•œ ê¸°ë¡ì´ ì´ë¯¸ ìš°ì¸¡ì— ì¡´ì¬í•©ë‹ˆë‹¤.\n\ní•œ ì†Œë‹¨ì›(ì£¼ì œ)ì— ëŒ€í•œ ì¤‘ë³µ ê¸°ì¬ë¥¼ í”¼í•˜ê¸° ìœ„í•´, ê¸°ì¡´ ë¬¸ì¥ì„ ì‚­ì œí•œ í›„ ìƒˆë¡œìš´ ë‚´ìš©ìœ¼ë¡œ ë‹¤ì‹œ ìƒì„±í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.`);
          return;
        }

        // ìˆ˜ë™ í¸ì§‘ ë‚´ìš© ê°ì§€ ë° ë§ì¶¤ë²• ìµœì¢… ê²€ì‚¬
        let aiSentences = getSentences(tempContext.aiGeneratedText);
        let currentSentences = getSentences(draftText);
        let manualCount = 0;
        currentSentences.forEach(cs => {
            if (cs && !aiSentences.includes(cs)) manualCount++;
        });

        let correctedText = grammarEngine.convert(draftText);

        let currentText = preview.innerText;
        let b = 0;
        let testText = currentText + " " + correctedText;
        for (let i = 0; i < testText.length; i++) b += testText.charCodeAt(i) > 127 ? 3 : 1;
        if (b > 1500) return alert("âš ï¸ ìƒê¸°ë¶€ ìµœëŒ€ ìš©ëŸ‰(1500 Byte)ì„ ì´ˆê³¼í•˜ì—¬ ë” ì´ìƒ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        if (preview.innerText.trim() === "") preview.innerText = "";
        else preview.appendChild(document.createTextNode(" "));

        const uniqueId = "block_" + Date.now();
        const span = document.createElement("span");
        span.className = "sentence-block";
        span.id = uniqueId;
        span.innerText = correctedText;
        preview.appendChild(span);

        finalHistoryStack.push({
          id: uniqueId,
          topic: tempContext.topic,
          level: tempContext.level,
          comps: tempContext.comps,
          hashKey: tempContext.hashKey,
          aiGeneratedText: tempContext.aiGeneratedText,
          len: correctedText.length,
          status: "active",
          manualCount: manualCount
        });

        renderInfoLayer();
        updateByte();
      }

      function renderInfoLayer() {
        const con = document.getElementById("infoContentContainer");
        con.innerHTML = "";
        if (finalHistoryStack.length === 0) {
          con.innerHTML = "ìƒì„± ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        finalHistoryStack.forEach((item) => {
          const div = document.createElement("div");
          div.className = `info-card ${item.status}`;

          div.onclick = () => {
            div.classList.toggle("expanded");
            highlightSentence(item.id);
          };

          let levelColor =
            item.level === "A" ? "#1f4ddc"
              : item.level === "B" ? "#10b981"
              : item.level === "C" ? "#6b7280"
              : item.level === "í†µí•©" ? "#8b5cf6" : "#f59e0b";
              
          let tagsHtml = `<span class="tag" style="color: ${levelColor}; border-color: ${levelColor}; background: #fff;">ì„±ì·¨ìˆ˜ì¤€: ${item.level}</span>`;
          if (item.comps && item.comps.length > 0) {
            tagsHtml += item.comps.map((a) => `<span class="tag">${a}</span>`).join("");
          }
          
          if (item.manualCount > 0) {
            tagsHtml += `<span class="tag" style="background:#fef08a; border-color:#fde047; color:#854d0e;">âœï¸ ì§ì ‘ ì‘ì„± ${item.manualCount}ê±´</span>`;
          }

          let delBtn = `<button class="delete-sentence-btn" onclick="deleteFinalSentence(event, '${item.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>`;

          let statBadge = "";
          if (item.status === "deleted") statBadge = "<span class='status-badge' style='background:#ef4444;'>âŒ ì‚­ì œë¨</span>";
          else if (item.status === "optimized") statBadge = "<span class='status-badge' style='background:#8b5cf6;'>ğŸª„ í†µí•© ë° ë§ì¶¤ë²• êµì •ë¨</span>";

          div.innerHTML = `
            <div class="accordion-header">
                <span style="display:flex; align-items:center; gap:5px;">ğŸ“ [${item.level}] ${item.topic}</span>
                <span class="accordion-chevron">â–¼</span>
            </div>
            <div class="accordion-body-wrapper">
                <div class="accordion-body">
                    <div class="accordion-content">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>${statBadge}</div>
                            ${delBtn}
                        </div>
                        <div style="display:flex; gap:4px; flex-wrap:wrap; margin-top:4px;">${tagsHtml}</div>
                    </div>
                </div>
            </div>
          `;
          con.appendChild(div);
        });
      }

      function highlightSentence(id) {
        document
          .querySelectorAll(".sentence-block")
          .forEach((el) => el.classList.remove("highlight-active"));
        const target = document.getElementById(id);
        if (target) {
          target.scrollIntoView({ behavior: "smooth", block: "center" });
          target.classList.add("highlight-active");
          setTimeout(() => {
            target.classList.remove("highlight-active");
          }, 2000);
        }
      }

      function deleteFinalSentence(event, id) {
        event.stopPropagation();
        const target = document.getElementById(id);
        if (target) {
          if (target.previousSibling && target.previousSibling.nodeType === 3)
            target.previousSibling.remove();
          target.remove();
        }
        finalHistoryStack = finalHistoryStack.filter((item) => item.id !== id);
        renderInfoLayer();
        updateByte();
        showToast("ë¬¸ì¥ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      /* --- [í•µì‹¬] ì „ì²´ AI ë‹¤ë“¬ê¸° (ìˆ˜ë™ í¸ì§‘ í…ìŠ¤íŠ¸ ì™„ë²½ ë³´ì¡´ ì—”ì§„) --- */
      function checkAndUpgradeIntegrity() {
        let activeItems = finalHistoryStack.filter((i) => i.status !== "deleted");
        if (activeItems.length === 0) return alert("ë‹¤ë“¬ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");

        if (!confirm("âš ï¸ [ì£¼ì˜]\nAI ë‹¤ë“¬ê¸° ì‹¤í–‰ ì‹œ ì„ ìƒë‹˜ì´ ì§ì ‘ ì¶”ê°€í•˜ì‹  ë¬¸ì¥ì€ ë³´ì¡´ë˜ë©°, ì „ì²´ í…ìŠ¤íŠ¸ì˜ ë§ì¶¤ë²• ë° ì¢…ê²°ì–´ë¯¸ê°€ ì™„ë²½í•˜ê²Œ êµì •ë˜ì–´ í•˜ë‚˜ì˜ ë¬¸ë‹¨ìœ¼ë¡œ í†µí•©ë©ë‹ˆë‹¤.\nì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        // 1. AI ì›ë³¸ ë¬¸ì¥ ì¶”ì¶œ
        let allAIGeneratedText = activeItems.map((i) => i.aiGeneratedText).join(" ");
        let aiSentences = getSentences(allAIGeneratedText);

        // 2. í˜„ì¬ ìš°ì¸¡ í™”ë©´ ë¬¸ì¥ ì¶”ì¶œ
        let currentSentences = getSentences(document.getElementById("finalPreview").innerText);

        // 3. ì„ ìƒë‹˜ ìˆ˜ë™ ì‘ì„± ë¬¸ì¥ ê³¨ë¼ë‚´ê¸°
        let customSentences = [];
        currentSentences.forEach((cs) => {
          if (cs && !aiSentences.includes(cs)) {
            customSentences.push(cs);
          }
        });

        // 4. ë‹¤ì‹œ ì¡°ë¦½
        let finalCombinedText = activeItems.map((i) => i.aiGeneratedText).join(" ");
        if (customSentences.length > 0) {
          finalCombinedText += " " + customSentences.join(" ");
        }

        // 5. ë§ì¶¤ë²• ë° ëª…ì‚¬í˜• ì—”ì§„ ìµœì¢… í†µê³¼
        let finalText = grammarEngine.convert(finalCombinedText);

        let b = 0;
        for (let i = 0; i < finalText.length; i++) b += finalText.charCodeAt(i) > 127 ? 3 : 1;
        if (b > 1500) alert("âš ï¸ [ê²½ê³ ] ìµœì í™”ëœ ë¬¸ì¥ì˜ ìš©ëŸ‰ì´ 1500 Byteë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ê¸°ì¬ ë‚´ìš©ì„ ì¤„ì—¬ì£¼ì„¸ìš”.");

        // 6. í™”ë©´ ì—…ë°ì´íŠ¸ (í†µí•© ë¸”ë¡ ìƒì„±)
        const preview = document.getElementById("finalPreview");
        preview.innerHTML = "";
        const uniqueId = "opt_" + Date.now();
        const span = document.createElement("span");
        span.className = "sentence-block";
        span.id = uniqueId;
        span.innerText = finalText;
        preview.appendChild(span);

        // 7. ì •ë³´ ì¹´ë“œ í†µí•©
        let mergedTopics = activeItems.map(i => i.topic).join(", ");
        let mergedComps = [];
        activeItems.forEach(i => {
            if(i.comps) mergedComps.push(...i.comps);
        });
        mergedComps = [...new Set(mergedComps)];

        finalHistoryStack = [{
          id: uniqueId,
          topic: mergedTopics.length > 25 ? mergedTopics.substring(0, 25) + "..." : mergedTopics,
          level: "í†µí•©",
          comps: mergedComps,
          hashKey: "MERGED_" + Date.now(),
          aiGeneratedText: finalCombinedText, 
          len: finalText.length,
          status: "optimized",
          manualCount: customSentences.length
        }];

        renderInfoLayer();
        updateByte();
        showToast("ì „ì²´ ë¬¸ì¥ í†µí•© ë° ë§ì¶¤ë²• ì™„ë²½ êµì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
      }

      function clearFinal() {
        if (confirm("ì „ì²´ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          document.getElementById("finalPreview").innerText = "";
          finalHistoryStack = [];
          renderInfoLayer();
          updateByte();
        }
      }
      function updateByte() {
        const text = document.getElementById("finalPreview").innerText;
        let bytes = 0;
        for (let i = 0; i < text.length; i++)
          bytes += text.charCodeAt(i) > 127 ? 3 : 1;
        document.getElementById("byteCount").innerText = bytes;
        document.getElementById("byteCount").style.color =
          bytes > 1500 ? "red" : "#1f4ddc";
      }
      function finalApply() {
        alert("NEIS ì…ë ¥ ì™„ë£Œ");
      }
    </script>
  </body>
</html>
