<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì§„ë¡œí™œë™ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <style>
      /* --- [ìŠ¤í¬ë¡¤ ì´íƒˆ ë°©ì§€ ë° ê³µí†µ ë ˆì´ì•„ì›ƒ] --- */
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", -apple-system, sans-serif;
        background: #f5f6f8;
        color: #333;
        overflow: hidden;
      }
      .topbar {
        height: 48px;
        background: #f5c6cf;
        display: flex;
        align-items: center;
        padding: 0 16px;
        font-weight: 700;
        border-bottom: 1px solid #e5adba;
        color: #333;
        flex-shrink: 0;
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        height: calc(100vh - 48px);
      }
      .left,
      .right {
        padding: 25px;
        display: flex;
        flex-direction: column;
        background: #fff;
        overflow-y: auto;
        min-height: 0;
      }
      .left {
        border-right: 1px solid #e5e7eb;
        gap: 15px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
        flex-shrink: 0;
      }
      .section-title {
        font-size: 16px;
        font-weight: 700;
        color: #1f2937;
      }

      .input,
      .select {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: 0.2s;
      }
      .textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        resize: none;
        line-height: 1.6;
      }

      .btn {
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid #d1d5db;
        background: #fff;
        transition: 0.2s;
        flex-shrink: 0;
      }
      .btn.primary {
        background: #1f4ddc;
        color: #fff;
        border-color: #163aa5;
      }
      .btn.success {
        background: #10b981;
        color: #fff;
        border-color: #059669;
      }
      .btn.danger {
        background: #fff;
        color: #e11d48;
        border-color: #ffcccc;
      }
      .btn.warning {
        background: #f59e0b;
        color: #fff;
        border-color: #d97706;
      }
      .btn.sm {
        padding: 6px 12px;
        font-size: 12px;
      }

      .preview-box {
        flex: 6;
        min-height: 150px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 25px;
        font-size: 15px;
        line-height: 1.8;
        outline: none;
        background: #fff;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-all;
        scroll-behavior: smooth;
      }
      .sentence-block {
        cursor: text;
        transition: background 0.4s ease-out;
        border-radius: 4px;
        padding: 2px 0;
      }
      .sentence-block:hover {
        background-color: #eff6ff;
      }
      .highlight-active {
        background-color: #fef08a !important;
      }

      .counter {
        text-align: right;
        margin-top: 10px;
        font-size: 13px;
        color: #6b7280;
        flex-shrink: 0;
      }

      .info-layer {
        flex: 4;
        min-height: 150px;
        border: 1px solid #e5e7eb;
        background: #fafafa;
        border-radius: 12px;
        padding: 15px;
        overflow-y: auto;
        margin-top: 15px;
      }
      .info-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        font-size: 13px;
        border-left: 4px solid #1f4ddc;
        transition: 0.2s;
        position: relative;
        cursor: pointer;
      }
      .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }
      .info-card.deleted {
        border-left-color: #ef4444;
        opacity: 0.5;
        background: #fff5f5;
        pointer-events: none;
      }
      .info-card.modified {
        border-left-color: #10b981;
      }
      .info-card.optimized {
        border-left-color: #8b5cf6;
        background: #f5f3ff;
      }

      .info-header {
        font-weight: 700;
        color: #333;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }
      .tag {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
        background: #f3f4f6;
        color: #555;
        border: 1px solid #e5e7eb;
        margin-right: 4px;
        display: inline-block;
        margin-top: 4px;
      }
      .dup-badge {
        background: #f59e0b;
        color: #fff;
        font-size: 10px;
        padding: 3px 8px;
        border-radius: 12px;
        font-weight: 700;
      }
      .status-badge {
        font-size: 10px;
        padding: 3px 6px;
        border-radius: 4px;
        color: #fff;
        background: #10b981;
      }
      .delete-sentence-btn {
        background: #fee2e2;
        color: #ef4444;
        border: 1px solid #fca5a5;
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 11px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
      }
      .delete-sentence-btn:hover {
        background: #ef4444;
        color: #fff;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
      }
      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 1100px;
        height: 90vh;
        background: #fff;
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .modal-header {
        padding: 20px 30px;
        background: #f9fafb;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }
      .modal-body {
        display: grid;
        grid-template-columns: 240px 1fr;
        flex: 1;
        overflow: hidden;
        min-height: 0;
      }

      .student-list {
        background: #f8fafc;
        border-right: 1px solid #e5e7eb;
        padding: 15px 0;
        overflow-y: auto;
      }
      .student-item {
        padding: 16px 30px;
        background: #eff6ff;
        color: #1f4ddc;
        font-weight: 700;
        border-right: 4px solid #1f4ddc;
        font-size: 15px;
      }
      .log-entry {
        padding: 30px;
        overflow-y: auto;
        background: #fff;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .tab-menu {
        display: flex;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 20px;
        flex-shrink: 0;
      }
      .tab-btn {
        flex: 1;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        font-weight: 700;
        color: #6b7280;
        font-size: 14px;
        border-bottom: 3px solid transparent;
        transition: 0.2s;
      }
      .tab-btn:hover {
        color: #1f4ddc;
      }
      .tab-btn.active {
        color: #1f4ddc;
        border-bottom-color: #1f4ddc;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      .form-box {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        flex-shrink: 0;
      }
      .form-row {
        display: flex;
        margin-bottom: 15px;
        align-items: flex-start;
        gap: 15px;
      }
      .form-label {
        width: 110px;
        font-weight: 600;
        color: #4b5563;
        font-size: 13px;
        padding-top: 10px;
        flex-shrink: 0;
      }
      .form-input-group {
        flex: 1;
      }

      .radio-group {
        display: flex;
        gap: 15px;
        padding-top: 10px;
        font-size: 14px;
      }
      .radio-label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
      }

      .history-item {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        align-items: flex-start;
        gap: 15px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
        transition: 0.2s;
      }
      .history-chk {
        margin-top: 4px;
        transform: scale(1.3);
        cursor: pointer;
        accent-color: #1f4ddc;
      }

      .warning-text {
        color: #b91c1c;
        font-size: 12px;
        margin-top: 8px;
        display: none;
        font-weight: 600;
        background: #fef2f2;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #fecaca;
      }

      #toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 10px 25px;
        border-radius: 30px;
        font-size: 13px;
        opacity: 0;
        transition: 0.3s;
        pointer-events: none;
        z-index: 3000;
      }
    </style>
  </head>
  <body>
    <div id="toast">ì•Œë¦¼</div>
    <div class="topbar">ì§„ë¡œí™œë™ê´€ë¦¬ì‹œìŠ¤í…œ</div>

    <div class="container">
      <section class="left">
        <div class="section-header">
          <div class="section-title">í•™ìƒí™œë™ ë°ì´í„° êµ¬ì„±</div>
          <button class="btn accent" onclick="openModal()">
            ğŸ“… ëˆ„ê°€ê¸°ë¡ ìƒì„¸ ê´€ë¦¬
          </button>
        </div>

        <div
          style="
            background: #eef2ff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #c7d2fe;
            margin-bottom: 10px;
            flex-shrink: 0;
          "
        >
          <strong
            style="color: #3730a3; display: flex; align-items: center; gap: 8px"
          >
            ğŸ§‘â€ğŸ“ í•™ìƒëª…: ì´í˜„íƒœ
            <span style="font-size: 12px; color: #555">(ê³ ì •)</span>
          </strong>
        </div>

        <div
          style="flex: 1; display: flex; flex-direction: column; min-height: 0"
        >
          <div class="section-header" style="margin-top: 5px; flex-shrink: 0">
            <label class="section-title">ìƒì„± ëŒ€ê¸° ì¤‘ì¸ í™œë™ (ì„ íƒë¨)</label>
          </div>
          <textarea
            id="rawDataDisplay"
            class="textarea"
            readonly
            placeholder="[ëˆ„ê°€ê¸°ë¡ ìƒì„¸ ê´€ë¦¬]ì—ì„œ ì²´í¬ëœ ì§„ë¡œ í™œë™ë“¤ì´ í‘œì‹œë©ë‹ˆë‹¤."
            style="background: #f9fafb; color: #555; flex: 1; line-height: 1.8"
          ></textarea>
        </div>

        <button
          class="btn primary"
          style="height: 50px; font-size: 16px; margin: 15px 0; flex-shrink: 0"
          onclick="generateCareerAI()"
        >
          âœ¨ AI ì§„ë¡œ ë¬¸ì¥ ìƒì„±
        </button>

        <div
          style="flex: 1; display: flex; flex-direction: column; min-height: 0"
        >
          <label
            class="section-title"
            style="margin-bottom: 8px; flex-shrink: 0"
            >AI ìƒì„± ì´ˆì•ˆ</label
          >
          <textarea
            id="tempDraft"
            class="textarea"
            style="
              background: #fdfbff;
              border-color: #c7d2fe;
              flex: 1;
              line-height: 1.8;
            "
          ></textarea>
          <button
            class="btn success"
            style="width: 100%; margin-top: 10px; flex-shrink: 0"
            onclick="moveToFinal()"
          >
            ìš°ì¸¡ ìµœì¢… ê²°ê³¼ë¡œ ë°˜ì˜ â†’
          </button>
        </div>
      </section>

      <section class="right">
        <div class="section-header" style="margin-bottom: 15px">
          <div class="section-title">NEIS ê¸°ì¬ ìµœì¢… ë‚´ìš©</div>
          <div style="display: flex; gap: 8px">
            <button class="btn danger" onclick="clearFinal()">
              ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
            </button>
            <button
              class="btn"
              style="background: #8b5cf6; color: white; border-color: #7c3aed"
              onclick="checkIntegrity()"
            >
              ğŸª„ ì „ì²´ ë¬¸ë§¥ ë‹¤ë“¬ê¸° (íë¦„ ìµœì í™”)
            </button>
            <button class="btn success" onclick="finalApply()">
              ğŸ’¾ ì ìš©í•˜ê¸°
            </button>
          </div>
        </div>

        <div
          style="
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 15px;
            min-height: 0;
          "
        >
          <div
            id="finalPreview"
            class="preview-box"
            contenteditable="true"
            oninput="updateByte()"
          ></div>

          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              flex-shrink: 0;
            "
          >
            <div class="counter">
              ì‹¤ì‹œê°„ ìš©ëŸ‰:
              <span id="byteCount" style="color: #1f4ddc; font-weight: 700"
                >0</span
              >
              / 1500 Byte
            </div>
          </div>

          <div class="info-layer" id="infoLayer">
            <span style="font-weight: 700; display: block; margin-bottom: 8px"
              >ğŸ“‹ í¬í•¨ëœ ì •ë³´ ìš”ì•½ (í´ë¦­ ì‹œ ë¬¸ì¥ ìœ„ì¹˜ í‘œì‹œ)</span
            >
            <div id="infoContentContainer" style="color: #999">
              ìƒì„±ëœ ë¬¸ë‹¨ì— í¬í•¨ëœ ì§„ë¡œ í™œë™ ë‚´ì—­ì´ ëˆ„ì ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </section>
    </div>

    <div id="logModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span style="font-size: 18px; font-weight: 700; color: #374151"
            >í•™ìƒë³„ ì§„ë¡œ ëˆ„ê°€ê¸°ë¡ ìƒì„¸ ê´€ë¦¬</span
          >
          <button class="btn" onclick="closeModal()">ë‹«ê¸° (ìë™ ì €ì¥ë¨)</button>
        </div>
        <div class="modal-body">
          <div class="student-list" id="modalStudentList"></div>

          <div class="log-entry">
            <div class="tab-menu">
              <div class="tab-btn active" onclick="switchTab('basic', this)">
                ğŸ“ ì§„ë¡œ ê²€ì‚¬ ë° ìƒë‹´
              </div>
              <div class="tab-btn" onclick="switchTab('explore', this)">
                ğŸš€ ì „ê³µ íƒêµ¬ ë° ê°•ì—°
              </div>
            </div>

            <div id="tab-basic" class="tab-content active">
              <div class="form-box">
                <div class="form-row">
                  <div class="form-label">í™œë™ ì¼ì</div>
                  <div class="form-input-group">
                    <input
                      type="date"
                      id="basicDate"
                      class="input"
                      style="width: 200px"
                    />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-label">í•´ë‹¹ í¬ë§ ì§„ë¡œ</div>
                  <div class="form-input-group">
                    <div style="display: flex; gap: 10px">
                      <select
                        id="basicCareer"
                        class="select"
                        onchange="toggleCustomCareer('basic')"
                        style="flex: 1"
                      >
                        <option value="" disabled selected>
                          í¬ë§ ì§ì—…êµ° ì„ íƒ (í™œë™ ë‹¹ì‹œ ê¸°ì¤€)
                        </option>
                        <option value="developer">ğŸ’» ì»´í“¨í„°/SW (ê°œë°œì)</option>
                        <option value="doctor">ğŸ©º ì˜í•™/ë³´ê±´ (ì˜ì‚¬)</option>
                        <option value="teacher">ğŸ“ êµìœ¡ (êµì‚¬)</option>
                        <option value="business">ğŸ’¼ ê²½ì˜/ê²½ì œ (CEO)</option>
                        <option value="engineer">âš™ï¸ ê³µí•™/ì—”ì§€ë‹ˆì–´</option>
                        <option value="art">ğŸ¨ ì˜ˆìˆ /ë””ìì¸</option>
                        <option value="undecided">
                          â“ ì§„ë¡œ ë¯¸ì • (íƒìƒ‰ ì¤‘)
                        </option>
                        <option value="custom">âœï¸ ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)</option>
                      </select>
                      <input
                        type="text"
                        id="basicCustomCareer"
                        class="input"
                        placeholder="ì§ì—…ëª… ì§ì ‘ ì…ë ¥ (ìµœëŒ€ 15ì)"
                        maxlength="15"
                        style="flex: 1; display: none"
                      />
                    </div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-label">í™œë™ ìœ í˜•</div>
                  <div class="form-input-group radio-group">
                    <label class="radio-label"
                      ><input
                        type="radio"
                        name="basicType"
                        value="test"
                        checked
                        onchange="toggleBasicForm()"
                      />
                      ì§„ë¡œ/ì ì„± ê²€ì‚¬</label
                    >
                    <label class="radio-label"
                      ><input
                        type="radio"
                        name="basicType"
                        value="counsel"
                        onchange="toggleBasicForm()"
                      />
                      ì§„ë¡œ/ê°œì¸ ìƒë‹´</label
                    >
                  </div>
                </div>

                <div id="basicTestForm">
                  <div class="form-row">
                    <div class="form-label">ì§„ë¡œ ê²€ì‚¬ëª…</div>
                    <div class="form-input-group">
                      <select id="testName" class="select">
                        <option value="" disabled selected>
                          ì‹¤ì‹œí•œ ê²€ì‚¬ ì„ íƒ
                        </option>
                        <option>ì»¤ë¦¬ì–´ë„· ì§ì—…í¥ë¯¸ê²€ì‚¬(Hí˜•)</option>
                        <option>ì§ì—…ê°€ì¹˜ê´€ê²€ì‚¬</option>
                        <option>ì§ì—…ì ì„±ê²€ì‚¬</option>
                        <option>ë‹¤ì¤‘ì§€ëŠ¥ê²€ì‚¬</option>
                        <option>MBTI ì„±ê²©ìœ í˜•ê²€ì‚¬</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-label">ê²€ì‚¬ ê²°ê³¼ (ìˆœìœ„)</div>
                    <div
                      class="form-input-group"
                      style="display: flex; gap: 10px"
                    >
                      <select id="testR1" class="select" style="flex: 1">
                        <option value="" disabled selected>1ìˆœìœ„</option>
                        <option>í˜„ì‹¤í˜•</option>
                        <option>íƒêµ¬í˜•</option>
                        <option>ì˜ˆìˆ í˜•</option>
                        <option>ì‚¬íšŒí˜•</option>
                        <option>ì§„ì·¨í˜•</option>
                        <option>ê´€ìŠµí˜•</option>
                        <option>ë…¼ë¦¬ìˆ˜í•™</option>
                        <option>ì–¸ì–´</option>
                        <option>ëŒ€ì¸ê´€ê³„</option>
                        <option>ìì—°ì¹œí™”</option>
                        <option>ìê¸°ì„±ì°°</option>
                      </select>
                      <select id="testR2" class="select" style="flex: 1">
                        <option value="" disabled selected>2ìˆœìœ„</option>
                        <option>í˜„ì‹¤í˜•</option>
                        <option>íƒêµ¬í˜•</option>
                        <option>ì˜ˆìˆ í˜•</option>
                        <option>ì‚¬íšŒí˜•</option>
                        <option>ì§„ì·¨í˜•</option>
                        <option>ê´€ìŠµí˜•</option>
                        <option>ë…¼ë¦¬ìˆ˜í•™</option>
                        <option>ì–¸ì–´</option>
                        <option>ëŒ€ì¸ê´€ê³„</option>
                        <option>ìì—°ì¹œí™”</option>
                        <option>ìê¸°ì„±ì°°</option>
                      </select>
                      <select id="testR3" class="select" style="flex: 1">
                        <option value="" disabled selected>3ìˆœìœ„</option>
                        <option>í˜„ì‹¤í˜•</option>
                        <option>íƒêµ¬í˜•</option>
                        <option>ì˜ˆìˆ í˜•</option>
                        <option>ì‚¬íšŒí˜•</option>
                        <option>ì§„ì·¨í˜•</option>
                        <option>ê´€ìŠµí˜•</option>
                        <option>ë…¼ë¦¬ìˆ˜í•™</option>
                        <option>ì–¸ì–´</option>
                        <option>ëŒ€ì¸ê´€ê³„</option>
                        <option>ìì—°ì¹œí™”</option>
                        <option>ìê¸°ì„±ì°°</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div id="basicCounselForm" style="display: none">
                  <div class="form-row">
                    <div class="form-label">ìƒë‹´ ë‚´ìš©/ê²°ê³¼</div>
                    <div class="form-input-group">
                      <textarea
                        id="counselContent"
                        class="textarea"
                        style="height: 80px"
                        placeholder="ìƒë‹´í•œ ë‚´ìš©ê³¼ ê²°ê³¼, ëŠë‚€ ì ì„ ì…ë ¥í•˜ì„¸ìš”."
                      ></textarea>
                    </div>
                  </div>
                </div>

                <div style="text-align: right">
                  <button
                    class="btn primary"
                    id="btnSaveBasic"
                    onclick="saveActivity('basic')"
                  >
                    + ëª©ë¡ì— ì¶”ê°€/ì €ì¥
                  </button>
                </div>
              </div>
            </div>

            <div id="tab-explore" class="tab-content">
              <div class="form-box">
                <div class="form-row">
                  <div class="form-label">í™œë™ ì¼ì</div>
                  <div class="form-input-group">
                    <input
                      type="date"
                      id="exploreDate"
                      class="input"
                      style="width: 200px"
                    />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-label">í•´ë‹¹ í¬ë§ ì§„ë¡œ</div>
                  <div class="form-input-group">
                    <div style="display: flex; gap: 10px">
                      <select
                        id="exploreCareer"
                        class="select"
                        onchange="toggleCustomCareer('explore')"
                        style="flex: 1"
                      >
                        <option value="" disabled selected>
                          í¬ë§ ì§ì—…êµ° ì„ íƒ (í™œë™ ë‹¹ì‹œ ê¸°ì¤€)
                        </option>
                        <option value="developer">ğŸ’» ì»´í“¨í„°/SW (ê°œë°œì)</option>
                        <option value="doctor">ğŸ©º ì˜í•™/ë³´ê±´ (ì˜ì‚¬)</option>
                        <option value="teacher">ğŸ“ êµìœ¡ (êµì‚¬)</option>
                        <option value="business">ğŸ’¼ ê²½ì˜/ê²½ì œ (CEO)</option>
                        <option value="engineer">âš™ï¸ ê³µí•™/ì—”ì§€ë‹ˆì–´</option>
                        <option value="art">ğŸ¨ ì˜ˆìˆ /ë””ìì¸</option>
                        <option value="undecided">
                          â“ ì§„ë¡œ ë¯¸ì • (íƒìƒ‰ ì¤‘)
                        </option>
                        <option value="custom">âœï¸ ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)</option>
                      </select>
                      <input
                        type="text"
                        id="exploreCustomCareer"
                        class="input"
                        placeholder="ì§ì—…ëª… ì§ì ‘ ì…ë ¥ (ìµœëŒ€ 15ì)"
                        maxlength="15"
                        style="flex: 1; display: none"
                      />
                    </div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-label">í™œë™ ìœ í˜•</div>
                  <div class="form-input-group radio-group">
                    <label class="radio-label"
                      ><input
                        type="radio"
                        name="exploreType"
                        value="lecture"
                        checked
                      />
                      ì™¸ë¶€ íŠ¹ê°• ë° ê°•ì—°</label
                    >
                    <label class="radio-label"
                      ><input
                        type="radio"
                        name="exploreType"
                        value="activity"
                      />
                      ì „ê³µ ììœ¨ íƒêµ¬(ì—°êµ¬)</label
                    >
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-label">ê°•ì—°/íƒêµ¬ ì£¼ì œ</div>
                  <div class="form-input-group">
                    <input
                      type="text"
                      id="exploreTopic"
                      class="input"
                      placeholder="ê°•ì—°ëª… ë˜ëŠ” íƒêµ¬ ì£¼ì œë¥¼ ëª…í™•íˆ ì…ë ¥í•˜ì„¸ìš”."
                    />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-label">í•µì‹¬ ë‚´ìš©/ì„±ê³¼</div>
                  <div class="form-input-group">
                    <textarea
                      id="exploreContent"
                      class="textarea"
                      style="height: 80px"
                      placeholder="ìƒˆë¡­ê²Œ ì•Œê²Œ ëœ ì§€ì‹, ì „ê³µ ì í•©ì„± ë“± í™œë™ì˜ ì„±ê³¼ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
                    ></textarea>
                  </div>
                </div>

                <div style="text-align: right">
                  <button
                    class="btn primary"
                    id="btnSaveExplore"
                    onclick="saveActivity('explore')"
                  >
                    + ëª©ë¡ì— ì¶”ê°€/ì €ì¥
                  </button>
                </div>
              </div>
            </div>

            <div
              style="
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 0;
              "
            >
              <div
                style="
                  margin-bottom: 10px;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  flex-shrink: 0;
                "
              >
                <span style="font-weight: 700; color: #374151"
                  >ğŸ•’ ì…ë ¥ëœ ê¸°ë¡ ëª©ë¡</span
                >
                <div>
                  <button class="btn sm" onclick="checkAll(true)">
                    ì „ì²´ ì„ íƒ
                  </button>
                  <button class="btn sm" onclick="checkAll(false)">
                    ì „ì²´ í•´ì œ
                  </button>
                </div>
              </div>
              <div
                id="historyListContainer"
                style="overflow-y: auto; flex: 1; padding-right: 5px"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let studentHistory = [];
      let finalHistoryStack = [];
      let historyIdCounter = 0;
      let tempContext = null;
      let currentEditId = null; // ìˆ˜ì • ë¡¤ë°± ë°©ì–´ ë³€ìˆ˜

      /* ì¡°ì‚¬ ì²˜ë¦¬ ê³ ë„í™” (ë°›ì¹¨ ìœ ë¬´ ìˆ˜í•™ì  ê³„ì‚°) */
      function resolveJosa(word, type) {
        if (!word) return "";
        const lastChar = word.charCodeAt(word.length - 1);
        if (lastChar < 0xac00 || lastChar > 0xd7a3)
          return type === "ul" ? "ì„(ë¥¼)" : "ì´(ê°€)";
        const hasBatchim = (lastChar - 0xac00) % 28 > 0;
        if (type === "ul") return hasBatchim ? "ì„" : "ë¥¼";
        if (type === "i") return hasBatchim ? "ì´" : "ê°€";
        return "";
      }

      window.onload = () => {
        const list = document.getElementById("modalStudentList");
        const div = document.createElement("div");
        div.className = "student-item active";
        div.textContent = "ì´í˜„íƒœ";
        list.appendChild(div);
        renderHistory();
      };

      function openModal() {
        document.getElementById("logModal").style.display = "block";
      }
      function closeModal() {
        document.getElementById("logModal").style.display = "none";
        updateMainSummary();
        currentEditId = null;
        resetButtons();
      }

      function switchTab(tabId, btn) {
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));
        document.getElementById("tab-" + tabId).classList.add("active");
      }

      function toggleCustomCareer(tabType) {
        const val = document.getElementById(tabType + "Career").value;
        const input = document.getElementById(tabType + "CustomCareer");
        input.style.display = val === "custom" ? "block" : "none";
      }

      function toggleBasicForm() {
        const type = document.querySelector(
          "input[name=basicType]:checked"
        ).value;
        document.getElementById("basicTestForm").style.display =
          type === "test" ? "block" : "none";
        document.getElementById("basicCounselForm").style.display =
          type === "counsel" ? "block" : "none";
      }

      /* ì•ˆì „ ë¡¤ë°± ì €ì¥ì„ ìœ„í•œ ë²„íŠ¼ ì´ˆê¸°í™” */
      function resetButtons() {
        document.getElementById("btnSaveBasic").innerText =
          "+ ëª©ë¡ì— ì¶”ê°€/ì €ì¥";
        document.getElementById("btnSaveExplore").innerText =
          "+ ëª©ë¡ì— ì¶”ê°€/ì €ì¥";
        currentEditId = null;
      }

      /* --- [1ì°¨ ë°©ì–´] í™œë™ ì €ì¥ ë° ì¤„ë°”ê¿ˆ/ì…ë ¥ ê²€ì¦ ë¡œì§ --- */
      function saveActivity(tabId) {
        let data = {
          id: currentEditId ? currentEditId : ++historyIdCounter,
          tabId,
          checked: true,
        };

        data.date = document.getElementById(tabId + "Date").value;
        let jobCode = document.getElementById(tabId + "Career").value;
        let customJob = document
          .getElementById(tabId + "CustomCareer")
          .value.trim();

        if (!data.date) return alert("í™œë™ ì¼ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        if (!jobCode) return alert("í¬ë§ ì§„ë¡œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        if (jobCode === "custom" && !customJob)
          return alert("í¬ë§ ì§„ë¡œ(ì§ì—…ëª…)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        data.jobCode = jobCode;
        data.jobLabel =
          jobCode === "custom"
            ? customJob
            : document
                .querySelector(`#${tabId}Career option[value="${jobCode}"]`)
                .text.split("(")[1]
                .replace(")", "");

        if (tabId === "basic") {
          data.subType = document.querySelector(
            "input[name=basicType]:checked"
          ).value;
          if (data.subType === "test") {
            data.topic = document.getElementById("testName").value;
            data.r1 = document.getElementById("testR1").value;
            data.r2 = document.getElementById("testR2").value;
            data.r3 = document.getElementById("testR3").value;
            if (!data.topic || !data.r1 || !data.r2 || !data.r3)
              return alert("ê²€ì‚¬ëª…ê³¼ 1~3ìˆœìœ„ ê²°ê³¼ë¥¼ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.");
            if (
              data.r1 === data.r2 ||
              data.r1 === data.r3 ||
              data.r2 === data.r3
            )
              return alert("ìˆœìœ„ ê²°ê³¼ëŠ” ì¤‘ë³µë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            data.hashKey = `TEST|${data.date}|${data.topic}|${data.r1}`;
          } else {
            // ì¤„ë°”ê¿ˆ ë°©ì–´ (ì—”í„° í…ŒëŸ¬ ë°©ì§€)
            data.content = document
              .getElementById("counselContent")
              .value.replace(/\n/g, " ")
              .trim();
            if (!data.content) return alert("ìƒë‹´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
            data.hashKey = `COUNSEL|${data.date}|${data.content.substring(
              0,
              10
            )}`;
          }
        } else {
          data.subType = document.querySelector(
            "input[name=exploreType]:checked"
          ).value;
          data.topic = document.getElementById("exploreTopic").value.trim();
          data.content = document
            .getElementById("exploreContent")
            .value.replace(/\n/g, " ")
            .trim();
          if (!data.topic || !data.content)
            return alert("ì£¼ì œì™€ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");

          data.hashKey = `EXPLORE|${data.subType}|${data.date}|${data.topic}`;
        }

        // ìˆ˜ì •(Edit) ëª¨ë“œì¼ ê²½ìš° ê¸°ì¡´ ë°ì´í„° ê°ˆì•„ë¼ìš°ê¸° (ë°ì´í„° ì¦ë°œ ë°©ì–´)
        if (currentEditId) {
          studentHistory = studentHistory.map((h) =>
            h.id === currentEditId ? data : h
          );
          currentEditId = null;
          resetButtons();
        } else {
          if (studentHistory.some((h) => h.hashKey === data.hashKey))
            return alert("ì´ë¯¸ ë“±ë¡ëœ ë™ì¼í•œ í™œë™ì´ ìˆìŠµë‹ˆë‹¤.");
          studentHistory.forEach((h) => (h.checked = false));
          studentHistory.push(data);
        }

        // í¼ ì´ˆê¸°í™”
        document.getElementById(tabId + "Date").value = "";
        if (tabId === "basic") {
          document.getElementById("testName").value = "";
          document.getElementById("testR1").value = "";
          document.getElementById("testR2").value = "";
          document.getElementById("testR3").value = "";
          document.getElementById("counselContent").value = "";
        } else {
          document.getElementById("exploreTopic").value = "";
          document.getElementById("exploreContent").value = "";
        }

        renderHistory();
        showToast("ëª©ë¡ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      function renderHistory() {
        const container = document.getElementById("historyListContainer");
        if (!studentHistory.length) {
          container.innerHTML =
            '<div style="text-align:center;color:#999;padding:20px; border:1px solid #e5e7eb; border-radius:8px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        let html = "";
        [...studentHistory]
          .sort((a, b) => b.date.localeCompare(a.date))
          .forEach((item) => {
            let badgeColor =
              item.subType === "test"
                ? "#8b5cf6"
                : item.subType === "counsel"
                ? "#10b981"
                : item.subType === "lecture"
                ? "#f59e0b"
                : "#3b82f6";
            let badgeText =
              item.subType === "test"
                ? "ì§„ë¡œê²€ì‚¬"
                : item.subType === "counsel"
                ? "ì§„ë¡œìƒë‹´"
                : item.subType === "lecture"
                ? "ì™¸ë¶€ê°•ì—°"
                : "ì „ê³µíƒêµ¬";

            let dTitle =
              item.subType === "counsel" ? "[ì§„ë¡œ/ê°œì¸ ìƒë‹´]" : item.topic;
            let dDesc =
              item.subType === "test"
                ? `${item.r1}, ${item.r2}, ${item.r3} ì˜ì—­ ê°•ì `
                : item.content;

            html += `
            <div class="history-item" style="${
              item.checked
                ? "border-left:4px solid #1f4ddc;"
                : "border-left:4px solid transparent;"
            }">
                <input type="checkbox" class="history-chk" ${
                  item.checked ? "checked" : ""
                } onchange="toggleCheck(${item.id})" style="margin-top:2px;">
                <div style="flex:1;">
                    <div style="font-size:12px; color:#666; margin-bottom:4px;">
                        <span style="background:#e0f2fe; color:#0369a1; padding:2px 6px; border-radius:4px; font-weight:bold; margin-right:5px;">í¬ë§: ${
                          item.jobLabel
                        }</span>
                        ${item.date}
                    </div>
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:6px;">
                        <span style="background:${badgeColor}; color:#fff; font-size:11px; padding:2px 6px; border-radius:4px; font-weight:bold;">${badgeText}</span>
                        <strong style="font-size:14px; color:#333;">${dTitle}</strong>
                    </div>
                    <div style="font-size:13px; color:#555; line-height:1.4;">${dDesc}</div>
                </div>
                <div style="display:flex; flex-direction:column; gap:5px;">
                    <button class="btn sm warning" onclick="editHistory(${
                      item.id
                    })">ìˆ˜ì •</button>
                    <button class="btn sm" style="color:red; border:1px solid #ffcccc; background:#fff;" onclick="deleteHistory(${
                      item.id
                    })">ì‚­ì œ</button>
                </div>
            </div>`;
          });
        container.innerHTML = html;
      }

      function editHistory(id) {
        const item = studentHistory.find((i) => i.id === id);
        if (!item) return;

        currentEditId = id; // [í•µì‹¬] ì•ˆì „ ë¡¤ë°±ì„ ìœ„í•´ ID ìœ ì§€

        let btnIndex = item.tabId === "basic" ? 0 : 1;
        document.querySelectorAll(".tab-btn")[btnIndex].click();

        document.getElementById(item.tabId + "Date").value = item.date;
        document.getElementById(item.tabId + "Career").value = item.jobCode;
        toggleCustomCareer(item.tabId);
        if (item.jobCode === "custom")
          document.getElementById(item.tabId + "CustomCareer").value =
            item.jobLabel;

        if (item.tabId === "basic") {
          document.querySelector(
            `input[name=basicType][value=${item.subType}]`
          ).checked = true;
          toggleBasicForm();
          if (item.subType === "test") {
            document.getElementById("testName").value = item.topic;
            document.getElementById("testR1").value = item.r1;
            document.getElementById("testR2").value = item.r2;
            document.getElementById("testR3").value = item.r3;
          } else {
            document.getElementById("counselContent").value = item.content;
          }
          document.getElementById("btnSaveBasic").innerText = "ğŸ’¾ ìˆ˜ì • ì™„ë£Œ";
        } else {
          document.querySelector(
            `input[name=exploreType][value=${item.subType}]`
          ).checked = true;
          document.getElementById("exploreTopic").value = item.topic;
          document.getElementById("exploreContent").value = item.content;
          document.getElementById("btnSaveExplore").innerText = "ğŸ’¾ ìˆ˜ì • ì™„ë£Œ";
        }
      }

      function toggleCheck(id) {
        const item = studentHistory.find((i) => i.id === id);
        if (item) item.checked = !item.checked;
        renderHistory();
        updateMainSummary();
      }
      function checkAll(state) {
        studentHistory.forEach((h) => (h.checked = state));
        renderHistory();
        updateMainSummary();
      }
      function deleteHistory(id) {
        if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        studentHistory = studentHistory.filter((i) => i.id !== id);
        renderHistory();
        updateMainSummary();
      }

      function updateMainSummary() {
        const active = studentHistory.filter((h) => h.checked);
        let text = "[ìƒì„± ëŒ€ê¸° ì¤‘ì¸ í™œë™]\n\n";
        active
          .sort((a, b) => a.date.localeCompare(b.date))
          .forEach((h, i) => {
            let dTitle = h.subType === "counsel" ? "ì§„ë¡œ ìƒë‹´" : h.topic;
            text += `${i + 1}. [${h.jobLabel}] ${dTitle} (${h.date})\n\n`;
          });
        document.getElementById("rawDataDisplay").value = active.length
          ? text
          : "ì²´í¬ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.";
      }

      /* --- [í•µì‹¬] ë‹¤ì¤‘ ì§„ë¡œ ìœµí•© ìƒì„± ì—”ì§„ & ì „ë¬¸ ì–´íœ˜ DB --- */
      function generateCareerAI() {
        let targets = studentHistory.filter((h) => h.checked);
        if (targets.length === 0) return alert("ìƒì„±í•  í™œë™ì„ ì„ íƒí•˜ì„¸ìš”.");

        targets.sort((a, b) => a.date.localeCompare(b.date));

        // ì§„ë¡œ íë¦„(Timeline) ì¶”ì 
        let jobs = [...new Set(targets.map((t) => t.jobLabel))];
        let lastJob = jobs[jobs.length - 1];
        let intro = "";

        if (jobs.length === 1) {
          intro = `í‰ì†Œ ${lastJob} ë¶„ì•¼ì— ê¹Šì€ ê´€ì‹¬ì„ ê°€ì§€ê³  ìˆìœ¼ë©°, ê´€ë ¨ ì—­ëŸ‰ì„ í‚¤ìš°ê¸° ìœ„í•´ ì£¼ë„ì ìœ¼ë¡œ ì§„ë¡œ íƒìƒ‰ì— ì„í•˜ëŠ” í•™ìƒì„. `;
        } else if (jobs.length === 2) {
          intro = `ì´ˆê¸°ì—ëŠ” ${jobs[0]} ë¶„ì•¼ì— ê´€ì‹¬ì´ ìˆì—ˆìœ¼ë‚˜, ì´í›„ ë‹¤ì–‘í•œ íƒìƒ‰ ê³¼ì •ì„ ê±°ì¹˜ë©° ${lastJob} ë¶„ì•¼ë¡œ ì§„ë¡œë¥¼ êµ¬ì²´í™”í•˜ê³  ì—­ëŸ‰ì„ ê°œë°œí•¨. `;
        } else {
          intro = `ë‹¤ì–‘í•œ ë¶„ì•¼ì— ëŒ€í•œ í˜¸ê¸°ì‹¬ì„ ë°”íƒ•ìœ¼ë¡œ ì§„ë¡œë¥¼ íƒìƒ‰í•œ ëì—, ìµœì¢…ì ìœ¼ë¡œ ${lastJob} ë¶„ì•¼ë¡œ ì§„ë¡œ ë°©í–¥ì„±ì„ ëšœë ·í•˜ê²Œ í™•ë¦½í•¨. `;
        }
        if (["ë¯¸ì •", "íƒìƒ‰ ì¤‘"].includes(lastJob)) {
          intro = `ìì‹ ì˜ ì ì„±ì„ ì°¾ê¸° ìœ„í•´ ë‹¤ì–‘í•œ ì§„ë¡œ ì²´í—˜ í™œë™ì— ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•˜ë©° í­ë„“ì€ ì‹œê°ì„ ê¸°ë¥´ê³  ìˆìŒ. `;
        }

        let body = "";
        let actsMapping = [];
        let summaryNames = [];

        targets.forEach((item) => {
          actsMapping.push({
            hashKey: item.hashKey,
            name: item.topic || "ì§„ë¡œ ìƒë‹´",
          });
          summaryNames.push(item.topic || "ì§„ë¡œ ìƒë‹´");

          if (item.subType === "test") {
            body += `${item.topic}ì— ì°¸ì—¬í•˜ì—¬ ${item.r1}, ${item.r2}, ${item.r3} ì„±í–¥ì´ ë†’ê²Œ ë‚˜íƒ€ë‚¨ì„ í™•ì¸í•˜ê³ , ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìì‹ ì˜ ê°•ì ì„ ê°ê´€ì ìœ¼ë¡œ íŒŒì•…í•¨. `;
          } else if (item.subType === "counsel") {
            body += `ì§„ë¡œ ìƒë‹´ì„ í†µí•´ ${item.content}ì— ëŒ€í•´ ì‹¬ë„ ìˆê²Œ ë…¼ì˜í•˜ê³  êµ¬ì²´ì ì¸ ì§„ë¡œ ë¡œë“œë§µì„ ìˆ˜ë¦½í•¨. `;
          } else if (item.subType === "lecture") {
            const josa = resolveJosa(item.topic, "ul");
            body += `${item.topic}${josa} ì£¼ì œë¡œ í•œ íŠ¹ê°•ì„ ê²½ì²­í•˜ê³  ${item.content}ë¥¼ í•™ìŠµí•˜ë©° ê´€ë ¨ ë¶„ì•¼ì˜ ì‹¤ë¬´ì  ì§€ì‹ê³¼ ì§ì—… ê°€ì¹˜ê´€ì„ ì •ë¦½í•¨. `;
          } else {
            const josa = resolveJosa(item.topic, "ul");
            body += `${item.topic}${josa} ì£¼ì œë¡œ íƒêµ¬ í™œë™ì„ ì£¼ë„ì ìœ¼ë¡œ ìˆ˜í–‰í•˜ë©° ${item.content} ë“± ì „ê³µì— ëŒ€í•œ ì‹¬ë„ ìˆëŠ” ì´í•´ë„ì™€ ìê¸°ì£¼ë„ì  íƒêµ¬ ì—­ëŸ‰ì„ ë³´ì—¬ì¤Œ. `;
          }
        });

        let outro = `ì´ëŸ¬í•œ ì¼ë ¨ì˜ ì§„ë¡œ íƒìƒ‰ ê³¼ì •ì„ í†µí•´ ë¯¸ë˜ì˜ ${
          !["ë¯¸ì •", "íƒìƒ‰ ì¤‘"].includes(lastJob) ? lastJob : "í•µì‹¬ ì¸ì¬"
        }ë¡œì„œì˜ ìì§ˆì„ íƒ„íƒ„íˆ í•¨ì–‘í•¨.`;

        let resultText = (intro + body + outro).replace(/\s+/g, " ").trim();

        document.getElementById("tempDraft").value = resultText;
        tempContext = {
          actsMap: actsMapping,
          len: resultText.length,
          summary: summaryNames,
        };
        showToast("ì§„ë¡œ AI ë¬¸ë‹¨ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      /* --- ë”¥ ë“€í”Œë¦¬ì¼€ì´ì…˜ & ì „ì†¡ ì œì–´ (1500 Byte ë½) --- */
      function updateDuplicateStatus() {
        let hashCounts = {};
        finalHistoryStack.forEach((item) => {
          if (item.status === "active" && item.actsMap) {
            item.actsMap.forEach((act) => {
              hashCounts[act.hashKey] = (hashCounts[act.hashKey] || 0) + 1;
            });
          }
        });
        finalHistoryStack.forEach((item) => {
          if (item.status === "active" && item.actsMap) {
            let dupActs = item.actsMap.filter(
              (act) => hashCounts[act.hashKey] > 1
            );
            item.isDuplicate = dupActs.length > 0;
            item.dupNames = dupActs.map((a) => a.name);
          } else {
            item.isDuplicate = false;
            item.dupNames = [];
          }
        });
      }

      function moveToFinal() {
        const text = document.getElementById("tempDraft").value;
        const preview = document.getElementById("finalPreview");
        if (!text || !tempContext) return alert("ìƒì„±ëœ ë¬¸ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.");

        // [í•˜ë“œ ë½] ë°”ì´íŠ¸ ì œí•œ ê²€ì‚¬
        let currentText = preview.innerText;
        let b = 0;
        let testText = currentText + " " + text;
        for (let i = 0; i < testText.length; i++)
          b += testText.charCodeAt(i) > 127 ? 3 : 1;
        if (b > 1500)
          return alert(
            "âš ï¸ ìƒê¸°ë¶€ ìµœëŒ€ ìš©ëŸ‰(1500 Byte)ì„ ì´ˆê³¼í•˜ì—¬ ë” ì´ìƒ ì „ì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          );

        let duplicateNames = [];
        tempContext.actsMap.forEach((act) => {
          if (
            finalHistoryStack.some(
              (fh) =>
                fh.status === "active" &&
                fh.actsMap &&
                fh.actsMap.some((a) => a.hashKey === act.hashKey)
            )
          ) {
            duplicateNames.push(act.name);
          }
        });
        let isDuplicate = duplicateNames.length > 0;

        if (preview.innerText.trim() === "") preview.innerText = "";
        else preview.appendChild(document.createTextNode(" "));

        const uniqueId = "block_" + Date.now();
        const span = document.createElement("span");
        span.className = "sentence-block";
        span.id = uniqueId;
        span.innerText = text;
        preview.appendChild(span);

        finalHistoryStack.push({
          id: uniqueId,
          summary: tempContext.summary,
          actsMap: tempContext.actsMap,
          len: text.length,
          status: "active",
          isDuplicate: isDuplicate,
          dupNames: duplicateNames,
        });

        updateDuplicateStatus();
        renderInfoLayer();
        updateByte();
        if (isDuplicate)
          showToast(`âš ï¸ ì¤‘ë³µ ê°ì§€: ì´ë¯¸ ì‘ì„±ëœ í™œë™ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
      }

      function renderInfoLayer() {
        const con = document.getElementById("infoContentContainer");
        con.innerHTML = "";
        if (finalHistoryStack.length === 0) {
          con.innerHTML = "ìƒì„± ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        finalHistoryStack.forEach((item) => {
          const div = document.createElement("div");
          div.className = `info-card ${item.status} ${
            item.isDuplicate ? "duplicate" : ""
          }`;
          div.onclick = () => highlightSentence(item.id);

          let tagsHtml = item.summary
            .map((a) => `<span class="tag">${a}</span>`)
            .join("");
          let delBtn = `<button class="delete-sentence-btn" onclick="deleteFinalSentence(event, '${item.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>`;
          let dupAlert = item.isDuplicate
            ? `<span class="dup-badge" style="margin-left:8px;" title="${item.dupNames.join(
                ", "
              )} ì¤‘ë³µ">âš ï¸ ì¤‘ë³µ ê°ì§€</span>`
            : "";

          let statBadge = "";
          if (item.status === "deleted")
            statBadge =
              "<span class='status-badge' style='background:#ef4444;'>âŒ ì‚­ì œë¨</span>";
          else if (item.status === "modified")
            statBadge = "<span class='status-badge'>âœ… ì§ì ‘ ìˆ˜ì •í•¨</span>";
          else if (item.status === "optimized")
            statBadge =
              "<span class='status-badge' style='background:#8b5cf6;'>ğŸª„ íë¦„ ìµœì í™”ë¨</span>";

          div.innerHTML = `
            <div class="info-header">
                <span style="display:flex; align-items:center;">ğŸ“ ì§„ë¡œ ìƒì„± ê¸°ë¡ ${dupAlert}</span>
                ${delBtn}
            </div>
            ${
              item.status !== "active"
                ? `<div style="margin-bottom:6px;">${statBadge}</div>`
                : ""
            }
            <div class="info-tags">${tagsHtml}</div>`;
          con.appendChild(div);
        });
      }

      function highlightSentence(id) {
        document
          .querySelectorAll(".sentence-block")
          .forEach((el) => el.classList.remove("highlight-active"));
        const target = document.getElementById(id);
        if (target) {
          target.scrollIntoView({ behavior: "smooth", block: "center" });
          target.classList.add("highlight-active");
          setTimeout(() => {
            target.classList.remove("highlight-active");
          }, 2000);
        }
      }

      function deleteFinalSentence(event, id) {
        event.stopPropagation();
        const target = document.getElementById(id);
        if (target) {
          if (target.previousSibling && target.previousSibling.nodeType === 3)
            target.previousSibling.remove();
          target.remove();
        }
        finalHistoryStack = finalHistoryStack.filter((item) => item.id !== id);
        updateDuplicateStatus();
        renderInfoLayer();
        updateByte();
        showToast("ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      /* --- [í•µì‹¬: ë¬¸ë§¥ ìœµí•© ì•Œê³ ë¦¬ì¦˜] ì£¼ì–´/ê²°ë¡  ë°˜ë³µ ì†Œê±° --- */
      function checkIntegrity() {
        let text = document.getElementById("finalPreview").innerText;
        if (!text.trim()) return showToast("ë‹¤ë“¬ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."); // ì—ëŸ¬ 7ë²ˆ ë°©ì–´

        // 1. ì¸íŠ¸ë¡œ(ê´€ì‹¬ ë¶„ì•¼ ì„ ì–¸) ì¤‘ë³µ ì œê±°
        const knownIntros = [
          "í‰ì†Œ ",
          "ì´ˆê¸°ì—ëŠ” ",
          "ë‹¤ì–‘í•œ ë¶„ì•¼ì— ëŒ€í•œ í˜¸ê¸°ì‹¬ì„ ë°”íƒ•ìœ¼ë¡œ ",
          "ìì‹ ì˜ ì ì„±ì„ ì°¾ê¸° ìœ„í•´ ",
        ];

        let introCount = 0;
        let segments = text.split(
          /(?=í‰ì†Œ |ì´ˆê¸°ì—ëŠ” |ë‹¤ì–‘í•œ ë¶„ì•¼ì— ëŒ€í•œ í˜¸ê¸°ì‹¬ì„ ë°”íƒ•ìœ¼ë¡œ |ìì‹ ì˜ ì ì„±ì„ ì°¾ê¸° ìœ„í•´ )/g
        );

        if (segments.length > 1) {
          let optimizedText = segments[0]; // ë³´í†µ ë¹ˆ ë¬¸ìì—´
          for (let i = 1; i < segments.length; i++) {
            let seg = segments[i];
            if (introCount === 0) {
              optimizedText += seg; // ì²« ë²ˆì§¸ ì¸íŠ¸ë¡œëŠ” ì‚´ë¦¼
              introCount++;
            } else {
              // ë‘ ë²ˆì§¸ ì¸íŠ¸ë¡œ ì´í›„ëŠ” ì²« ë²ˆì§¸ ë§ˆì¹¨í‘œ(í•™ìƒì„. ë“±)ê¹Œì§€ë¥¼ ë‚ ë ¤ë²„ë¦¼
              let dotIndex = seg.indexOf("í•¨. ");
              if (dotIndex === -1) dotIndex = seg.indexOf("í•™ìƒì„. ");
              if (dotIndex !== -1) {
                optimizedText += " " + seg.substring(dotIndex + 4).trimStart();
              } else {
                optimizedText += " " + seg;
              }
            }
          }
          text = optimizedText;
        }

        // 2. ì•„ì›ƒíŠ¸ë¡œ ì¤‘ë³µ ì œê±°
        let outroParts = text.split("ì´ëŸ¬í•œ ì¼ë ¨ì˜ ì§„ë¡œ íƒìƒ‰ ê³¼ì •ì„ í†µí•´");
        if (outroParts.length > 1) {
          let finalOutro =
            "ì´ëŸ¬í•œ ì¼ë ¨ì˜ ì§„ë¡œ íƒìƒ‰ ê³¼ì •ì„ í†µí•´" +
            outroParts[outroParts.length - 1];
          let newBody = outroParts[0];
          for (let i = 1; i < outroParts.length - 1; i++) {
            let cutIdx = outroParts[i].indexOf("í•¨ì–‘í•¨.");
            if (cutIdx !== -1)
              newBody += outroParts[i].substring(cutIdx + 4).trimStart();
          }
          text = newBody.trim() + " " + finalOutro;
        }

        text = text.replace(/\s+/g, " ").trim();

        const preview = document.getElementById("finalPreview");
        preview.innerHTML = "";

        const uniqueId = "opt_" + Date.now();
        const span = document.createElement("span");
        span.className = "sentence-block";
        span.id = uniqueId;
        span.innerText = text;
        preview.appendChild(span);

        let mergedActs = [];
        let mergedSummary = [];
        finalHistoryStack.forEach((item) => {
          if (item.status !== "deleted") {
            if (item.actsMap) mergedActs.push(...item.actsMap);
            if (item.summary) mergedSummary.push(...item.summary);
          }
        });
        mergedSummary = [...new Set(mergedSummary)];

        finalHistoryStack = [
          {
            id: uniqueId,
            summary: mergedSummary,
            actsMap: mergedActs,
            len: text.length,
            status: "optimized",
            isDuplicate: false,
            dupNames: [],
          },
        ];

        renderInfoLayer();
        updateByte();
        showToast("ì§„ë¡œ íë¦„ ë° ë¬¸ë§¥ì´ ì™„ë²½í•˜ê²Œ ìµœì í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      function clearFinal() {
        if (confirm("ì „ì²´ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          document.getElementById("finalPreview").innerText = "";
          finalHistoryStack = [];
          renderInfoLayer();
          updateByte();
        }
      }

      function updateByte() {
        const text = document.getElementById("finalPreview").innerText;
        let bytes = 0;
        for (let i = 0; i < text.length; i++)
          bytes += text.charCodeAt(i) > 127 ? 3 : 1;
        document.getElementById("byteCount").innerText = bytes;
        document.getElementById("byteCount").style.color =
          bytes > 1500 ? "red" : "#1f4ddc";
      }
      function finalApply() {
        alert("NEIS ì…ë ¥ ì™„ë£Œ");
      }
      function showToast(m) {
        const t = document.getElementById("toast");
        t.textContent = m;
        t.style.opacity = 1;
        setTimeout(() => (t.style.opacity = 0), 2000);
      }
    </script>
  </body>
</html>
