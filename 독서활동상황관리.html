<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ë…ì„œí™œë™ìƒí™©ê´€ë¦¬</title>
    <style>
      /* ê³µí†µ ìŠ¤íƒ€ì¼ */
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
        background: #f5f6f8;
      }
      .topbar {
        height: 48px;
        background: #f5c6cf;
        display: flex;
        align-items: center;
        padding: 0 16px;
        font-weight: 700;
        color: #374151;
      }
      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        height: calc(100vh - 48px);
      }
      .left,
      .right {
        padding: 16px;
        background: #fff;
        overflow: auto;
      }
      .left {
        border-right: 1px solid #e5e7eb;
      }

      /* ì¢Œì¸¡ ì…ë ¥ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
      .card {
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        background: #fafafa;
        padding: 14px 16px 16px;
        margin-bottom: 16px;
        position: relative;
      }
      .card-title {
        font-weight: 700;
        margin-bottom: 10px;
        font-size: 15px;
      }
      .field {
        margin-bottom: 12px;
      }
      .label {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
        display: block;
      }
      .input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 13px;
        background: #fff;
      }
      .btn-row {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 16px;
        padding-top: 8px;
        border-top: 1px solid #eee;
      }
      .btn {
        border-radius: 8px;
        border: 1px solid #d0d7e2;
        background: #f1f5f9;
        padding: 7px 12px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn.primary {
        background: #1f4ddc;
        border-color: #163aa5;
        color: #fff;
      }
      .btn.danger {
        background: #ff7f7f;
        border-color: #d84315;
        color: #fff;
      }
      .btn.add {
        width: 100%;
        margin-top: 12px;
        background: #e0e7ff;
        border-color: #c7d2fe;
        color: #1e3a8a;
      }

      /* ìë™ ì™„ì„± ê¸°ëŠ¥ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
      .autocomplete-wrapper {
        position: relative;
      }
      .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 10;
        background: #fff;
        border: 1px solid #d1d5db;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .autocomplete-item {
        padding: 8px 10px;
        font-size: 13px;
        cursor: pointer;
      }
      .autocomplete-item:hover,
      .autocomplete-item.selected {
        background: #f0f6ff;
        color: #1f4ddc;
      }

      /* ì¹´ë“œ ë‚´ë¶€ í•™ìƒ ì„ íƒ ì˜ì—­ ìŠ¤íƒ€ì¼ */
      .student-selector-area {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #eee;
        margin-bottom: 12px;
      }
      .student-selector-area .label {
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 700;
      }
      .student-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
      }
      .student-select-btn {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        background: #f9f9f9;
        font-size: 13px;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.1s ease;
      }
      .student-select-btn.active {
        background: #1f4ddc;
        color: #fff;
        border-color: #1f4ddc;
        font-weight: 600;
        transform: translateY(-1px);
      }
      .selection-controls {
        display: flex;
        gap: 6px;
        margin-bottom: 8px;
      }
      .selection-controls .btn {
        padding: 4px 8px;
        font-size: 12px;
        background: #e5e7eb;
      }
      .selection-status {
        font-size: 13px;
        color: #6b7280;
      }

      /* ìš°ì¸¡ ì˜ì—­ (í•™ìƒ ë¦¬ìŠ¤íŠ¸) ìŠ¤íƒ€ì¼ */
      .right-header {
        display: flex;
        justify-content: space-between; /* Title on left, buttons on right */
        align-items: center;
        margin-bottom: 16px;
      }
      .right-title {
        font-weight: 700;
        font-size: 16px;
        flex-shrink: 1;
        margin-right: 8px;
      }
      .right-buttons {
        display: flex;
        gap: 8px;
      }

      .student-record-block {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 12px;
        background: #fff;
        transition: all 0.15s ease;
      }
      .student-record-block.delete-mode-active {
        cursor: pointer;
        border-color: #ff7f7f; /* ì‚­ì œ ëª¨ë“œì¼ ë•Œ ë¶‰ì€ í…Œë‘ë¦¬ */
        box-shadow: 0 0 5px rgba(255, 127, 127, 0.5);
      }
      .student-record-block.delete-mode-active:hover {
        background: #ffe6e6;
      }

      /* ì´ë¦„ê³¼ ê¸€ììˆ˜ ì •ë ¬ì„ ìœ„í•œ Flex container */
      .record-name-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }
      .record-name {
        font-weight: 700;
        color: #1f4ddc;
        font-size: 14px;
      }
      .char-count {
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
        flex-shrink: 0;
      }

      .record-content {
        font-size: 13px;
        color: #333;
        line-height: 1.4;
        white-space: pre-wrap;
        word-break: break-all;
        min-height: 18px;
      }
      .no-record {
        color: #9ca3af;
        font-style: italic;
      }

      /* ì¦ë¹™ìë£Œ ëª©ë¡ ìŠ¤íƒ€ì¼ */
      .doc-list-container {
        margin-top: 10px;
        border-top: 1px solid #eee;
        padding-top: 10px;
        font-size: 13px;
      }
      .doc-list-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 5px;
      }
      .doc-list-header span {
        font-weight: 600;
        color: #6b7280;
      }
      .doc-list {
        padding-left: 0;
        list-style: none;
        margin: 0;
      }
      .doc-item {
        color: #1f4ddc;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        padding: 2px 0;
      }
      .no-doc-item {
        color: #9ca3af;
        font-style: italic;
        font-weight: normal;
      }

      .toast {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 24px;
        background: #111827;
        color: #fff;
        font-size: 13px;
        padding: 8px 12px;
        border-radius: 8px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }
      .toast.show {
        opacity: 0.95;
      }
    </style>
  </head>

  <body>
    <div class="topbar">ë…ì„œí™œë™ìƒí™©ê´€ë¦¬</div>

    <div class="container">
      <section class="left">
        <div id="bookList"></div>

        <button class="btn add" id="btnAddBook">+ ì±… ì¶”ê°€</button>
      </section>

      <section class="right">
        <div class="right-header">
          <div class="right-title">í•™ê¸‰ í•™ìƒë³„ ë…ì„œ ê¸°ë¡ í˜„í™©</div>
          <div class="right-buttons">
            <button type="button" class="btn danger" id="btnDeleteMode">
              ê¸°ë¡ ì‚­ì œ ëª¨ë“œ
            </button>
            <button type="button" class="btn primary" id="btnCopy">
              NEISì— ê¸°ì¬
            </button>
          </div>
        </div>

        <div id="studentRecordsList"></div>
      </section>
    </div>

    <div id="toast" class="toast"></div>

    <script>
      const bookList = document.getElementById("bookList");
      const MAX_LEN = 1500;

      // ë”ë¯¸ í•™ìƒ ëª©ë¡
      const STUDENT_LIST = [
        { id: "s1", name: "ê¹€íƒœì—°" },
        { id: "s2", name: "ë°•ì§€ì„±" },
        { id: "s3", name: "ìµœë¯¼í˜¸" },
        { id: "s4", name: "ì •ì†Œë¯¼" },
        { id: "s5", name: "ì´í•˜ì€" },
      ];

      // ë”ë¯¸ ë„ì„œ ê²€ìƒ‰ ê²°ê³¼
      const DUMMY_BOOKS = [
        { title: "ì½”ìŠ¤ëª¨ìŠ¤", author: "ì¹¼ ì„¸ì´ê±´" },
        { title: "ì‚¬í”¼ì—”ìŠ¤", author: "ìœ ë°œ í•˜ë¼ë¦¬" },
        { title: "ë°ë¯¸ì•ˆ", author: "í—¤ë¥´ë§Œ í—¤ì„¸" },
        { title: "ì´, ê· , ì‡ ", author: "ì¬ë ˆë“œ ë‹¤ì´ì•„ëª¬ë“œ" },
        { title: "ì´ê¸°ì  ìœ ì „ì", author: "ë¦¬ì²˜ë“œ ë„í‚¨ìŠ¤" },
        { title: "ë¯¸ì›€ë°›ì„ ìš©ê¸°", author: "ê¸°ì‹œë¯¸ ì´ì¹˜ë¡œ" },
        { title: "íŒ©íŠ¸í’€ë‹ˆìŠ¤", author: "í•œìŠ¤ ë¡œìŠ¬ë§" },
        { title: "ì–´ë¦° ì™•ì", author: "ì•™íˆ¬ì•ˆ ë“œ ìƒí…ì¥í˜ë¦¬" },
        { title: "ëˆìœ¼ë¡œ ì‚´ ìˆ˜ ì—†ëŠ” ê²ƒë“¤", author: "ë§ˆì´í´ ìƒŒë¸" },
        { title: "ì¹¨ë¬µì˜ ë´„", author: "ë ˆì´ì²¼ ì¹´ìŠ¨" },
        { title: "ë…¸ì¸ê³¼ ë°”ë‹¤", author: "ì–´ë‹ˆìŠ¤íŠ¸ í—¤ë°ì›¨ì´" },
        { title: "í˜¸ëª¨ ë°ìš°ìŠ¤", author: "ìœ ë°œ í•˜ë¼ë¦¬" },
        { title: "ì‹œê°„ì€ íë¥´ì§€ ì•ŠëŠ”ë‹¤", author: "ì¹´ë¥¼ë¡œ ë¡œë²¨ë¦¬" },
        { title: "íŒŒê³¼", author: "êµ¬ë³‘ëª¨" },
        { title: "82ë…„ìƒ ê¹€ì§€ì˜", author: "ì¡°ë‚¨ì£¼" },
        { title: "ì—­ì‚¬ì˜ ì“¸ëª¨", author: "ìµœíƒœì„±" },
        { title: "ì›ì”½", author: "ê²Œë¦¬ ì¼ˆëŸ¬" },
      ];

      let studentRecords = new Map();
      let studentDocuments = new Map(); // [ìˆ˜ì •] ì¦ë¹™ìë£Œ íŒŒì¼ëª… ë°°ì—´ì„ ì €ì¥í•  Map
      STUDENT_LIST.forEach((s) => {
        studentRecords.set(s.id, "");
        studentDocuments.set(s.id, []); // [ìˆ˜ì •] ì¦ë¹™ìë£Œ ì´ˆê¸°ê°’ì„ ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •
      });
      let isDeleteMode = false;
      let cardIdCounter = 0;

      // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
      function showToast(msg) {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 1500);
      }

      // [ìˆ˜ì •] ì¦ë¹™ìë£Œ ì—…ë¡œë“œ ì²˜ë¦¬ í•¨ìˆ˜ (ë‹¤ì¤‘ íŒŒì¼ ì²˜ë¦¬)
      function handleDocumentUpload(event) {
        const fileInput = event.target;
        const studentId = fileInput.dataset.studentId;
        const student = STUDENT_LIST.find((s) => s.id === studentId);

        if (fileInput.files.length > 0) {
          // ìƒˆë¡œ ì—…ë¡œë“œëœ íŒŒì¼ ì´ë¦„ì„ ë°°ì—´ë¡œ ë§Œë“¦
          const newFileNames = Array.from(fileInput.files).map(
            (file) => file.name
          );

          // ê¸°ì¡´ ëª©ë¡ì„ ë®ì–´ì“°ê±°ë‚˜, ì¶”ê°€í•˜ëŠ” ë°©ì‹ ì„ íƒ (ì—¬ê¸°ì„œëŠ” **ë®ì–´ì“°ê¸°**ë¡œ êµ¬í˜„)
          // ì—¬ëŸ¬ ë²ˆ ì—…ë¡œë“œí•  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ íŒŒì¼ë“¤ë¡œ ëŒ€ì²´ë¨
          studentDocuments.set(studentId, newFileNames);

          showToast(
            `${student.name} í•™ìƒì—ê²Œ ì´ ${newFileNames.length}ê°œì˜ ì¦ë¹™ìë£Œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`
          );
        } else {
          // íŒŒì¼ ì„ íƒì„ ì·¨ì†Œí–ˆì„ ë•Œ ê¸°ì¡´ íŒŒì¼ëª…ì„ ìœ ì§€ (ë³€í™” ì—†ìŒ)
        }
        renderStudentRecords(); // íŒŒì¼ëª… ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ë¦¬ë Œë”ë§
        // íŒŒì¼ inputì˜ valueë¥¼ ì´ˆê¸°í™”í•˜ì—¬, ê°™ì€ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ë„ change ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ê²Œ í•¨
        fileInput.value = null;
      }

      // --- í•™ìƒ ì„ íƒ/ë Œë”ë§ (ìš°ì¸¡ íŒ¨ë„) ---

      function renderStudentRecords() {
        const listEl = document.getElementById("studentRecordsList");
        listEl.innerHTML = "";

        STUDENT_LIST.forEach((student, index) => {
          const wrap = document.createElement("div");
          wrap.className = "student-record-block";
          wrap.dataset.id = student.id;

          if (isDeleteMode) {
            wrap.classList.add("delete-mode-active");
          }

          const recordText = studentRecords.get(student.id).trim();
          const docList = studentDocuments.get(student.id); // [ìˆ˜ì •] ì¦ë¹™ìë£Œ íŒŒì¼ëª… ë°°ì—´ ê°€ì ¸ì˜¤ê¸°

          // ê¸€ì ìˆ˜ ê³„ì‚° (NEIS ê¸°ì¬/ë³µì‚¬ë  ìµœì¢… í…ìŠ¤íŠ¸ ê¸°ì¤€)
          const finalCopyText = recordText.replace(/[ã€ã€]/g, "");
          const totalLength = finalCopyText.length;

          let contentHtml;
          if (recordText) {
            // ã€ã€ ê´„í˜¸ë¥¼ ì œê±°í•˜ê³  ì‰¼í‘œ(,)ë¡œ ì—°ê²°ëœ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ
            let displayRecord = finalCopyText.trim();

            if (displayRecord.length > 500) {
              displayRecord = displayRecord.slice(0, 500) + "...";
            }

            contentHtml = `<div class="record-content">${displayRecord}</div>`;
          } else {
            contentHtml = `<div class="record-content no-record">ì…ë ¥ëœ ë…ì„œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
          }

          // [ìˆ˜ì •] ì¦ë¹™ìë£Œ ì—…ë¡œë“œ ë° í‘œì‹œë¥¼ ìœ„í•œ HTML êµ¬ì¡°
          const docListItems =
            docList.length > 0
              ? docList
                  .map((name) => `<li class="doc-item">ğŸ“ ${name}</li>`)
                  .join("")
              : `<li class="doc-item no-doc-item">ì—…ë¡œë“œëœ íŒŒì¼ ì—†ìŒ</li>`;

          const docControlHtml = `
              <div class="doc-list-container">
                  <div class="doc-list-header">
                      <span>ì¦ë¹™ìë£Œ (${docList.length}ê°œ):</span>
                      <input type="file" id="upload_${student.id}" style="display: none;" 
                             data-student-id="${student.id}"
                             multiple 
                             onchange="handleDocumentUpload(event)"
                      />
                      <button 
                          type="button" 
                          class="btn" 
                          style="padding: 4px 8px; font-size: 11px; background: #e0f7fa; color: #006064; border-color: #b2ebf2;"
                          onclick="document.getElementById('upload_${student.id}').click()"
                      >
                          ìƒˆ ìë£Œ ì—…ë¡œë“œ/ë®ì–´ì“°ê¸°
                      </button>
                  </div>
                  <ul class="doc-list">
                      ${docListItems}
                  </ul>
              </div>
          `;

          // ì´ë¦„ê³¼ ê¸€ì ìˆ˜ë¥¼ ê°™ì€ ë¼ì¸ì— ìš°ì¸¡ ì •ë ¬
          wrap.innerHTML = `
            <div class="record-name-row">
                <div class="record-name">${index + 1}. ì´ë¦„: ${
            student.name
          }</div>
                <div class="char-count">ì´ ${totalLength}ì / ${MAX_LEN}ì</div>
            </div>
            <div style="font-size: 13px; font-weight: 600; margin-bottom: 4px;">ì‘ì„± ë‚´ìš©:</div>
            ${contentHtml}
            ${docControlHtml} `;

          // [ìˆ˜ì •] í•™ìƒ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸: ì‚­ì œ ëª¨ë“œì¼ ë•Œë§Œ ê¸°ëŠ¥
          wrap.addEventListener("click", () => {
            if (isDeleteMode) {
              deleteStudentRecords(student.id, student.name);
            }
            // ì¼ë°˜ ëª¨ë“œì—ì„œëŠ” í´ë¦­í•´ë„ ì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•ŠìŒ
          });
          listEl.appendChild(wrap);
        });
      }

      // [ìˆ˜ì •] í•™ìƒ ê¸°ë¡ ì‚­ì œ ê¸°ëŠ¥ (ì¦ë¹™ìë£Œ ë°°ì—´ ì´ˆê¸°í™”)
      function deleteStudentRecords(studentId, studentName) {
        if (
          confirm(
            `${studentName} í•™ìƒì˜ ë…ì„œ ê¸°ë¡ê³¼ ì¦ë¹™ìë£Œë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
          )
        ) {
          studentRecords.set(studentId, "");
          studentDocuments.set(studentId, []); // [ìˆ˜ì •] ì¦ë¹™ìë£Œë¥¼ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
          showToast(
            `${studentName} í•™ìƒì˜ ë…ì„œ ê¸°ë¡ ë° ì¦ë¹™ìë£Œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`
          );
          renderStudentRecords();
        }
      }

      // --- ì¢Œì¸¡ íŒ¨ë„ ê¸°ëŠ¥: ì±… ì¹´ë“œ ë° ë¡œì»¬ í•™ìƒ ì„ íƒ ---

      function createStudentSelectorHTML(cardId) {
        let buttonsHTML = STUDENT_LIST.map(
          (student) => `
              <button 
                  type="button" 
                  class="student-select-btn" 
                  data-id="${student.id}"
                  data-name="${student.name}"
              >${student.name}</button>
          `
        ).join("");

        return `
              <div class="student-selector-area">
                  <div class="label">ğŸ“š ê¸°ë¡ì„ ì ìš©í•  í•™ìƒ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</div>
                  <div class="selection-controls">
                      <button type="button" class="btn" id="${cardId}_select_all">ì „ì²´ ì„ íƒ</button>
                      <button type="button" class="btn" id="${cardId}_clear_all">ì „ì²´ ì·¨ì†Œ</button>
                  </div>
                  <div class="student-buttons" id="${cardId}_student_buttons">
                      ${buttonsHTML}
                  </div>
                  <div class="selection-status" id="${cardId}_selection_status">ì„ íƒëœ í•™ìƒ: 0ëª…</div>
              </div>
          `;
      }

      function updateSelectionStatus(cardId) {
        const cardEl = document.getElementById(cardId);
        const activeButtons = cardEl.querySelectorAll(
          ".student-select-btn.active"
        );
        const statusEl = document.getElementById(`${cardId}_selection_status`);

        const names = Array.from(activeButtons).map((btn) => btn.dataset.name);

        if (names.length === 0) {
          statusEl.textContent = "ì„ íƒëœ í•™ìƒ: 0ëª…";
        } else if (names.length <= 3) {
          statusEl.textContent = `ì„ íƒëœ í•™ìƒ: ${names.join(", ")} (${
            names.length
          }ëª…)`;
        } else {
          // [ìˆ˜ì •] ë°°ì—´ ì¸ë±ìŠ¤ ì˜¤ë¥˜ ìˆ˜ì • ë° í‘œì‹œ ë°©ì‹ ê°œì„ 
          statusEl.textContent = `ì„ íƒëœ í•™ìƒ: ${names[0]}, ${names[1]} ì™¸ ${
            names.length - 2
          }ëª… (${names.length}ëª…)`;
        }
      }

      function createBookCard() {
        cardIdCounter++;
        const id = `book_${cardIdCounter}`;

        const card = document.createElement("div");
        card.className = "card";
        card.id = id;
        card.innerHTML = `
        <div class="card-title">ğŸ“– ë…ì„œ ê¸°ë¡ ${cardIdCounter}</div>
        
        <div class="field">
          <div class="label">ë„ì„œëª… (ê²€ìƒ‰í•˜ì—¬ ì„ íƒ)</div>
          <div class="autocomplete-wrapper">
            <input
              type="text"
              class="input book-title"
              id="${id}_search_title"
              placeholder="ì±… ì œëª©ì„ ì…ë ¥í•˜ë©´ ìë™ ì™„ì„±ë©ë‹ˆë‹¤. (ì˜ˆ: ì½”ìŠ¤ëª¨ìŠ¤)"
              autocomplete="off"
            />
            <div class="autocomplete-results" id="${id}_results" style="display: none;"></div>
          </div>
        </div>

        <div class="field" style="display: flex; gap: 8px;">
            <div style="flex: 1;">
              <div class="label">í™•ì •ëœ ì±… ì œëª©</div>
              <input
                type="text"
                class="input final-title"
                id="${id}_final_title"
                placeholder="ìë™ ì™„ì„± ë˜ëŠ” ì§ì ‘ ì…ë ¥"
              />
            </div>
            <div style="flex: 1;">
              <div class="label">í™•ì •ëœ ì €ì</div>
              <input
                type="text"
                class="input final-author"
                id="${id}_final_author"
                placeholder="ìë™ ì™„ì„± ë˜ëŠ” ì§ì ‘ ì…ë ¥"
              />
            </div>
        </div>

        ${createStudentSelectorHTML(id)}
        
        <div class="btn-row" style="justify-content: flex-end; border-top: none; padding-top: 0;">
            <button class="btn primary" id="${id}_apply">ì„ íƒ í•™ìƒì—ê²Œ ì ìš©</button>
            <button class="btn danger" id="${id}_delete">ì¹´ë“œ ì‚­ì œ</button>
        </div>
      `;

        // ì´ë²¤íŠ¸ ë“±ë¡
        setTimeout(() => {
          const cardEl = document.getElementById(id);
          const titleInput = document.getElementById(`${id}_search_title`);
          const resultsEl = document.getElementById(`${id}_results`);
          const studentButtonsEl = document.getElementById(
            `${id}_student_buttons`
          );
          const finalTitleInput = document.getElementById(`${id}_final_title`);
          const finalAuthorInput = document.getElementById(
            `${id}_final_author`
          );

          // 1. ìë™ ì™„ì„± ê¸°ëŠ¥
          let selectedIndex = -1;
          const updateAutocomplete = () => {
            const query = titleInput.value.toLowerCase().trim();
            resultsEl.innerHTML = "";

            if (query.length < 2) {
              resultsEl.style.display = "none";
              selectedIndex = -1;
              return;
            }

            const filtered = DUMMY_BOOKS.filter(
              (book) =>
                book.title.toLowerCase().includes(query) ||
                book.author.toLowerCase().includes(query)
            );

            if (filtered.length === 0) {
              resultsEl.style.display = "none";
              selectedIndex = -1;
              return;
            }

            filtered.forEach((book) => {
              const item = document.createElement("div");
              item.className = "autocomplete-item";
              item.textContent = `${book.title} (${book.author})`;
              item.dataset.title = book.title;
              item.dataset.author = book.author;

              item.addEventListener("click", () =>
                selectBook(book.title, book.author)
              );

              resultsEl.appendChild(item);
            });

            resultsEl.style.display = "block";
            selectedIndex = -1;
          };

          const selectBook = (title, author) => {
            titleInput.value = `${title} (${author})`;
            finalTitleInput.value = title;
            finalAuthorInput.value = author;
            resultsEl.style.display = "none";
            showToast(`'${title} (${author})'ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`);
          };

          titleInput.addEventListener("keydown", (e) => {
            const items = resultsEl.querySelectorAll(".autocomplete-item");
            if (items.length === 0) return;

            if (e.key === "ArrowDown") {
              e.preventDefault();
              selectedIndex = (selectedIndex + 1) % items.length;
            } else if (e.key === "ArrowUp") {
              e.preventDefault();
              selectedIndex = (selectedIndex - 1 + items.length) % items.length;
            } else if (e.key === "Enter") {
              e.preventDefault();
              if (selectedIndex !== -1) {
                const selectedItem = items[selectedIndex];
                selectBook(
                  selectedItem.dataset.title,
                  selectedItem.dataset.author
                );
              }
              return;
            }

            items.forEach((item, index) => {
              item.classList.toggle("selected", index === selectedIndex);
            });
            if (selectedIndex !== -1) {
              items[selectedIndex].scrollIntoView({ block: "nearest" });
            }
          });
          titleInput.addEventListener("input", updateAutocomplete);
          titleInput.addEventListener("blur", () => {
            setTimeout(() => {
              resultsEl.style.display = "none";
            }, 200);
          });

          // 2. í•™ìƒ ì„ íƒ/ì „ì²´ ì„ íƒ/ì·¨ì†Œ ê¸°ëŠ¥
          studentButtonsEl.addEventListener("click", (e) => {
            if (e.target.classList.contains("student-select-btn")) {
              e.target.classList.toggle("active");
              updateSelectionStatus(id);
            }
          });

          document
            .getElementById(`${id}_select_all`)
            .addEventListener("click", () => {
              cardEl
                .querySelectorAll(".student-select-btn")
                .forEach((btn) => btn.classList.add("active"));
              updateSelectionStatus(id);
              showToast("ëª¨ë“  í•™ìƒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.");
            });

          document
            .getElementById(`${id}_clear_all`)
            .addEventListener("click", () => {
              cardEl
                .querySelectorAll(".student-select-btn")
                .forEach((btn) => btn.classList.remove("active"));
              updateSelectionStatus(id);
              showToast("ëª¨ë“  í•™ìƒ ì„ íƒì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            });

          // 3. ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
          document
            .getElementById(`${id}_apply`)
            .addEventListener("click", () => applyBookRecord(id));
          document
            .getElementById(`${id}_delete`)
            .addEventListener("click", () => {
              card.remove();
              showToast(`ë…ì„œ ê¸°ë¡ ${cardIdCounter} ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            });

          // ì´ˆê¸° ìƒíƒœ ì—…ë°ì´íŠ¸
          updateSelectionStatus(id);
        }, 10);

        return card;
      }

      function applyBookRecord(cardId) {
        const cardEl = document.getElementById(cardId);
        const finalTitleInput = cardEl.querySelector(".final-title");
        const finalAuthorInput = cardEl.querySelector(".final-author");

        const finalTitle = finalTitleInput.value.trim();
        const finalAuthor = finalAuthorInput.value.trim();

        const selectedStudentButtons = cardEl.querySelectorAll(
          ".student-select-btn.active"
        );

        if (!finalTitle || !finalAuthor) {
          showToast("í™•ì •ëœ ì±… ì œëª©ê³¼ ì €ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
          return;
        }

        if (selectedStudentButtons.length === 0) {
          showToast("ì ìš©í•  í•™ìƒì„ 1ëª… ì´ìƒ ì„ íƒí•´ ì£¼ì„¸ìš”.");
          return;
        }

        // ì±… ì œëª©ì— ìˆëŠ” ê´„í˜¸ ì œê±°
        let cleanTitle = finalTitle.replace(/[()]/g, "").trim();

        // ì €ì¥ í˜•ì‹: ã€Clean Titleã€(Author)
        const finalRecord = `ã€${cleanTitle}ã€(${finalAuthor})`;

        const selectedStudentIds = Array.from(selectedStudentButtons).map(
          (btn) => btn.dataset.id
        );
        let appliedCount = 0;

        selectedStudentIds.forEach((studentId) => {
          let currentText = studentRecords.get(studentId).trim();

          // ì¤‘ë³µ í™•ì¸
          if (currentText.includes(finalRecord)) {
            return;
          }

          // êµ¬ë¶„ìë¥¼ ì‰¼í‘œì™€ ê³µë°±(', ')ìœ¼ë¡œ ì‚¬ìš©
          let merged = currentText
            ? currentText + ", " + finalRecord
            : finalRecord;

          // ê¸€ì ìˆ˜ ì œí•œ ì²´í¬
          if (merged.length > MAX_LEN) {
            merged = merged.slice(0, MAX_LEN);
          }

          studentRecords.set(studentId, merged);
          appliedCount++;
        });

        // ìš°ì¸¡ íŒ¨ë„(í•™ìƒ ëª©ë¡) ì—…ë°ì´íŠ¸
        renderStudentRecords();

        if (appliedCount > 0) {
          showToast(
            `ì„ íƒëœ ${appliedCount}ëª… í•™ìƒì˜ ê¸°ë¡ì— '${finalTitle}'ì´(ê°€) ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`
          );
        } else {
          showToast(
            "ì„ íƒëœ ëª¨ë“  í•™ìƒì—ê²Œ í•´ë‹¹ ë…ì„œ ê¸°ë¡ì´ ì´ë¯¸ ì ìš©ë˜ì–´ ìˆì—ˆìŠµë‹ˆë‹¤."
          );
        }
      }

      // --- ìš°ì¸¡ ìƒë‹¨ ë²„íŠ¼ ê¸°ëŠ¥ ---

      // [ìˆ˜ì •] ê¸°ë¡ ì‚­ì œ ëª¨ë“œ í† ê¸€ ê¸°ëŠ¥
      document.getElementById("btnDeleteMode").addEventListener("click", () => {
        isDeleteMode = !isDeleteMode;
        const btn = document.getElementById("btnDeleteMode");

        if (isDeleteMode) {
          btn.textContent = "âœ… ì‚­ì œ ëª¨ë“œ í™œì„±í™” (í´ë¦­í•˜ì—¬ ê¸°ë¡ ì‚­ì œ)";
          btn.classList.remove("danger");
          btn.style.backgroundColor = "#d1e7dd";
          btn.style.borderColor = "#badbcc";
          btn.style.color = "#0a3622";
          showToast(
            "ê¸°ë¡ ì‚­ì œ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í•™ìƒ ê¸°ë¡ì„ í´ë¦­í•˜ì—¬ ì‚­ì œí•˜ì„¸ìš”."
          );
        } else {
          btn.textContent = "ê¸°ë¡ ì‚­ì œ ëª¨ë“œ";
          btn.classList.add("danger");
          btn.style.backgroundColor = "";
          btn.style.borderColor = "";
          btn.style.color = "";
          showToast("ê¸°ë¡ ì‚­ì œ ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        renderStudentRecords(); // ì‚­ì œ ëª¨ë“œ ìƒíƒœë¥¼ ë°˜ì˜í•˜ì—¬ ë¦¬ë Œë”ë§
      });

      document.getElementById("btnCopy").addEventListener("click", () => {
        if (isDeleteMode) {
          showToast(
            "í˜„ì¬ ê¸°ë¡ ì‚­ì œ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ëª¨ë“œë¥¼ ë¹„í™œì„±í™”í•´ì£¼ì„¸ìš”."
          );
          return;
        }

        const studentsWithRecord = STUDENT_LIST.filter((s) => {
          const text = studentRecords.get(s.id);
          return text && text.trim().length > 0;
        });

        if (studentsWithRecord.length === 0) {
          showToast("ë…ì„œ ê¸°ë¡ì´ ì…ë ¥ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // ëª¨ë“  ê¸°ë¡ëœ í•™ìƒì˜ ë‚´ìš©ì„ ìˆœì°¨ì ìœ¼ë¡œ ë³µì‚¬ ë° ì•Œë¦¼
        let totalCopyText = "";
        const studentNames = [];

        studentsWithRecord.forEach((student) => {
          const text = studentRecords.get(student.id).trim();
          // ë³µì‚¬ ì‹œ ã€ã€ ê´„í˜¸ ì œê±°
          const finalCopyText = text.replace(/[ã€ã€]/g, "");

          // NEIS ê¸°ì¬ëŠ” í•™ìƒë³„ë¡œ ë³µì‚¬-ë¶™ì—¬ë„£ê¸°ë¥¼ ë°˜ë³µí•˜ëŠ” í–‰ìœ„ì´ë¯€ë¡œ,
          // ì—¬ê¸°ì„œëŠ” ì²« ë²ˆì§¸ í•™ìƒì˜ ê¸°ë¡ë§Œ í´ë¦½ë³´ë“œì— ë³µì‚¬í•˜ê³ 
          // ì‚¬ìš©ìì—ê²Œ ìˆœì°¨ì ìœ¼ë¡œ ì§„í–‰ë¨ì„ ì•Œë¦¬ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•©ë‹ˆë‹¤.
          if (studentNames.length === 0) {
            totalCopyText = finalCopyText; // ì²« í•™ìƒì˜ ê¸°ë¡ë§Œ í´ë¦½ë³´ë“œì— ì €ì¥
          }

          studentNames.push(student.name);
        });

        if (totalCopyText) {
          navigator.clipboard.writeText(totalCopyText);
        }

        // Alert ë©”ì‹œì§€ ë³€ê²½: ê¸°ë¡ì´ ìˆëŠ” í•™ìƒ ì „ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•¨ì„ ì•Œë¦¼
        alert(
          `ì´ ${
            studentsWithRecord.length
          }ëª… í•™ìƒì˜ ë…ì„œ ê¸°ë¡ ê¸°ì¬ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.\n\n[ì™„ë£Œëœ í•™ìƒ]: ${studentNames.join(
            ", "
          )}\n\n(ì²« ë²ˆì§¸ í•™ìƒ [${
            studentNames[0]
          }]ì˜ ê¸°ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. NEISì— ë¶™ì—¬ë„£ê¸° í›„ ë‹¤ìŒ í•™ìƒìœ¼ë¡œ ì§„í–‰í•˜ì„¸ìš”.)`
        );
      });

      // --- ì´ˆê¸°í™” ---

      document.getElementById("btnAddBook").addEventListener("click", () => {
        bookList.appendChild(createBookCard());
        showToast(`ë…ì„œ ê¸°ë¡ ${cardIdCounter} ì¹´ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      });

      window.onload = () => {
        // ìš°ì¸¡ í•™ìƒ ëª©ë¡ ë Œë”ë§
        renderStudentRecords();
        // ì¢Œì¸¡ ì²« ì¹´ë“œ ìƒì„±
        bookList.appendChild(createBookCard());
      };
    </script>
  </body>
</html>
